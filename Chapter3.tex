\chapter{Behavioural Distance of Nondeterministic Processes}
\label{chapter3}

In this chapter, we investigate axiomatisations of behavioural distance for a {\em nondeterministic} model of computation, known as \emph{charts}~\cite{Milner:1984:Complete}. Originally introduced by Milner, charts extend \emph{finite-state nondeterministic automata} (NFA) by replacing the notion of acceptance with variable outputs. Intuitively, the distance between two charts can be quantified by, roughly, the number of steps after which their behaviours disagree. This seemingly small generalisation from deterministic finite automata provides a range of challenges, stemming from the fact that the presence of non-determinism moves the semantics from language to bisimilarity, while at the same time representing a crucial step towards weighted transition systems~\cite{Larsen:2011:Metrics}, where the general theory of behavioral distances and axiomatisations thereof is relatively underexplored. 

%Despite their relative simplicity, behavioural distance of charts remained uncharted territory.

The central contribution of this chapter is an inference system for reasoning about behavioural distances of behaviours of Milner's charts. We demonstrate its \emph{soundness}~(\Cref{c3:thm:soundness}) and \emph{completeness}~(\Cref{thm:completeness}). On the way, we gather several contributions of independent interest. First, we instantiate the abstract framework of behavioural distances in the concrete case of charts. We organise such behaviours as a symmetric monoidal category, in which they may be composed \emph{sequentially} and \emph{in parallel}. We do so relying on rich structures associated with charts, such as Conway theories~\cite{Bloom:1993:Iteration,Esik:1999:Group}. Second, as one of the steps in the soundness argument, we give a concrete characterisation of behavioural distance between charts via Hennessy and Milner's stratification of bisimilarity~\cite{hennessy:1985:algebraic}. Finally, similarly to \Cref{chapter2}, the completeness argument makes use of tools from fixpoint theory and Banach spaces to simplify the calculation of behavioural distance to the point it can be mimicked via syntactic manipulation.

%\noindent
%\textbf{Diagrammatic calculi. } 
%On the syntax side, \emph{monoidal} equational theories extend classical universal algebra in a different direction.  Instead of relying on traditional variables and terms, these theories use \emph{string diagrams}. 
The syntax and equations of our complete axiomatic theory are given in terms of \emph{string diagrams}, the two-dimensional language of monoidal categories~\cite{Selinger_2010,piedeleu2023introduction}. The pictorial representation of string diagrams provides an intuitive understanding of how information flows and is exchanged between components within a system. For this reason, they have been increasingly popular as a formal language for computations and processes in areas such as quantum theory~\cite{Coecke:2008:Interacting}, concurrency~\cite{Bonchi:2019:Diagrammatic}, probabilistic programming~\cite{Piedeleu:2024:Complete}, and digital circuits~\cite{Ghica:2022:Full}.  
%Importantly, the diagrammatic syntax explicitly models the copying and discarding of resources (such as variables), making it particularly well-suited for capturing resource-sensitive processes in areas like quantum theory~\cite{Coecke:2008:Interacting}, concurrency~\cite{Bonchi:2019:Diagrammatic}, probabilistic programming~\cite{Piedeleu:2024:Complete}, and digital circuits~\cite{Ghica:2022:Full}. %From an abstract perspective, this explicit handling of resources is formalised by the fact that the algebra of string diagrams operates within a (symmetric) monoidal category, rather than a Cartesian one.
\begin{figure}
\begin{align*}
{
\small
\tikzfig{ex-intro}
}
\end{align*}
\caption{Two charts at distance $\frac{1}{4}$ and their corresponding representations as string diagrams}
\label{fig:intro}	
\end{figure}
%\noindent
%\textbf{Methodology.} 
There are several reasons to favour string diagrams as our syntax of choice. 
First, they closely resemble the usual graphical representation of the transition structure of charts, while constituting a formal syntax that supports inductive reasoning and to which we can assign semantics formally.
Moreover, as Milner observed~\cite{Milner:1984:Complete}, the standard algebraic syntax of regular expressions is not expressive enough to capture all chart behaviour~\cite{Grabmayer:2022:Milner}. His solution introduced a more complex syntax with binders and names,  later studied in the process algebra community for various models, including probabilistic~\cite{Stark:2000:Complete} and quantitative~\cite{Jensen:2020:Complete} ones. In contrast, string diagrams offer a variable-free approach, eliminating the need to define substitution and recursion as a primitive operation (the latter is decomposed into simpler components). 
Finally, using string diagrams aligns our work with a broader research programme aimed at axiomatising various notions of equivalence in automata theory through a unified diagrammatic syntax~\cite{piedeleu2023finite,antoinecsl2025}. 

%Our axiomatization is also an example of a quantitative equational theory for string diagrams, building on recent theoretical developments~\cite{Lobbia:2024:Quantitative}, which generalise algebraic (\emph{i.e.} Cartesian) quantitative equational theories to the monoidal setting of string diagrams. While quantitative theories for term algebras have been studied extensively~\cite{Mardare:2016:Quantitative,Mio:2024:Universal,Rosicky2023,MiliusU19}, quantitative theories for string diagrams remain mostly unexplored.

%Whereas quantitative theories for term algebras have been studied extensively~\cite{Mardare:2016:Quantitative,Mio:2024:Universal,Rosicky2023,MiliusU19}, quantitative theories for string diagrams (which require working in a monoidal rather than cartesian category) have received far less attention,~\cite{Lobbia:2024:Quantitative} being a first systematic attempt at developing such framework. The axiomatic theory we develop in this paper is not quite BLABLA, but we plan to BLABLA


The rest of the chapter is organised is as follows.

In \Cref{c3:sec:preliminaries}, we introduce charts, as well as their associated notions of behavioural equivalence and distances. Then, in \Cref{c3:sec:monoidal}, we introduce the syntax of our diagrammatic calculus, for which we construct the semantics in \Cref{sec:semantics}. Next, in \Cref{sec:axioms} we present a (quantitative) equational inference system for reasoning about distances of the denotations of the terms of our calculus; we also prove its soundness and study one example in more detail. \Cref{sec:completeness} contains the main technical result of the chapter, namely completeness for the proposed behavioural distance between charts. We wrap up in \Cref{sec:discussion} where we review related literature, and sketch directions for future work.  

\section{Preliminaries}\label{c3:sec:preliminaries}
In this section, we provide the main technical preliminaries for the development of this chapter.
\subsection{Charts}
Fix a set $V=\{v_1, v_2, \dots\}$ of \emph{variables} and $\Sigma$ of \emph{letters} respectively. A prechart is a triple $(Q,E,D)$, where $Q$ is a set of states, $D \subseteq Q \times \Sigma \times Q$ a finite labelled transition relation and $E \subseteq Q \times V$ is a finite output relation. Precharts can be thought as a branching-time generalisation of nondeterministic automata, where instead of acceptance, we deal with the notion of outputs. Moreover, when $D$ and $E$ are clear from the context, we will write $q \tr{a} q' \iff (q,a,q') \in D$ and $q \rhd v \iff (q,v) \in E$. A chart $C$ is a quadruple $(Q, s, D, E)$, where $(Q,D,E)$ is a prechart and $s \in Q$ is a distinguished start node. We call a chart finite if $Q$ is finite.
\begin{remark}\label{c3:rem:kripke}
	Charts are closely related to other well-known transition system models in theoretical computer science. On one hand, they can be viewed as a slight variation of image-finite labelled transition systems (LTS), differing primarily in their use of explicit outputs besides just a labelled transition relation. This connection proves particularly useful when applying Henessy and Milnerâ€™s stratification of bisimilarity, later in this chapter. xOn the other hand, charts can also be seen as a variation of Kripke frames, where outputs serve as propositional atoms, but the standard accessibility relation between worlds is generalised to a labelled transition relation. While we do not explicitly pursue this perspective, we will hint at the connections between the results presented in this chapter and the field of modal logic.
\end{remark}
\begin{definition}[Strong Bisimulation]
	Let $C_i = (Q_i,D_i,E_i)$, $i \in \{1,2\}$ be precharts. A bisimulation between $C_1$ and $C_2$ is a relation ${R} \subseteq Q_1 \times Q_2$, such that \circlednum{1} if $(q_1,q_2)\in R$, then $E(q_1)=E(q_2)$, \circlednum{2} if $(q_1,q_2) \in R$ and $q_1 \tr{a} q'_1$, then there exists $q'_2 \in Q_2$, such that $q_2 \tr{a} q'_2$ and $(q'_1, q'_2) \in R$ and symmetrically. If $C_1$ and $C_2$ are charts, we say that they are bisimilar (denoted $C_1 \sim C_2$) if there exists a bisimulation between their underlying precharts that relates their start nodes.
\end{definition}
Using the above definition, we can also define the following:
\begin{definition}[Prechart homomorphism]
	 Let $C_i = (Q_i,D_i,E_i)$, $i \in \{1,2\}$ be precharts. We call a function $f \colon Q_1 \to Q_2$ a prechart homomorphism if the graph of $f$, given by $G(f) = \{(q,f(q)) \mid q \in Q_1\}$ is a bisimulation between $C_1$ and $C_2$.
\end{definition}
In other words, prechart homomorphisms preserve and reflect transitions. Given a chart $C=(Q,s,D,E)$ we say that a variable $v \in V$ is \emph{live} in $C$ if there exists a path of transitions $s \tr{a_1} \dots \tr{a_n} s' \rhd v$ or call it \emph{dead} otherwise. It can be easily observed that bisimulations and homomorphisms preserve the liveness of variables. Such a conclusion can be also obtained from the perspective of modal logic, where bisimulations of Kripke frames preserve the truth of modal propositions~\cite[Chapter~2]{Blackburn:2001:Modal}.

Later in this chapter, we will characterise the behavioural distance of precharts via Hennessy and Milner's \emph{stratification of bisimilarity}~\cite{hennessy:1985:algebraic} defined by the following:
	\begin{definition}[Stratification of bisimilarity]
	Let $C_i = (Q_i, D_i, E_i)$ for $i \in \{1,2\}$ be precharts. We can define a family $\{\sim^{(i)} \}_{i \in \N}$ of equivalence relations on $Q_1 \times Q_2$ given by the following. For all $(q_1,q_2) \in Q_1 \times Q_2$, we have that $q_1 \sim^{(0)} q_2$. Given $(q_1, q_2) \in Q_1 \times Q_2$, we have that $q_1 \sim ^{(n+1)} q_2$ if \circlednum{1} $E_1(q_1) = E_2(q_2)$, \circlednum{2} $q_1 \tr{a}_{C_1} q'_1$ implies that there exists $q'_2 \in Q_2$, such that $q_2 \tr{a} q'_2$ and $q'_1 \sim^{(n)} q'_2$.
\end{definition}

For precharts, which by definition are image-finite, we have the following relationship between bisimilarity and its stratification~\cite{hennessy:1985:algebraic}:
\begin{equation}\label{eqn:stratification}
	x \sim y \iff \forall k \in \N \ldotp~x\sim^{(k)} y
\end{equation}

Given a prechart $(Q, E, D)$, we can equivalently see it as a pair $(Q, \beta)$, where $\beta$ is a combined transition function $Q \to \powf (\Sigma \times Q + V)$, where $\powf$ denotes a finite powerset. Such transition function $\beta$ takes each state $q \in Q$, to the set $\beta(q) = D(q) \cup E(q)$ of possible successors, that include labelled transitions and variable outputs.

In other words, precharts are coalgebras for the functor $\funL \colon \Set \to \Set$, given by $\funL = \powf (\Sigma \times (-) + V)$. Bisimulations and homomorphisms of $\funL$-coalgebras are captured concretely by strong bisimulation of precharts and their homomorphisms. Because of this, we will interchangeably use terms prechart and $\funL$-coalgebra. Moreover, $\funL$ preserves weak pullbacks and hence $\sim$ is an equivalence relation that captures behavioural equivalence of $\funL$-coalgebras. For more details of coalgebraic treatment of precharts, we direct an interested reader to~\cite{Schmid:2021:Star}.
\subsection{Algebra of regular behaviours}
To define charts, Milner proposed a specification language called an \emph{algebra of regular behaviours} (ARB). The syntax of ARB is given by the following:
$$e,f \in \Expr ::= 0 \mid v \in V \mid a.e \mid e + f \mid \mu v. e \qquad\qquad\qquad (a \in \Sigma)$$
where $V=\{v_1, v_2, \dots\}$ and $\Sigma$ are sets of \emph{variables} and \emph{letters} respectively. Given an expression $f$ containing a variable $v$, we say that $v$ is \emph{free} in $f$, if it appears outside of the scope of the $\mu v.e$ operator or say that it is \emph{bound} otherwise. Given an expression $e \in \Expr$, we write $\fv(e) \subseteq V$ for the set of its free variables. 
\begin{definition}[{\cite{Milner:1984:Complete}}]\label{def:subset}
	Given vectors $\vec{v}$ of binders and $\vec{e}$ of expressions of the same size, we define a syntactic substitution operator $[\vec{e}/\vec{v}] \colon \Expr \to \Expr$ by the following:
	\begin{align*}
		v[\vec{e}/\vec{v}] &= \begin{cases}
			\vec{e}_i & \text{if }v=\vec{v}_i\\
			v & \text{otherwise}
		\end{cases}\\
		(a.e)[\vec{e}/\vec{v}] &= a.(e[\vec{e}/\vec{v}])\\
		(e + f)[\vec{e}/\vec{v}] &= e[\vec{e}/\vec{v}] + f[\vec{e}/\vec{v}]\\
		(\mu w.e)[\vec{e}/\vec{v}] &= \begin{cases}
			\mu w. (e[\vec{e}/\vec{v}]) & \text{if } w \text{ is not in } \vec{v} \text{ nor free in } \vec{e}\\
			\mu z. (e[z/w][\vec{e}/\vec{v}]) & \text{otherwise for some } z \text{ not in } \vec{v} \text{ nor free in } \vec{e}\\
		\end{cases}
	\end{align*}
\end{definition}
We can now define operational semantics of ARB, by equipping its syntax with a prechart structure.
\begin{definition}[{\cite{Milner:1984:Complete}}]\label{def:operational_semantics}
	Let $(\Expr, \partial)$ be a prechart whose transition function (called \emph{derivative}) is a least one satisfying the following inference rules
	\begin{gather*}
		\inferrule{e \tr{a} e' }{a.e \tr{a} e'} \qquad \inferrule{ }{v \rhd v} \qquad \inferrule{e \tr{a} e'}{e + f \tr{a} e'} \qquad \inferrule{f \tr{a} f'}{e + f \tr{a} f'}\\
		\inferrule {e \rhd v}{e + f \rhd v} \qquad \inferrule {f \rhd v}{e + f \rhd v} \qquad \inferrule{e \rhd v\quad v \neq w}{\mu w.e \rhd v } \qquad \inferrule{e \tr{a} e'}{\mu v. e \tr{a} e'[\mu v .e / v]}
	\end{gather*}
\end{definition}
\begin{remark}[{\cite{Sewell:1995:Algebra}}]
	The last rule (that defines the transition behaviour of the $\mu$ recursion operator) can be replaced by the following:
	\begin{gather*}
		\inferrule{e[\mu v. e / v] \tr{a} e'}{\mu v. e \tr{a} e'}
	\end{gather*}
\end{remark}

\begin{remark}[{\cite[Proposition~5.4.]{Milner:1984:Complete}}]\label{rem:semantic-substitution}
	Syntactic substitution can be described operationally using the following rules
	\begin{gather*}
		\inferrule{e \rhd v\quad f\tr{a} f'}{e[f / v] \tr{a} f'}\qquad \inferrule{e \tr{a} e'}{e[f / v] \tr{a} e'[f/v]}\qquad \inferrule{e \rhd w \quad w \neq v }{e[f/v] \rhd w} \qquad \inferrule{e \rhd v \quad f \rhd w}{e[f/v] \rhd w}
	\end{gather*}
\end{remark}
The syntactic prechart defined above is locally finite.
\begin{lemma}[{\cite[Proposition~5.1]{Milner:1984:Complete}}]
	For all $e \in \Expr$, $\langle e \rangle_\partial$ is finite.
\end{lemma}
We can use \Cref{c2:lem:quotient_coalgebra} and construct a following quotient $\funL$-coalgebra.
\begin{lemma}\label{lem:quotient_chart}	
	We can equip ${\Expr}/{\sim}$ with a transition function $\overline\partial$ given by
	$$
	\inferrule{e \tr{a}_\partial e'}{[e]_\sim \tr{a}_{\overline\partial} [e']_\sim} \qquad \inferrule{e \rhd_{\partial} v_i}{[e]_\sim \rhd_{\overline{\partial}} v_i}
	$$
	This map is a unique transition function on ${\Expr}/{\sim}$ that makes the quotient map $[-]_{\sim} \colon \Expr \to {\Expr}/{\sim}$ into prechart homomorphism.
\end{lemma}
We will refer to the elements of the set $\Expr/{\sim}$ as \emph{regular behaviours}.

It turns out that all operations from the syntax are compositional with respect to bisimilarity, and hence can be unambiguously lifted to the quotient prechart defined above.
\begin{lemma}[{\cite[Proposition~7]{Sewell:1995:Algebra}}]\label{lem:congruence}
	$\sim$ is a congruence on $\Expr$ with respect to all operations of the algebra of regular behaviours.
\end{lemma}
Using the definitions stated above, we can show the following technical lemma, that we will use when constructing a semantic category for our string diagrammatic syntax.
\begin{lemma}\label{lem:subst_lemma}
	For all $e, f_1, \dots, f_m, g_1, \dots, g_n \in \Expr$ and vectors $\vec{v}=(v_{i_1}, \dots, v_{i_m}), \vec{w}=(v_{j_1}, \dots, v_{j_n})$, such that all free variables of $e$ are contained in $\vec{v}$ and all free variables of $\vec{f}$ are contained in $\vec{w}$, we have that 
	$$
	(e[\vec{f}/ \vec{v}])[\vec{g}/\vec{w}] \sim e [(f_1[\vec{g}/\vec{w}], \dots, f_m[\vec{g}/\vec{w}])/\vec{v}] 
	$$
\end{lemma}
\begin{proof}
	Let $\Delta = \{(e,e) \in \Expr\}$ be the diagonal relation. We define a relation ${R} \subseteq {\Expr \times \Expr}$, given by the following:
	\begin{align*}
		R = \Delta \cup \{&((e[\vec{f}/ \vec{v}])[\vec{g}/\vec{w}], e [(f_1[\vec{g}/\vec{w}], \dots, f_m[\vec{g}/\vec{w}])/\vec{v}])\\ &\mid e, f_1, \dots, f_m, g_1, \dots, g_n \in \Expr, \vec{v}=(v_{i_1}, \dots, v_{i_m}), \vec{w}=(v_{j_1}, \dots, v_{j_n}),\\ &\fv(e) \subseteq 		\vec{v},  \fv(\vec{f}) \subseteq \vec{w}\}
	\end{align*}

	
	 We claim that $R$ is a bisimulation. For pairs $(e,e) \in \Delta$, the conditions of bisimulation are immediately satisfied. 
	
	For the remaining pairs, assume that $(e[\vec{f}/ \vec{v}])[\vec{g}/\vec{w}] \rhd u$. In such a case at least one of the following is true:
	\begin{itemize}
		\item $e[\vec{f}/ \vec{v}] \rhd u$
		\item $e[\vec{f}/\vec{v}] \rhd w_j$ for $w_j \in \vec{w}$ and $g_j \rhd u$
	\end{itemize}
	Since all free variables of $e$ are contained in $\vec{v}$ and all free variables of $\vec{f}$ are contained in $\vec{w}$, we have that all free variables of $e[\vec{f}/\vec{v}]$ are also contained in $\vec{w}$, which makes the first case impossible. Through a similar line of reasoning, we can deduce that $e \rhd v_i$ for some $v_i \in \vec{v}$ and $f_i \rhd w_j$. Since $g_j \rhd u$, we have that $f_i[\vec{g}/\vec{w}] \rhd u$. Finally, we have that $e[(f_1[\vec{g}/\vec{w}], \dots, f_n[\vec{g}/\vec{w}]), \vec{v}] \rhd u$.
	
	Assume that $(e[\vec{f}/ \vec{v}])[\vec{g}/\vec{w}] \tr{a} h$. Then, at least one of the following is true:
	\begin{itemize}
		\item $e[\vec{f}/\vec{v}] \rhd w_j$ and $g_j \tr{a} h$.
		\item $h = h'[\vec{g}/\vec{w}]$, such that $e[\vec{f}/\vec{v}] \tr{a} h'$ 
	\end{itemize}
	In the first case, through a similar line of reasoning as before, we can conclude that $e \rhd{ v_i}$ for some $v_i \in \vec{v}$ and $f_i \rhd w_j$. Hence, $f_i [\vec{g}/\vec{w}] \tr{a} h $. Finally, we can deduce that $e[(f_1[\vec{g}/\vec{w}], \dots, f_m[\vec{g}/\vec{w}])/\vec{v}] \tr{a} h$. Obviously, $(h,h) \in R$.
	
	In the second case, we have that $e[\vec{f}/\vec{v}] \tr{a} h'$. There are two subcases, that need to be considered
	\begin{itemize}
		\item $e \rhd v_i$ and $f_i \tr{a} h'$
		\item $h' = h''[\vec{f}/ \vec{w}]$ and $e \tr{a} h''$ 
	\end{itemize}
	In the first subcase, we have that $f_i[\vec{g}/ \vec{w}] \tr{a} h'[\vec{g}/\vec{w}]$ and hence $$e[(f_1[\vec{g}/ \vec{w}], \dots, f_m[\vec{g}/ \vec{w}])/\vec{v}] \tr{a} h'[\vec{g}/\vec{w}]$$ or equivalently $e[(f_1[\vec{g}/ \vec{w}], \dots, f_m[\vec{g}/ \vec{w}])/\vec{v}] \tr{a} h$. As before, of course $(h,h) \in R$. 
	
	Finally, moving on to the second subcase, we have that $e \tr{a} h''$ and hence $$e[(f_1[\vec{g}/ \vec{w}], \dots, f_m[\vec{g}/ \vec{w}])/\vec{v}] \tr{a} h''[(f_1[\vec{g}/ \vec{w}], \dots, f_m[\vec{g}/ \vec{w}])/\vec{v}]$$ Recall that $(e[\vec{f}/ \vec{v}])[\vec{g}/\vec{w}] \tr{a} h$ and $h = (h''[\vec{f}/\vec{v}])[\vec{g}/\vec{v}]$. Both of those reachable expressions are actually in the relation $R$. The remaining conditions of bisimulation, can be shown via a symmetric argument. 
\end{proof}
From now on, we will overload the notation and simply write $e$ for the equivalence class $[e]_{\sim}$. 
\subsection{Behavioural distance of precharts}
Given a pseudometric space defined on a state-space of a prechart, we can \emph{lift} it to the set of possible transitions through the following construction.
\begin{definition}[Transitions lifting]\label{def:edge}
	Let $(X,d)$ be a pseudometric space. We write $d^\uparrow$ for the pseudometric on $\Sigma \times X + V$ defined by $d^\uparrow(m, n) = \frac{1}{2} d(x,y)$ if $m = (a,x)$ and $n = (a,y)$, $d^\uparrow(m,n)=0$ if $m = n$ or $d^{\uparrow}(m,n)=1$ otherwise.
\end{definition}
\begin{remark}\label{c3:rem:discount}
	Unlike \Cref{chapter2}, for simplicity and clarity, we fix a discount factor of $\frac{1}{2}$ for transitions with identical labels, rather than allowing an arbitrary  $\lambda \in \interval[open]{0}{1}$. The results in this chapter can be readily generalised to any discount factor in the open unit interval, and we explicitly note this when introducing the axioms and proving completeness.
\end{remark}
The transitions lifting introduced above satisfies the following:
\begin{lemma}
	$(-)^\uparrow \colon D_X \to D_{\Sigma \times X + V}$, the lifitng for $\Sigma \times (-) + V$ is contractive with respect to the metric induced by the sup norm. Namely,
	$\|d^\uparrow - d'^\uparrow \| \leq \frac{1}{2} \|d - d' \|$ 
\end{lemma}
\begin{proof}
	For the sake of simplicity, assume that $d' \sqsubseteq d$, and hence $d'^\uparrow \sqsubseteq d^\uparrow$. It suffices that we show that for all $u,w \in \Sigma \times X + V$, we have that $ d^\uparrow(u,w) - d'^\uparrow(u,w) \leq \frac{1}{2}\|d-d'\|$. Recall that in all cases, except when $u=(a,x)$ and $w=(a,y)$ for some $a \in \Sigma$ and $x,y \in X$, $d^\uparrow(u,w)=d'^\uparrow(u,w)$ and hence  $d^\uparrow(u,w)-d'^\uparrow(u,w) = 0 \leq \frac{1}{2} \|d - d'\|$. In the remaining case, we have that
	\begin{align*}
		d^\uparrow((a,x),(a,y)) - d'^\uparrow((a,x),(a,y)) &= \frac{1}{2}d(x,y) - \frac{1}{2}d'(x,y) \\
		&\leq \frac{1}{2} \|d'-d\|
	\end{align*}
	which completes the proof.
\end{proof}
To lift the distances between elements of $X$ to distances finite subsets of $X$ (that is elements of $\powf (X))$, we will rely on the classic notion of Hausdorff distance (also known as Pompeiu-Hausdorff distance)~\cite{Birsan:2006:One}. The standard definition applies to non-empty compact subsets of a metric space, but we adapt it here to finite (and possibly empty) subsets of a pseudometric space, following~\cite{Baldan:2018:Coalgebraic}.
\begin{definition}[Hausdorff lifting]\label{def:hausdorff}
	Let $(X,d)$ be a pseudometric space. We can equip $\powf (X)$ with a distance function $$
	\mathcal{H}(d)(X,Y)= \max \{\sup_{x \in X} \inf_{y \in Y} d(x,y), \sup_{y \in Y} \inf_{x \in X} d(y,x) \}$$ making $(\powf(X), \mathcal{H}(d))$ into a pseudometric.
\end{definition}
Moreover, Hausdorff lifting can be equivalently characterised via the notion of \emph{relational couplings}.
\begin{remark}[{\cite[Example~5.31]{Baldan:2018:Coalgebraic}}]\label{rem:hausdorff_duality}
Let $(X, d)$ be a pseudometric space and let $A, B \in \powf(X)$. Let $\Gamma(A,B)$ denote the set of relational couplings of $A$ and $B$, namely elements $R \in \powf(A \times B)$, such that $\pi_1 (R)=A$ and $\pi_2(R)=B$. The Hausdorff distance between $A$ and $B$ can be alternatively presented as:
$$
	\mathcal{H}(d)(A,B) = \inf \left\{\sup_{(x,y) \in R} d(x,y) \mid R \in \Gamma(A,B) \right\}
$$
\end{remark}
Hausdorff lifting satisfies the following property:
\begin{lemma}[{\cite{Breugel:2012:Closure}}]
	Hausdorff lifting $\mathcal{H} \colon D_X \to D_{\powf(X)}$ is nonexpansive with respect to the metric induced by the sup norm. Namely,
	$$\|\mathcal{H}(d) - \mathcal{H}(d')\| \leq \|d - d' \|$$ 
\end{lemma}
Given a prechart $(Q, \beta)$, whose state-space is equipped with a pseudometric $d_Q$, we can define a new pseudometric $\Phi_{\beta}(d_Q)$ that calculates the distance between any pair $q_1, q_2 \in Q$ of states, by lifting $d_Q$ to the set $\powf(\Sigma \times Q + V)$ and comparing $\beta(q_1)$ with $\beta(q_2)$, namely 
	$
		\Phi_\beta(d_Q)(q_1,q_2) = \mathcal{H}\left(d_Q^\uparrow\right) (\beta(q_1), \beta(q_2))
	$. This is used to define the \emph{behavioural distance}.
	\begin{theorem}\label{thm:beh_dist}
		Let $(Q, \beta)$ be a prechart. Then, the following properties hold: \circlednum{1} $d_Q \mapsto \Phi_\beta(d_Q)$ is a monotone mapping on the lattice $D_Q$, \circlednum{2} $\Phi_\beta$ has a least fixpoint $\mathsf{bd}_\beta$, \circlednum{3} $x \sim y \implies \mathsf{bd}_\beta(x,y) = 0$ and \circlednum{4} a homomorphism $f \colon Q \to R$ between precharts $(Q, \beta)$ and $(R, \gamma)$ is an isometry between $(Q, \mathsf{bd}_\beta)$ and $(R, \mathsf{bd}_\gamma)$.
	\end{theorem}
	\begin{proof}
		$\mathcal{H}$ and $(-)^\uparrow$ are liftings for the functors $\powf$ and $\Sigma \times (-) + V$ respectively, that preserve isometries~\cite[Theorem~5.8]{Baldan:2018:Coalgebraic}. The rest follows from~\Cref{c2:lem:behavioural_distances} and \Cref{c2:lem:behavioural_distances_properties}
	\end{proof}
	The monotone map used to define the behavioural distance satisfies the following:
\begin{lemma}\label{c3:lem:contractive}
	$\Phi_\beta \colon D_X \to D_X$ is contractive with respect to the metric induced by the sup norm, namely $
	\|\Phi_\beta(d)-\Phi_\beta(d')\| \leq \frac{1}{2}\|d-d'\|
	$.
\end{lemma}
\begin{proof}
	For the sake of simplicity, assume that $d' \sqsubseteq d$ and hence $\Phi_\beta(d') \sqsubseteq \Phi_{\beta}(d)$. It suffices to show that for all $x,y \in X$, we have that $\mathcal{H}(d^\uparrow)(\beta(x), \beta(y)) -  \mathcal{H}(d'^\uparrow)(\beta(x), \beta(y))  \leq \frac{1}{2}\|d-d'\|$. We can combine the previous results and for arbitrary $x,y \in X$ obtain the following
	\begin{align*}
		\mathcal{H}(d^\uparrow)(\beta(x), \beta(y)) -  \mathcal{H}(d'^\uparrow)(\beta(x), \beta(y)) & \leq \|\mathcal{H}(d^\uparrow) - \mathcal{H}(d'^\uparrow)\| \\
		&\leq \|d^\uparrow - d'^\uparrow\|\\
		& \leq \frac{1}{2} \|d - d'\| \qedhere
	\end{align*}
\end{proof}
As a consequence, we have the following corollary:
\begin{corollary}
	$\Phi_\beta$ has a unique fixpoint.
\end{corollary}
Additionally, through an identical argument to \Cref{c2:lem:cocontinuous}, we can show the following:
\begin{lemma}\label{lem:cocontinuous}
	For a finite prechart $(X,\beta)$, $\Phi_\beta$ is cocontinuous.
\end{lemma}
\begin{proof}
	Since $X$ is finite and $\Phi_\beta$ is nonexpansive with respect to the metric induced by the sup-norm (by \Cref{c3:lem:contractive}), an application of \Cref{c2:lem:cocontinuous} yields the desired result.
\end{proof}
Since $\Phi_\beta$ has a unique fixpoint, we can use~\Cref{c2:thm:kleene} to calculate behavioural distance of states of finite precharts.
\begin{lemma}\label{lem:finite_dist}
	Let $(Q, \beta)$ be a finite prechart. The behavioural distance between any pair $q_1, q_2 \in Q$ of states can be calculated by $\mathsf{bd}_\beta(q_1,q_2) = \inf_{p \in \N} \left \{ \Phi^{(p)}_\beta(q_1, q_2) \right\}$, where $\Phi^{(0)}_\beta$ is a discrete pseudometric and for any $p \in \N$, we define $\Phi^{(p+1)}_\beta = \Phi_\beta \left( \Phi^{(p)}_\beta\right)$.
\end{lemma}
The characterisation described above can be extended to any locally finite prechart.
\begin{corollary}\label{cor:kleene_locally_finite}
	For any locally finite prechart $(X,\beta)$, the distance between $x, y \in X$, can be calculated by:
	\[
		\mathsf{bd}_\beta(x,y) = \inf_{i \in \N} \left(\Phi_\beta^{(i)}(x,y)\right)
	\]
\end{corollary}
\begin{proof}
Let $\beta'$ denote $\beta$ restricted to $\langle x , y \rangle_\beta$.
	Since $(X, \beta)$ is locally finite, then its subprechart $(\langle x , y \rangle_\beta, \beta')$ is finite. Since homomorphisms are isometries, calculating distance between $x$ and $y$ in $(X, \beta)$ is the same as calculating it in $(\langle x , y \rangle_\beta, \beta)$. Because of \Cref{lem:cocontinuous}, $\Phi_\beta$ is cocontinuous (when restricted to $\langle x , y \rangle_{\beta'}$) and hence we can employ \Cref{c2:thm:kleene}. Since the infima in the lattice of pseudometrics can be calculated pointwise (\Cref{c2:lem:chain_pointwise_inf}), we have that
	$$
	\mathsf{bd}_\beta(x,y) = \mathsf{bd}_{\beta'}(x,y) = \inf_{i \in I} \left( \Phi^{(i)}_{\beta'}(x,y)\right)
	$$
	Since $\beta'$ is a restriction of $\beta$ to ${\langle x , y \rangle_\beta}$ and each $\Phi^{(i)}_{\beta'}$ makes only use of the states in $\langle x , y \rangle_\beta$, we can rewrite the above as $
	\mathsf{bd}_\beta(x,y) = \inf_{i \in \N} \left(\Phi_\beta^{(i)}(x,y)\right)
	$ as desired.
\end{proof} 
The behavioural distance between any two states in locally finite precharts is always a power of two.
\begin{lemma}\label{lem:distance_power_of_two}
	Let $(X,\beta)$ be a locally finite prechart. For all $x,y \in X$, $i \in \N$, either $\Phi_\beta^{(i)}=0$ or there exists $k \in \N$, such that $\Phi_{\beta}^{(i)}(x,y)=2^{-k}$
\end{lemma}
\begin{proof}
	Let $x,y \in X$. We proceed by induction on $i$. 
	
	\begin{itemize}
		\item If $i = 0$, then $\Phi^{(0)}_\beta(x,y)=1=2^{0}$, if $x\not=0$ or $\Phi^{(0)}_\beta(x,y)=0$, otherwise. 
		\item If $i = j + 1$, then unrolling the definition of $\Phi_\beta^{(j+1)}$ yields the following:
			$$\Phi^{j + 1}_\beta(x,y) = \max \left\{\sup_{u \in \beta(x)} \inf_{w \in \beta(y)} {\Phi^{(j)}_\beta}^\uparrow(u,w), \sup_{w \in \beta(y)} \inf_{u \in \beta(x)}{\Phi^{(j)}_\beta}^\uparrow(w,u)\right\}$$
			For any two transitions $u = (a,x')$ and $w=(a,y')$ with the same prefix, the following holds:
			$${\Phi^{(j)}_\beta}^\uparrow(u,w)=\frac{1}{2} {\Phi^{(j)}_\beta}(x',y')$$
			We can apply the induction hypothesis, which states that one of the following is true:
			\begin{itemize}
				\item${\Phi^{(j)}_\beta}(x',y')=0$, which entails that ${\Phi^{(j)}_\beta}^\uparrow(u,w)=0$.
				\item There exists a $k \in N$, such that ${\Phi^{(j)}_\beta}(x',y')=2^{-k}$. This implies that ${\Phi^{(j)}_\beta}^\uparrow(u,w)=2^{-(k+1)}$.
			\end{itemize}
			Since the infima range over finite sets, their values are either $1=2^0$ if the sets are empty or are one of the values from the set, which we have shown to be of the desired form. Similarly, suprema range over finite sets and are either $0$ for empty sets or are on of the values from the set, which are in the desired form. Taking the maximum of values in the desired form, still results in a value in the desired form.\qedhere
	\end{itemize}
\end{proof}
If two states have a non-zero distance, then the chain of approximants from Kleene's fixpoint theorem stabilises.
\begin{lemma}\label{lem:chain_stabilises}
	Let $(X, \beta)$ be a locally finite prechart and let $x,y \in X$, such that $\mathsf{bd}_\beta(x,y)>0$. There exists $i \in \N$, such that $\Phi_\beta^{(i)}(x,y)=\Phi^{(i+1)}_\beta(x,y)$
\end{lemma}
\begin{proof}
	Assume that for all $i \in \N$, $\Phi_\beta^{(i)}(x,y)\neq\Phi^{(i+1)}_\beta(x,y)$. Essentially, that means we have an infinite, strictly decreasing $\omega$-cochain $\{\Phi^{(i)}_\beta(x,y)\}_{i \in I}$. By \Cref{lem:distance_power_of_two}, we know that the values of the chain are either $0$ or $2^{-k}$. Since all the values of the chain are nonegative, if any of it is equal to zero $0$, we reach a contradiction, as the chain would have to contain values strictly below $0$. Hence, we can safely assume that the chain is in the form $\{1,\frac{1}{2}, \frac{1}{4}, \dots\}$. But in such a case its infimum is $0$, contradicting the assumption.
\end{proof}
We can connect behavioural distances with stratified bisimulations via the following result:
\begin{lemma}\label{lem:bound_on_stratified_bisim}
	Let $(X, \beta)$ be a prechart. For any $x,y \in X$, we have that 
	$$
	x \sim^{(k)} y \iff \mathsf{bd}_{\beta}(x,y) \leq 2^{-k}
	$$
\end{lemma}
\begin{proof}
	By induction on $k$. The base case is trivial, as we immediately have that $x \sim^{(0)} y$ and $\mathsf{bd}_\beta(x,y) \leq 2^{0} = 1$.
	
	For the inductive step assume that for some $k' \in \N$, the induction hypothesis holds. First, assume that $x \sim^{(k'+1)} y$. Unrolling the definition of stratification of bisimilarity, we have that
	\begin{itemize}
		\item If $x \rhd v$, then $y \rhd v$
		\item If $x \tr{a} x'$, then there exists $y'$ such that $y \tr{a} y'$ and $x \sim^{(k')} y$.
	\end{itemize}
	and symmetrically.
	
	We want to show that $\mathsf{bd}_\beta(x,y) \leq 2^{-(k'+1)}$. We can unroll the definition of $\mathsf{bd}_\beta$ and rewrite the desired result as
	$$
	\sup_{u \in \beta(x)} \left( \inf_{w \in \beta(y)} \mathsf{bd}_\beta^\uparrow(u,w)\right)  \leq 2^{-(k'+1)}\quad \wedge \quad \sup_{w \in \beta(y)} \left( \inf_{u \in \beta(x)} \mathsf{bd}_\beta^\uparrow(w,u)  \right)\leq 2^{-(k'+1)}
	$$
	We focus on the left hand side of the conjunction above, as the right hand side is symmetric. We are aiming to show that
	$$
	\forall {u \in \beta(x)}\ldotp~\inf_{w \in \beta(y)} \mathsf{bd}_\beta^\uparrow(u,w)  \leq 2^{-(k'+1)} 
	$$
	Let $u \in V$. By the assumption, we know that also $u \in B(y)$, which means that $$\inf_{w \in \beta(y)} \mathsf{bd}_\beta^\uparrow(u,w) = 0 \leq 2^{-(k'+1)}$$
	
	Now, let $u \in \Sigma \times X$, i.e. $u = (a,x')$. By the assumption, we know that there exists $y' \in X$, such that $(a,y') \in \beta(y)$ and $x' \sim^{(k')} y'$. By induction hypothesis, we know that $\mathsf{bd}_{\beta}(x',y') \leq 2^{-k'}$. Hence, we have that $\mathsf{bd}_{\beta}^\uparrow((a,x'),(a,x')) \leq \frac{1}{2} \cdot  2^{-k'} = 2^{-(k'+1)}$. Hence, we again have that 
		$$
		\forall {u \in \beta(x)}\ldotp~\inf_{w \in \beta(y)} \mathsf{bd}_\beta^\uparrow(u,w)  \leq 2^{-(k'+1)} 
		$$
		
		Now, for the converse assume that $\mathsf{bd}_\beta(x,y) \leq 2^{-(k'+1)}$. Through a similar line of reasoning, as before, we have that
		$$
		\forall{u \in \beta(x)}\ldotp~\inf_{w \in \beta(y)} \mathsf{bd}_\beta^\uparrow(u,w) \leq 2^{-(k'+1)} 
		$$
		Assume that $x \rhd v$, i.e. $v \in \beta(x)$. Assume that $\neg (y \rhd v)$. That means that for all $w \in \beta(y)$, we have that $\mathsf{bd}_\beta^\uparrow(v,w) = 1$ and hence $\inf_{w \in \beta(y)} \mathsf{bd}_\beta^\uparrow(v,w)=1$, which contradicts the assumption as $1>2^{-{(k'+1)}}$. Hence, $y \rhd v$.
		
		Now, assume that $x \tr{a} x'$, i.e. $(a,x') \in \beta(y)$. Through a similar argument as before, we know that there must exist $(a,y')\in \beta(y)$, such that $\mathsf{bd}_\beta^\uparrow((a,x'),(a,y')) \leq 2^{-(k'+1)}$. Unrolling the definitions of $\mathsf{bd}_\beta^\uparrow$, we obtain $\frac{1}{2} \cdot \mathsf{bd}_{\beta}(x',y') \leq 2^{-(k'+1)}$ and hence $\mathsf{bd}_{\beta}(x',y') \leq 2^{-k'}$. Using the induction hypothesis, we get that $x' \sim^{(k')} y'$ as desired. The remaining part of the proof is symmetric and hence is omitted.
\end{proof}
We can now combine the above results and obtain the following concrete characterisation of behavioural distance of locally finite precharts.
\begin{theorem}\label{thm:concrete_distance}
Let $(X,\beta)$ be a locally finite prechart and let $x,y \in X$. The behavioural distance between $x$ and $y$ is given by:
	$$\mathsf{bd}_\beta(x,y) = \begin{cases}
		0 & \text{ if } x \sim y\\
		2^{-n} & \text{ if } n \in \N \text{ is the largest number such that } x\sim^{(n)} y
	\end{cases}$$
\end{theorem}
\begin{proof}
	For the first case, because of \Cref{thm:beh_dist}, if $x \sim y$, then $\mathsf{bd}_{\beta}(x,y)=0$. For the converse, if $\mathsf{bd}_{\beta}(x,y)=0$, we have that $x \sim^{(k)} y$ for all $k \in \N$ and hence by \Cref{eqn:stratification}, it holds that $x \sim y$.
	
	 In the second case, because of \Cref{lem:chain_stabilises}, we know that if $\mathsf{bd}_\beta(x,y) > 0$, then the behavioural distance is equal to some element of the chain of approximants. By \Cref{lem:distance_power_of_two}, we know that all non-zero elements of that chain are equal to $2^{-k}$, for some $k \in \N$. Combining it with \Cref{lem:bound_on_stratified_bisim} yields the desired result. 
	 For the converse, if $n \in N$ is the largest number such that $x \sim^{(n)} y$, then because of \Cref{lem:bound_on_stratified_bisim}, we have that $\mathsf{bd}_\beta(x,y)\leq 2^{-n}$. Assume that $\mathsf{bd}_\beta(x,y)=0$. In such a case, using \Cref{lem:bound_on_stratified_bisim}, we could conclude that $x \sim^{(n+1)} y$, which would lead to contradiction. Hence, $\mathsf{bd}_\beta(x,y)>0$. Because of \Cref{lem:chain_stabilises}, we have that $\mathsf{bd}_\beta(x,y)$ is equal to some power of two. Combining that with \Cref{lem:bound_on_stratified_bisim} again yields the desired result.\qedhere
\end{proof}
\begin{remark}
If the discount factor $\frac{1}{2}$ in the definition of transition lifting were replaced with an arbitrary $\lambda \in \interval[open]{0}{1}$ (as discussed in \Cref{c3:rem:discount}), then \Cref{c3:lem:contractive}, \Cref{lem:distance_power_of_two}, \Cref{lem:bound_on_stratified_bisim} and \Cref{thm:concrete_distance} would need to be adjusted accordingly to mention (powers of) $\lambda$, but otherwise would remain unchanged.
\end{remark}
\subsection{Monoidal categories}\label{c3:subsec:monoidal}
Throughout this thesis, we assume the reader is familiar with basic concepts of monoidal categories~\cite{Selinger_2010,piedeleu2023introduction}, traced monoidal categories~\cite{Joyal:1996:Traced}, and compact closed categories~\cite{kellylaplaza}. Nevertheless, we recall the definitions of (symmetric) monoidal categories to establish notation for the remainder of the chapter.
\begin{definition}
A monoidal category is a tuple $(\mathcal{C}, \otimes, I, \alpha, \lambda, \rho)$ consisting of:
\begin{itemize}
    \item A category $\mathcal{C}$,
    \item A bifunctor $\otimes \colon \mathcal{C} \times \mathcal{C} \to \mathcal{C}$ (monoidal product),
    \item An object $I \in\ObjC(\C)$ (monoidal unit),
    \item A natural isomorphism $\alpha_{A,B,C} \colon (A \otimes B) \otimes C \xrightarrow{\sim} A \otimes (B \otimes C)$ (associator),
    \item Natural isomorphisms $\lambda_A \colon I \otimes A \xrightarrow{\sim} A$ and $\rho_A \colon A \otimes I \xrightarrow{\sim} A$ (left and right unitors),
\end{itemize}
satisfying the following coherence conditions:
\begin{enumerate}
    \item {Pentagon identity}: For all $A,B,C,D \in \ObjC(\C)$, the diagram
    \[\begin{tikzcd}
        & ((A \otimes B) \otimes C) \otimes D \arrow[dr, "\alpha_{A\otimes B,C,D}"] \arrow[dl, "\alpha_{A,B,C} \otimes \id_D"'] \\
        (A \otimes (B \otimes C)) \otimes D \arrow[d, "\alpha_{A,B\otimes C,D}"] & & (A \otimes B) \otimes (C \otimes D) \arrow[d, "\alpha_{A,B,C\otimes D}"] \\
        A \otimes ((B \otimes C) \otimes D) \arrow[rr, "\id_A \otimes \alpha_{B,C,D}"'] & & A \otimes (B \otimes (C \otimes D))
    \end{tikzcd}\]
    commutes.
    
    \item {Triangle identity}: For all $A,B \in\ObjC(\C)$, the diagram
    \[\begin{tikzcd}
        (A \otimes I) \otimes B \arrow[rr, "\alpha_{A,I,B}"] \arrow[dr, "\rho_A \otimes \id_B"'] & & A \otimes (I \otimes B) \arrow[dl, "\id_A \otimes \lambda_B"] \\
        & A \otimes B &
    \end{tikzcd}\]
    commutes.
\end{enumerate}
A monoidal category is called {strict} if $\alpha$, $\lambda$, and $\rho$ are identity morphisms.
\end{definition}
We often abuse notation by referring to the monoidal category as $(\mathcal{C}, \otimes, I)$, by omitting associator and unitors. 
\begin{definition}
A {symmetric monoidal category} is a monoidal category $(\mathcal{C}, \otimes, I, \alpha, \lambda, \rho)$ equipped with a natural isomorphism $\sigma_{A,B} \colon A \otimes B \xrightarrow{\sim} B \otimes A$, called symmetry, satisfying the following additional coherence conditions:  
\begin{enumerate}  
    \item {Involutivity}: For all $A,B \in \ObjC(\C)$, the composite  
    \[  
    A \otimes B \xrightarrow{\sigma_{A,B}} B \otimes A \xrightarrow{\sigma_{B,A}} A \otimes B  
    \]  
    equals $\id_{A \otimes B}$.  

    \item {Hexagon identity}: For all $A,B,C \in\ObjC(\C)$, the diagram  
    \[\begin{tikzcd}  
        & (A \otimes B) \otimes C \arrow[dl, "\alpha_{A,B,C}"'] \arrow[dr, "\sigma_{A,B} \otimes \id_C"] \\  
        A \otimes (B \otimes C) \arrow[d, "\sigma_{A,B \otimes C}"'] & & (B \otimes A) \otimes C \arrow[d, "\alpha_{B,A,C}"] \\  
        (B \otimes C) \otimes A \arrow[dr, "\alpha_{B,C,A}"'] & & B \otimes (A \otimes C) \arrow[dl, "\id_B \otimes \sigma_{A,C}"] \\  
        & B \otimes (C \otimes A) &  
    \end{tikzcd}\]  
    commutes.  

    \item {Unitor compatibility}: For all $A \in\ObjC(\C)$, the diagram  
    \[\begin{tikzcd}  
        A \otimes I \arrow[rr, "\sigma_{A,I}"] \arrow[dr, "\rho_A"'] & & I \otimes A \arrow[dl, "\lambda_A"] \\  
        & A &  
    \end{tikzcd}\]  
    commutes.  
\end{enumerate}   
\end{definition}
%Examples of monoidal categories include:
%\begin{itemize}
%    \item $(\mathsf{Set}, \times, \{\bullet\})$ - The category of sets forms a symmetric monoidal category, where the tensor product $\times$ is the Cartesian product of sets and the monoidal unit $\{\bullet\}$ is the singleton set.
%    \item $(\mathsf{PMet}, \times, I_\otimes)$ - The category of pseudometric spaces and nonexpansive maps forms a symmetric monoidal category where the tensor product is the product space with the $\sup$-metric and the unit $I_\otimes$ is a singleton space $\{\bullet\}$ with the (unique) discrete pseudometric $d_\bullet(\bullet, \bullet)=0$.
%    \item For any semiring $\mathbb{S}$, $(\mathsf{Mat}(\mathbb{S}), \oplus, [])$ - The category of $\mathbb{S}$-valued matrices forms a strict symmetric monoidal category where objects are natural numbers $\mathbb{N}$, morphisms $n \to m$ are $n \times m$ matrices over $\mathbb{S}$, and composition is given by matrix multiplication. The tensor product $\oplus$ is the direct sum (block diagonal) of matrices, while the unit is the empty matrix $[]$
%\end{itemize}
\subsection{Conway theories}\label{c3:subsec:conway}
Let $\cat{C}$ be a category, whose objects are natural numbers and $0$ is the initial object. We will write $0_n$ for the unique map $0_n \colon 0 \to n$. Additionally, we assume that $\cat{C}$ is equipped with all finite coproducts, where the binary coproduct is given by addition, i.e. $n \oplus m := n + m$. Given $f \colon k \to m$ and $g \colon l \to m$, we will write $\lc f,g \rc \colon k +l \to m$ for the mediating map from the universal property of the coproduct that makes the following diagram commute:
\begin{equation}\label{eqn:mediating}
% https://q.uiver.app/#q=WzAsNCxbMSwwLCJrK2wiXSxbMiwwLCJsIl0sWzAsMCwiayJdLFsxLDIsIm0iXSxbMiwwLCJcXGlubF97ayArIGx9Il0sWzEsMCwiXFxpbnJfe2sgKyBsfSIsMl0sWzIsMywiZiIsMl0sWzEsMywiZyJdLFswLDMsIltmLGddIiwxLHsic3R5bGUiOnsiYm9keSI6eyJuYW1lIjoiZGFzaGVkIn19fV1d
\begin{tikzcd}
	k & {k+l} & l \\
	\\
	& m
	\arrow["{\inl_{k + l}}", from=1-1, to=1-2]
	\arrow["f"', from=1-1, to=3-2]
	\arrow["{[f,g]}"{description}, dashed, from=1-2, to=3-2]
	\arrow["{\inr_{k + l}}"', from=1-3, to=1-2]
	\arrow["g", from=1-3, to=3-2]
\end{tikzcd}
\end{equation}
For every $n \in N$, we can define a codiagonal $\nabla_{n} \colon n + n \to n$, given by $\nabla_n := \lc\id_n,\id_n\rc$.

Given $f \colon k \to l$ and $g \colon m \to n$, we can define their \emph{separated sum} $f \oplus g \colon k + m \to l + n $, given by the unique mediating arrow in the following diagram
% https://q.uiver.app/#q=WzAsNixbMCwwLCJrIl0sWzIsMCwiayArIG4iXSxbMCwyLCJsIl0sWzQsMCwibSJdLFs0LDIsIm4iXSxbMiwyLCJsICsgbiJdLFswLDEsIlxcaW5sIl0sWzMsMSwiXFxpbnIiLDJdLFsyLDUsIlxcaW5sIiwyXSxbNCw1LCJcXGluciJdLFsxLDUsImYgXFxvcGx1cyBnIiwxLHsic3R5bGUiOnsiYm9keSI6eyJuYW1lIjoiZGFzaGVkIn19fV0sWzAsMiwiZiIsMl0sWzMsNCwiZyJdXQ==
% https://q.uiver.app/#q=WzAsNixbMCwwLCJrIl0sWzIsMCwiayArIG0iXSxbMCwyLCJsIl0sWzQsMCwibSJdLFs0LDIsIm4iXSxbMiwyLCJsICsgbiJdLFswLDEsIlxcaW5sIl0sWzMsMSwiXFxpbnIiLDJdLFsyLDUsIlxcaW5sIiwyXSxbNCw1LCJcXGluciJdLFsxLDUsImYgXFxvcGx1cyBnIiwxLHsic3R5bGUiOnsiYm9keSI6eyJuYW1lIjoiZGFzaGVkIn19fV0sWzAsMiwiZiIsMl0sWzMsNCwiZyJdXQ==
\begin{equation}\begin{tikzcd}\label{eqn:monoidal}
	k && {k + m} && m \\
	\\
	l && {l + n} && n
	\arrow["\inl_{k,m}", from=1-1, to=1-3]
	\arrow["f"', from=1-1, to=3-1]
	\arrow["{f \oplus g}"{description}, dashed, from=1-3, to=3-3]
	\arrow["\inr_{k,m}"', from=1-5, to=1-3]
	\arrow["g", from=1-5, to=3-5]
	\arrow["\inl_{l,n}"', from=3-1, to=3-3]
	\arrow["\inr_{l,n}", from=3-5, to=3-3]
\end{tikzcd}\end{equation}
Observe that under the assumptions listed above $\cat{C}$ is equipped with all finite coproducts (since it has an initial object and binary coproducts), and hence $(\cat{C}, \oplus , 0 )$ is a cocartesian symmetric monoidal category. 

We follow the terminology of Esik, and we call $\cat{C}$ a \emph{preiteration theory}~\cite{Esik:1999:Group} if for every morphism $f \colon n \to p + n$, there exists a morphism $f^\dagger_{n,p} \colon n \to p$ called \emph{dagger}. We will often omit the subscripts and write $f^\dagger$, when $n$ and $m$ are clear from the context. Note that the definition does not impose any conditions on the dagger. However, for $f \colon 0 \to p$, when always we have that $f_{0,p}^\dagger = 0_p$.
 
 
\begin{definition}[{\cite[Definition~3.1]{Esik:1999:Group}}]\label{def:conway_theory}
	A Conway theory is a preiteration theory, in which the following conditions are satisfied:
	\begin{itemize}
		\item[] \textbf{(Scalar parameter identity)} $$(f ; (g \oplus \id_1))^\dagger = f^\dagger ; g$$ for all $f \colon 1 \to p + 1$, $g \colon p \to q$.
		\item[] \textbf{(Scalar composition identity)} 
		$$
		(f ; \lc \id_p\oplus0_1, g \rc)^\dagger = f ; \lc \id_p,  (g ;  \lc \id_p \oplus 0_1 , f\rc)^\dagger\rc
		$$ for all $f,g \colon 1 \to p + 1$.
		\item[] \textbf{(Scalar double dagger identity)} 
		$$f^{\dagger\dagger} = (f ; (\id_p \oplus \nabla_1))^\dagger$$
		for all $f \colon 1 \to p + 2$.
		\item[] \textbf{(Scalar pairing identity)}
		$$\lc f ,g \rc^\dagger = \lc f^\dagger ; \lc \id_p, h^\dagger \rc, h^\dagger \rc$$ for all $f \colon n \to p + 1 + n $, $g \colon 1 \to p + 1 + n$ where 
		$$
		h = g ; \lc \id_{p + 1}, f^\dagger\rc \colon 1 \to p + 1
		$$
	\end{itemize}
\end{definition}
\begin{remark}[{\cite[Remark~3.2]{Esik:1999:Group}}]\label{rem:defining_dagger}
	Note that in order to define a Conway theory it suffices to define $f^\dagger \colon 1 \to p$ for all $f \colon 1 \to p + 1$ that satisfies first three axioms of \Cref{def:conway_theory} and use \textbf{scalar pairing identity} to inductively define $(-)^\dagger$.
\end{remark}

\subsection{Trace-fixpoint correspondence}
It turns out that Conway theories can be seen as a special case of traced symmetric monoidal categories. This is captured by the following theorem that was independently proved by Hasegawa~\cite{Hasegawa:1997:Models} and Haghverdi~\cite{Haghverdi:2000:Categorical}. The formulation of Hasegawa is phrased dually via the setting of products and cartesian categories.
\begin{theorem}[{\cite[Proposition~3.1.9]{Haghverdi:2000:Categorical}}]\label{thm:trace}
For any category with finite coproducts, to give a Conway operator is to give a trace (where finite coproducts are taken as the monoidal structure). 
\end{theorem}
That bijective correspondence is concretely given by the following:
\begin{gather*}
	\inferrule{f \colon  n \to p + n}{f^\dagger = \Tr^n_{n,p} (\nabla_n ; f) \colon n \to p} 
	\qquad
	\inferrule{g \colon p + n \to q + n}{\Tr^{n}_{p,q}(g) = \inl_{p,n} ; (g; \lc\id_q, \inr_{q +p,n} \rc)^\dagger  \colon p \to q}
\end{gather*}	

\subsection{Int construction}\label{c3:subsec:int}
Given a traced symmetric monoidal category $(\cat{C}, \otimes, I)$, we can construct a compact closed category $\Int{\cat{C}}$~\cite{Joyal:1996:Traced}. The objects of $\Int{\cat{C}}$ are the pairs $(A^+,A^-)$ of objects of $\cat{C}$. Morphisms $f$ from $(A^+, A^-)$ to $(B^+, B^-)$ are the morphisms $f \colon A^+ \otimes B^- \to A^- \otimes B^+$ of $\cat{C}$. The identity of any object $(A^+, A^-)$ is given by the symmetry of $\cat{C}$, namely $\id_{(A^ +, A^-)} = \sigma_{A^+, A^-}$. The composition $f ; g \colon (A^+, A^-) \to (C^+, C^-)$ of morphisms $f \colon (A^+, A^-) \to (B^{+}, B^-)$ and $g \colon (B^+, B^-) \to (C^+,C^-)$ is defined as
	$
		\Tr^{B^- \otimes B^+}_{A^+ \otimes C^-, A^- \otimes C^+} (\alpha ; (f \otimes g) ; \beta)
	$, where \begin{gather*}\alpha = (\id_{A^+} \otimes \sigma_{C^-, B^-} \otimes \id_{B^+});(\id_{A^+} \otimes \id_{B^-} \otimes \sigma_{C^-, B^+})\\\beta = (\id_{A^-} \otimes \id_{B^+} \otimes \sigma_{B^-, C^+}); (\id_{A^-} \otimes \sigma_{B^+, C^+} \otimes \id_{B^-});(\id_{A^-} \otimes \id_{C^+} \otimes \sigma_{B^+, B^-})\end{gather*}
	
	$\Int{\cat{C}}$ is equipped with the monoidal structure. The tensor product of $(A^+, A^-)$ and $(B^+, B^-)$ is given by taking the tensor product of $\cat{C}$ pointwise, namely $(A^+ \otimes B^+, A^- \otimes B^-)$. The unit of that monoidal product is given by $(I, I)$, where $I$ is the unit of the monoidal product on $\cat{C}$. The tensor product $f \otimes g \colon (A^+ \otimes C^+, B^- \otimes D^-) \to (A^- \otimes C^-, B^+ \otimes D^+)$ of $f \colon (A^+, A^-) \to (B^+, B^-)$ and $g \colon (C^+, C^-) \to (C^+, C^-) \to (D^+, D^-)$ is given by the following:
	$$
	f \otimes g = (\id_{A^+} \otimes \sigma_{C^+, B^-} \otimes \id_{D^-});(f \otimes g);(\id_{A^-} \otimes \sigma_{B^+, C^-} \otimes \id_{D^+})
	$$
	
	The dual $(A^+, A^-)^{\ast}$ of $(A^+, A^-)$ is given by exchanging the components, that is by $(A^-, A^+)$. Then, the unit $\eta_{(A^+, A^-)} \colon (I,I) \to (A^+, A^-) \otimes (A^+, A^-)^{\ast}$ is a morphism $\sigma_{A^-, A^+} \colon A^- \otimes A^+ \to A^+ \otimes A^-$. The counit $\epsilon_{(A^+, A^-)} \colon (A^+, A^-)^\ast \otimes (A^+, A^-) \to (I,I)$ can be similarly given by $\sigma_{A^-, A^+} \colon A^- \otimes A^+ \to A^+ \otimes A^-$ in $\cat{C}$.
	
	$\Int{\cat{C}}$ is equipped with a canonical trace, which takes a morphism $$f \colon (A^+, A^-) \otimes (U^+, U^-) \to (B^+, B^-) \otimes (U^+, U^-)$$ to the map given by the following:
	\[
	\left(\id_{(A^+, A-)} \otimes \eta_{(U^+, U^-)}\right) ;\left(f \otimes \id_{{(U^+, U^-)}^\ast}\right); \left(\id_{(B^+, B^-)} \otimes \epsilon_{(U^+, U^-)}  \right)
	\]
	
	\section{Monoidal Syntax}\label{c3:sec:monoidal}
We adopt the diagrammatic syntax for NFA that has appeared in a number of previous papers~\cite{piedeleu2023finite,antoinecsl2025}. 
We refer the reader to Selinger's classic survey~\cite{Selinger_2010}, or to Piedeleu and Zanasi's recent text for a more gentle introduction to the language of string diagrams~\cite{piedeleu2023introduction}.

This syntax is formalised as a product and permutation category, or prop, a structure which generalises algebraic theories. Formally, a \emph{prop} is a strict symmetric monoidal category (SMC) whose objects are words over a set of generators and whose monoidal product $\proptimes$ is given by concatenation. 
More specifically, our syntax is the free prop $\freeP{\Signature}$ over the signature $\Signature = (\Obj,\Morph)$, given by a set $\Obj$ of generating objects and a set $\Morph$  of generating morphisms $g\from v\to w$, with $v,w\in \Obj^*$ (we use $\epsilon$ to denote the empty word). Morphisms of  $\freeP{\Signature}$ can be combined in two different ways, using the composition operation $(-);(-)\from \freeP{\Signature}(u,v)\times \freeP{\Signature}(v,w)\to \freeP{\Signature}(u,w)$ or the monoidal product $(-)\proptimes(-)\from \freeP{\Signature}(v_1,w_1)\times \freeP{\Signature}(v_2,w_2)\to \freeP{\Signature}(v_1 v_2,w_1 w_2)$. We also have distinguished constants: identities $\id_w\from w\to w$, which are the unit for composition, and symmetries $\sigma^v_w\from vw\to wv$, to reorder the letters of a given object. In summary, morphisms of $\freeP{\Signature}$ can be described as terms of the $(\Obj^*,\Obj^*)$-sorted syntax generated from the constants $\Morph + \{\id_w : w\in \Obj^*\}+ \{\sigma^v_w : v,w\in \Obj^*\}$ using the operations $;$ and $\proptimes$, \emph{quotiented} by the axioms of SMCs. However, the terms of this syntax are very cumbersome to work with and hence we adopt a more convenient way to represent morphisms of $\freeP{\Signature}$, using the graphical notation of \emph{string diagrams}. 

In this view, a morphism $f\from v\to w$ of $\freeP{\Signature}$ is depicted as a $f$-labelled box with a $v$-labelled on the left and a $w$-labelled wire on the right. The operations of composition and monoidal product are represented by connecting two boxes horizontally and juxtaposing two boxes vertically, respectively:
\begin{equation*}\label{eq:composition-monoidal-product}
\tikzfig{comp-sequential-fg}\qquad \quad \tikzfig{comp-parallel-fg}
\end{equation*}
Wires $\tikzfig{id-w}$ represent identities, the wire crossing $\tikzfig{sym-vxw}$ represents the symmetry $\sigma^v_w$, and the empty diagram $\idzero$ the identity $\id_\epsilon\from \epsilon\to \epsilon$.
\begin{definition}\label{c3:def:syntax}
	 We call $\Syn$ the free prop over the signature given by
	\begin{itemize}
		\item two generating objects $\objl$ ("left") and $\objr$ ("right"), with their identity morphisms depicted respectively as $\arrowleft$ and $\arrowright$;
 		\item generating morphisms $
 		\tikzfig{lr-copy}\quad\tikzfig{lr-delete}\quad\tikzfig{lr-merge}\quad\tikzfig{lr-generate} \quad\tikzfig{cap-down} \quad\tikzfig{cup-down}\quad \scalar{a} \quad (a\in \Sigma)$.
 	\end{itemize}
 \end{definition}
Morphisms of $\Syn$ are thus vertical and horizontal composites of the generators above, potentially including wire crossings and identity wires, \emph{up to} the laws of symmetric monoidal categories, listed below:

\begin{equation*}
\begin{gathered}
{\tikzfig{smc/sequential-associativity} \SMCeq \tikzfig{smc/sequential-associativity-1}} \qquad {\tikzfig{smc/parallel-associativity} \SMCeq \tikzfig{smc/parallel-associativity-1}}\\  
{\tikzfig{smc/interchange-law}\SMCeq\tikzfig{smc/interchange-law-1} }
 \qquad
{\tikzfig{smc/unit-right} \SMCeq \diagbox{c}{}{} \SMCeq \tikzfig{smc/unit-left}}
\\
{ \tikzfig{smc/parallel-unit-above} \SMCeq \diagbox{c}{}{} \SMCeq  \tikzfig{smc/parallel-unit-below}}
\qquad
{\tikzfig{smc/sym-natural} \SMCeq \tikzfig{smc/sym-natural-1}}
\\		
{\tikzfig{smc/sym-iso} \SMCeq \tikzfig{id2}}
\end{gathered}
\end{equation*}


 The direction of the arrows on the wires denotes the corresponding object: for example, $\tikzfig{lr-copy}$ represents an operation of type $\objr\to \objr\objr$, while $\tikzfig{cap-down}$ has type $\objl\objr\to \epsilon$. Note that, when we have $n$ parallel wires of the same type, say $\objr$, we depict them as a single directed wire labelled by a natural number label, as $\idright^{\!\!\!\!\!\! n}$. We call \emph{inputs} the incoming wires of a diagram, and \emph{outputs} its outgoing wires; formally, the inputs (resp. outputs) of $f\from v\to w$ are the set of positions of the word $v$ which are $\objr$ (resp. $\objl$) and the position of $w$ which are $\objl$ (resp. $\objr$).
	
	
	\section{Monoidal semantics}\label{sec:semantics}
	
	In order to interpret the string diagrams described in \Cref{c3:sec:monoidal}, we construct an appropriate semantic universe out of regular behaviours. As much as the technical development makes use of category theory, we will keep the description of the formalism high-level. We will write $V_n$ for the set $V_n = \{v_1, \dots, v_n\}\subseteq V$ and $(\Expr/{\sim})(n)$ for the set of all regular behaviours whose live variables are contained in the set $V_n$. For any $m,n \in \N$, we will write $\RegBeh(m,n)$ for the set of $m$-tuples of elements of $(\Expr/{\sim})(n)$. 
	
	For every $n \in N$, we define an identity map $\id_n \in \RegBeh(n,n)$ as $\id_n=\vec{v}_n=(v_1, \dots, v_n)$. When $n$ is clear from the context, we will abuse the notation and simply write $\vec{v}$ instead.

	Given $f \in \RegBeh(m,n)$ and $g \in \RegBeh(n,p)$, we can define their sequential composition $f;g \in \RegBeh(m,p)$ to be given by $(f_1[\vec{g} / \vec{v}], \dots, f_m[\vec{g}/ \vec{v}])$, where $\vec{v}=(v_1, \dots, v_n)$. It turns out that sequential composition is associative, with identity being a neutral element when composed both on the left and right.
 \begin{restatable}{lemma}{regbehcategory}\label{lem:comp_associative}
	Let $f \colon m \to n$, $g \colon n \to p$, $h \colon p \to q$. We have that: 
	\begin{enumerate}
		\item $(f;g);h = f;(g;h)$
		\item $\id_m ; f = f$
		\item $f ; \id_n = f$
	\end{enumerate}	
\end{restatable}
\begin{proof}
	We respectively prove each of the properties. For \circlednum{1} we have the following:
	\begin{align*}
			(f ; g) ; h &= (f_1[\vec{g}/\vec{v}], \dots, f_m[\vec{g}/\vec{v}]);h \\
			&= \left((f_1[\vec{g}/\vec{v}])[\vec{h}, \vec{v}], \dots, (f_m[\vec{g}/\vec{v}])[\vec{h}, \vec{v}]\right)\\
			&= \left(f_1[(g_1[\vec{h}/\vec{v}], \dots, g_n[\vec{h}/\vec{v}])/\vec{v}],\dots, f_m[(g_1[\vec{h}/\vec{v}], \dots, g_n[\vec{h}/\vec{v}])/\vec{v}]\right) \tag{\Cref{lem:subst_lemma}} \\
			&= \left(f_1 [\vec{(g;h)}/\vec{v}], \dots f_m [\vec{(g;h)}/\vec{v}] \right) \\
			&= f ; (g;h)
		\end{align*}
	For \circlednum{2}, we have the following:
	$$id_m ; f = (v_1[\vec{f}/\vec{v}], \dots, v_m[\vec{f}/\vec{v}])=(f_1, \dots, f_m) = f$$
	The proof of \circlednum{3} is similar, as we have the following: $$f ; id_n = (f_1[\vec{v}/\vec{v}], \dots, f_m[\vec{v}/\vec{v}]]) = (f_1, \dots, f_m) = f$$
\end{proof}

Because of the above, we can define a category $\RegBeh$, whose objects are natural numbers and morphisms $f \colon m \to n$ are elements $f \in \RegBeh(m,n)$. 

 For every $n \in \N$, there is a unique element $0_n \in \RegBeh(0,n)$ given by the empty tuple.
 \begin{lemma}
	$0$ is the initial object of $\RegBeh$.
\end{lemma}
\begin{proof}
For each $n \in \N$, there exists a unique empty tuple $0_m \colon 0 \to m$ satisfying that for any $f \colon m \to n$, we have that $0_m ; f = 0_n$.
\end{proof}
 Given $f \in \RegBeh(k,m)$ and $g \in \RegBeh(l,m)$, we define their pairing $\lc f , g \rc \in \RegBeh (k + l,m)$, by setting
 \begin{equation}\label{c3:eqn:mediating}
 	\lc f , g \rc = (f_1, \dots, f_k, g_1, \dots g_l)
 \end{equation} 
 
 $\RegBeh$ can be equipped with binary coproducts, which is defined on objects as addition and the mediating map is given by pairing.
\begin{lemma}
	$\RegBeh$ has binary coproducts. In particular, given $k, l \in \N$, the inclusions $\inl_{k,l} \colon k \to k +l$ and $\inr_{k,l} \colon l \to k + l$ are given by $\inl_{k,l} = (v_1, \dots, v_k)$ and $\inr_{k,l} = (v_{k+1}, \dots, v_{k+l})$ respectively, while the mediating map is given by pairing. 
% https://q.uiver.app/#q=WzAsNCxbMCwwLCJrIl0sWzIsMCwibCJdLFsxLDEsImsrbCJdLFsxLDMsIm0iXSxbMCwyLCJcXGlubCJdLFsxLDIsIlxcaW5yIiwyXSxbMCwzLCJmIiwyXSxbMSwzLCJnIl0sWzIsMywiXFxsYW5nbGUgZiAsIGcgXFxyYW5nbGUiLDEseyJzdHlsZSI6eyJib2R5Ijp7Im5hbWUiOiJkYXNoZWQifX19XV0=
\end{lemma}
\begin{proof}
	Let $f \colon k \to m$ and $g \colon l \to m$. We can safely assume that $f = (f_1, \dots, f_k)$ and $g = (g_1, \dots, g_l)$. Recall that $\inl_{k,l} = (v_1, \dots, v_k)$ and $\inr_{k,l} = (v_{k+1}, \dots, v_{k+l})$. For the existence proof, define $\lc f , g \rc \colon k + l \to m$ as a $k + l$-tuple $(f_1, \dots, f_k, g_1, \dots, g_l)$. We show that that the coproduct diagram from \Cref{eqn:mediating} commutes. We start from the left triangular subdiagram.
%	\[\begin{tikzcd}
%	k && l \\
%	& {k+l} \\
%	\\
%	& m
%	\arrow["\inl_{k + l}", from=1-1, to=2-2]
%	\arrow["f"', from=1-1, to=4-2]
%	\arrow["\inr_{k + l}"', from=1-3, to=2-2]
%	\arrow["g", from=1-3, to=4-2]
%	\arrow["{\lc f , g \rc}"{description}, dashed, from=2-2, to=4-2]
%\end{tikzcd}\]
	\begin{align*}
		\inl_{k,l} ; \lc f , g\rc &= (v_1, \dots, v_k) ; (f_1, \dots f_k, g_1, \dots, g_l) \tag{\Cref{c3:eqn:mediating}}\\
		&= (f_1, \dots, f_k) \\
		&= f
	\end{align*}
	Similarly, for the right subdiagram, we have that:
	\begin{align*}
		\inr_{k,l} ; \lc f , g\rc &= (v_{k +1}, \dots, v_{k + l}) ; (f_1, \dots f_k, g_1, \dots, g_l) \tag{\Cref{c3:eqn:mediating}} \\
		&= (g_1, \dots, g_l) \\
		&= g
	\end{align*}
	For the uniqueness proof, assume that there exists a map $h \colon k + l \to m$, which makes the coproduct diagram commute. We have that $h = (h_1, \dots, h_{k + l})$. 
	Since $\inl_{k,l} ; h = f$ and $\inr_{k,l} ; h = g$, we have that:
	\begin{align*}
		(f_1, \dots, f_k) &= f\\ 
		&= \inl_{k,l} ; h\\
		&= (v_1, \dots, v_k) ; (h_1, \dots, h_{k + l}) \\
		&= (h_1, \dots, h_k)
	\end{align*}
	Similarly, we have that:
	\begin{align*}
		(g_1, \dots, g_l) &= f\\ 
		&= \inr_{k,l} ; h\\
		&= (v_{k+1}, \dots, v_{}) ; (h_1, \dots, h_{k + l}) \\
		&= (h_{k+1}, \dots, h_{k + l})
	\end{align*}
	Hence, $h = (f_1, \dots, f_k, g_1, \dots, g_l) = \lc f , g \rc$ as desired. 
\end{proof}
Given $f \in \RegBeh(k,l)$ and $g \in \RegBeh(m,n)$, we can define their parallel composition $f \oplus g \in \RegBeh(k + m, l + n)$, by setting $$f \oplus g = (f_1, \dots, f_k, g_1[(v_{l + 1},\dots, v_{l + n})/\vec{v}], \dots, g_m[(v_{l + 1},\dots, v_{l + n})/\vec{v}])$$ 
This operation intuitively combines two tuples while systematically renaming variables in $g$ to prevent conflicts with those in $f$. The equation above precisely corresponds to the mapping defined in \Cref{eqn:monoidal} and thus $(\RegBeh, \oplus , 0 )$ is a co-cartesian symmetric monoidal category. Moreover, this monoidal category is strict.
\begin{proposition}
	$(\RegBeh, \oplus , 0 )$ is a strict monoidal category.
\end{proposition}
\begin{proof}
	We verify that associators and unitors are strict equalities. Let $f \in \RegBeh(k,l), g \in \RegBeh(m,n), h \in \RegBeh(o,p)$. For the left unitor, we have the following:
	\begin{align*}
		0 \oplus f &= () \oplus (f_1, \dots, f_k) \tag{def. of $0$ and $\oplus$}\\
		&= (f_1, \dots, f_k) = f
	\end{align*}
	Similarly, for the right unitor, we have that:
	\begin{align*}
		f \oplus 0 &= () \oplus (f_1, \dots, f_k) \tag{def. of $0$ and $\oplus$}\\
		&= (f_1, \dots, f_k) = f
	\end{align*}
	Finally, for the associator we have that:
	\begin{align*}
		 &(f \oplus g) \oplus h\\
		=& (f_1, \dots, f_k, g_1[(v_{l+1}, \dots, v_{l + n})/\vec{v}], \dots, g_m[(v_{l+1}, \dots, v_{l + n})/\vec{v}]) \oplus h \\
		=& (f_1, \dots, f_k, g_1[(v_{l+1}, \dots, v_{l + n})/\vec{v}], \dots, g_m[(v_{l+1}, \dots, v_{l + n})/\vec{v}], \\
		&\qquad\qquad h_1 [(v_{l + n +1}, \dots, v_{l + n + p})/\vec{v}], \dots, h_o [(v_{l + n + 1}, \dots, v_{l + n + p})/\vec{v}])\\
		=& f \oplus  (g_1[(v_{1}, \dots, v_{n})/\vec{v}], \dots, g_m[(v_{1}, \dots, v_{n})/\vec{v}], \\
		&\qquad\qquad h_1 [(v_{n +1}, \dots, v_{n + p})/\vec{v}], \dots, h_o [(v_{n +1}, \dots, v_{n + p})/\vec{v}])\\
		=& f \oplus  (g_1, \dots, g_m, \\
		&\qquad\qquad h_1 [(v_{n +1}, \dots, v_{n + p})/\vec{v}], \dots, h_o [(v_{n +1}, \dots, v_{n + p})/\vec{v}])\\
		=& f \oplus  (g \oplus h)
	\end{align*}
	The intermediate steps in the calculation above follow from the definition of $\oplus$.
\end{proof}



\subsection{$\RegBeh$ as a Conway theory}
We move on to showing that $\RegBeh$ is in fact a Conway theory. For any $f \in \RegBeh(1, p + 1)$, we can define $f^\dagger \in \RegBeh(1,p)$ to be given by $f^\dagger = \mu v_{p+1}.f$.
The dagger defined above satisfies \textbf{scalar parameter identity}.
\begin{lemma}\label{conway1}
	Let $f \colon 1 \to p + 1$, $g \colon p \to q$ be morphisms in $\RegBeh$. Then,
	$$
	(f ; (g\oplus \id_1))^\dagger = f^\dagger ; g
	$$
\end{lemma}
\begin{proof}
\begin{align*}
(f ; (g \oplus \id_1))^\dagger & = (f[(g_1, \dots, g_p, v_{q+1})/(v_1, \dots, v_{p}, v_{p+1})])^\dagger \tag{Def. of $\oplus$}\\
& = \mu v_{q+1}.\big(f[(g_1, \dots, g_p, v_{q+1})/(v_1, \dots, v_{p}, v_{p+1})]\big) \tag{Def. of $\dagger$}\\
& = \mu v_{q+1}.\big(f[v_{q+1}/v_{p+1}][\vec{g}/\vec{v}]\big) \tag{\cite[Lemma~5.6 2.]{Milner:1984:Complete}}\\
& = (\mu v_{q+1}.f[v_{q+1}/v_{p+1}])[\vec{g}/\vec{v}] \tag{\Cref{def:subset}}\\
& = (\mu v_{p+1}.f)[\vec{g}/\vec{v}] \tag{\cite[Proposition~4.6 5.]{Milner:1984:Complete}}\\
& = f^\dagger[\vec{g}/\vec{v}] \tag{Def. of $\dagger$}\\
& = f^\dagger ; g \tag{Def. of sequential composition\hfill\qedhere}
\end{align*}
\end{proof}
To show the remaining identities, we first recall the following lemma.
 \begin{lemma}[{\cite[Theorem~2]{Sewell:1995:Algebra}}]
\label{lem:recursion-substitution}
Terms of Milner's ARB (modulo bisimilarity) satisfy the following rules:
	\begin{enumerate}
		\item $\mu v_z. \left(e [(v_z, v_z) / (v_j, v_k)]\right) = \mu v_j. \mu v_k. e$ for any $v_z$ not free in $e$
		\item $ \mu v_j.\left(e[f/v_j]\right) = e[\mu v_x. \left(f[e/v_j]\right)/v_j]$
	\end{enumerate}
\end{lemma}
We can now establish the \textbf{scalar composition} indentity.
\begin{lemma}\label{conway2}
Let $f,g \colon 1 \to 1 + p$ be morphisms of $\RegBeh$. Then,
		$$
		(f ; \lc  \id_p \oplus 0_1 , g \rc)^\dagger = f ; \lc \id_p, (g ;  \lc  \id_p \oplus 0_1 , f\rc)^\dagger\rc
		$$ 
\end{lemma}
\begin{proof}
\begin{align*}
(f ; \lc  \id_p \oplus 0_1 , g \rc)^\dagger & = \big(f[v_1,\dots,v_p, g/\vec{v}]\big)^\dagger	
\\
& = \mu v_{p+1}.\big(f[v_1,\dots,v_p, g/\vec{v}]\big)
\\
& = \mu v_{p+1}.\big(f[g/v_{p+1}]\big)
\\
& = f[\mu v_{p+1}. \left(g[f/v_{p+1}]\right)/v_{p+1}] \tag{\Cref{lem:recursion-substitution}~2.}
\\
& = f[\mu v_{p+1}. \left(g[v_1,\dots,v_n,f/v_1,\dots,v_n,v_{p+1}]\right)/v_{p+1}]\\
& = f[\mu v_{p+1}. (g ;  \lc  \id_p \oplus 0_1 , f\rc)/v_{p+1}]
\\
& = f[(g ;  \lc  \id_p \oplus 0_1 , f\rc)^\dagger/v_{p+1}]
\\
& = f ; \lc \id_p, (g ;  \lc  \id_p \oplus 0_1 , f\rc)^\dagger\rc \qedhere
\end{align*}
\end{proof}
Similarly, we can show that dagger on $\RegBeh$ satisfies \textbf{scalar double dagger identity}. 
\begin{lemma}\label{conway3}
Let $f \colon 1 \to 2 + p$ be a morphism of $\RegBeh$. Then,
		$$
		f^{\dagger\dagger} = (f ; (\id_p\oplus \nabla_1))^\dagger
		$$
\end{lemma}
\begin{proof}
\begin{align*}
f^{\dagger\dagger} &= \mu v_{p+1}.(\mu v_{p+2}.f)
\\
& = \mu v_{p+1}. \left(f [v_{p+1}, v_{p+1} / v_{p+1}, v_{p+2}]\right) \tag{\Cref{lem:recursion-substitution}~ 1.}
\\
& = \mu v_{p+1}. \left(f;(\id_p\oplus \nabla_1)\right)
\\
& = (f ; (\id_p\oplus \nabla_1))^\dagger \tag{\hfill\qedhere}
\end{align*}
\end{proof}
Combining earlier results yields the following statement.
\begin{restatable}{lemma}{regbehconway}\label{lem:regbehconway}
$\RegBeh$ is a Conway Theory.	
\end{restatable}
\begin{proof}
	Follows from \Cref{conway1}, \Cref{conway2} and \Cref{conway3}.
\end{proof}
We can now combine all the intermediate results into the following statement.
\begin{theorem}
	The category $\RegBeh$ has the following properties:
	\begin{itemize}
		\item $\RegBeh$ has all finite coproducts. 
		\item $(\RegBeh, \oplus, 0)$ is a (co-Cartesian) strict symmetric monoidal category.
		\item $\RegBeh$ equipped with a dagger is a Conway theory~\cite{Esik:1999:Group}.
		\item Each morphism $g \colon p + n \to q + n$ has a trace $\Tr^{n}_{p,q}(g) \colon p \to q$ defined in terms of dagger. This equipment makes $\RegBeh$ into a traced monoidal category~\cite{Joyal:1996:Traced}. 
	\end{itemize}
\end{theorem} 
\subsection{Pseudometric structure on $\RegBeh$}
$\RegBeh$ additionally carries a well-behaved pseudometric structure. For all $m,n \in \N$ each set $\RegBeh(m,n)$ can be made into a pseudometric space by equipping it with a distance function, given by $$d^{m,n}((f_1, \dots, f_m), (g_1, \dots, g_m)) = \sup_{1 \leq i \leq m} \left\{ \mathsf{bd}_{\overline{\partial}}(f_i, g_i) \right\}$$
In the definition above, $\mathsf{bd}_{\overline{\partial}}$ is a behavioural distance associated with the quotient prechart $({\Expr}/{\sim}, \overline{\partial} )$.

Intuitively, we calculate the distance between $m$-tuples of regular behaviours, by taking the pointwise behavioural distance of elements of tuples and then taking the maximum. In the corner case, when both tuples are empty, then they are simply at distance zero. We will show that all categorical operations of $\RegBeh$ defined above are well-behaved with respect to that pseudometric equipment. To do so, we establish a series of technical lemmas. Many of these can be seen as quantitative analogues of congruence results for operations in the syntax of $\Expr$.

First, we show that substitution preserves indexes of relations forming the stratification of bisimilarity.

\begin{lemma}\label{lem:subst-stratified-bisim}
	Let $i_1, \dots, i_m \in \N$. For all $n \in \N$ and for all $e,f,g_1, \dots, g_m, h_1, \dots, h_m \in {\Expr}/{\sim}$, we have that
	\begin{align*}
	&e \sim^{(n)} f \wedge \bigwedge_{j=1}^{j\leq m} g_j \sim^{(n)} h_j\\& \qquad \implies e[(g_1, \dots, g_m)/ (v_{i_1}, \dots v_{i_m})] \sim^{(n)}  f[(h_1, \dots, h_m)/ (v_{i_1}, \dots v_{i_m})] 
	\end{align*}  
\end{lemma}
\begin{proof}


	Base case holds immediately, since we always have that 
	$$e[(g_1, \dots, g_m)/ (v_{i_1}, \dots v_{i_m})] \sim^{(0)}  f[(h_1, \dots, h_m)/ (v_{i_1}, \dots v_{i_m})] 
$$ for all $e,f,g_1, \dots, g_j, h_1, \dots, h_j \in {\Expr}/{\sim}$.
	
	Assume that $e \sim^{(n + 1)} f$, $g_j \sim^{(n + 1)} h_j$ for all $j \in \{1, \dots, m\}$. For the successor case assume that $e[(g_1, \dots, g_m)/ (v_{i_1}, \dots v_{i_m})] \sim^{(n)} f[(h_1, \dots, h_m)/ (v_{i_1}, \dots v_{i_m})]$. We will argue that $$e[(g_1, \dots, g_m)/ (v_{i_1}, \dots v_{i_m})] \sim^{(n + 1)}  f[(h_1, \dots, h_m)/ (v_{i_1}, \dots v_{i_m})]$$ To do so, we will study the operational semantics of both (equivalence classes of) expressions. 
	
		Assume that $e[(g_1, \dots, g_m)/ (v_{i_1}, \dots v_{i_m})] \rhd v_k$. Using \Cref{rem:semantic-substitution}, we can observe that it is the case if any of the following is true: 
		\begin{itemize}
			\item $e \rhd v_k$ and $v_k \notin \{v_{i_1}, \dots v_{i_{j}}\}$ 
			\item $e \rhd v_{i_l}$ for some $v_{i_l} \in \{v_{i_1}, \dots, v_{i_j}\}$ and $g_l \rhd {v_k}$
		\end{itemize}
		Consider the first subcase. Since $e \rhd v_k$ (for some $k \notin \{v_{i_1}, \dots, v_{i_j}\}$) and by assumption $e \sim^{n+1} f$, we have that $f \rhd {v_k}$ and hence $f[(h_1, \dots, h_j)/(v_{i_1}, \dots, v_{i_j})] \rhd v_k$. Now, consider the second subcase. By a similar line of reasoning, we can obtain $f \rhd v_l$ and $h_l \rhd v_k$. Hence, again we have that $f[(h_1, \dots, h_j)/(v_{i_1}, \dots, v_{i_j})] \rhd v_k$. In other words, we have shown that $e[(g_1, \dots, g_m)/ (v_{i_1}, \dots v_{i_m})] \rhd v_k$ implies $f[(h_1, \dots, h_j)/(v_{i_1}, \dots, v_{i_j})] \rhd v_k$. One can easily obtain a reverse implication through a symmetric proof.
		
		Now, assume that  $e[(g_1, \dots, g_m)/ (v_{i_1}, \dots v_{i_m})] \tr{a} s$. Using \Cref{rem:semantic-substitution}, we know that such transition can be made only if any of the following is true:
		\begin{itemize}
			\item $s = e'[(g_1, \dots, g_m)/ (v_{i_1}, \dots v_{i_m})]$, for some $e'$ such that $e \tr{a} e'$
			\item For some $v_{i_l}$, such that $v_{i_l} \in \{v_{i_1}, \dots, v_{i_m}\}$, we have that $e \rhd v_l$ and $g_l \tr{a} s$
		\end{itemize}
		Consider the first subcase. We know that $f \tr{a} f'$ and $e' \sim^{(n)} f'$. Using the induction hypothesis, we can conclude that 
		$$
			e[(g_1, \dots, g_m)/(v_{i_1}, \dots, v_{i_m})] \sim^{(n)} f[(h_1, \dots, h_m)/(v_{i_1}, \dots, v_{i_m})]
		$$
		Hence, there exists a $t$, such that $f[(h_1, \dots, h_m)/(v_{i_1}, \dots, v_{i_m})] \tr{a} t$, such that $s \sim^{(n)} t$.
		
		Now, consider the second subcase. We can easily conclude that $f \rhd v_l$ and $h_l \tr{a} t$, with $s \sim^{(n)} t$.
		
		In other words, we have show that $e[(g_1, \dots, g_m)/ (v_{i_1}, \dots, v_{i_m})] \tr{a} s$, then there exists $t$, such that $f[(h_1, \dots, h_m)/(v_{i_1}, \dots, v_{i_m})] \tr{a} t$, such that $s \sim^{(n)} t$. The reverse implication can be again shown via a symmetric argument. Combining all of the above, we can conclude that
		$$e[(g_1, \dots, g_m)/ (v_{i_1}, \dots, v_{i_m})] \sim^{(n+1)} f[(h_1, \dots, h_m)/(v_{i_1}, \dots, v_{i_m})] \tr{a} t\qedhere$$
\end{proof}
Using the result above, we can show that substitution is in fact nonexpansive.
\begin{corollary}\label{cor:seq_nexp}
	Let $e,f,g_1, \dots , g_m,h_1, \dots, g_m \in {\Expr}/{\sim}$. Then,
	\begin{align*}
		\mathsf{bd}_{\overline{\partial}}&\left(e[(g_1, \dots, g_m/(v_{i_1}, \dots v_{i_m})], f[(h_1, \dots, h_m/(v_{i_1}, \dots v_{i_m})]\right)\\& \leq \max\{\mathsf{bd}_{\overline{\partial}}(e,f),  \max_{j \in \{1, \dots, m\}} \{\mathsf{bd}_{\overline{\partial}}(g_j,h_j)\}\}
	\end{align*}

\end{corollary}
\begin{proof}
If the right hand side of the inequality is equal to zero, then we have that $e \sim f$ and $g_j \sim h_j$ for $j \in \{1, \dots, m\}$. We can use \Cref{lem:congruence}, to conclude that $e[(g_1, \dots, g_m/(v_{i_1}, \dots v_{i_m})] \sim f[(h_1, \dots, h_m/(v_{i_1}, \dots v_{i_m})]$ and hence $\mathsf{bd}_{\overline{\partial}}(e[(g_1, \dots, g_m/(v_{i_1}, \dots v_{i_m})], f[(h_1, \dots, h_m/(v_{i_1}, \dots v_{i_m})]) = 0$, which implies nonexpansivity.
	
If the right hand side is greater than zero, we can employ the characterisation of $\mathsf{bd}_{\overline{\partial}}$ from \Cref{thm:concrete_distance} and use \Cref{lem:subst-stratified-bisim} to conclude the desired result. 
\end{proof}
Finally, we can conclude the following:
\begin{restatable}{lemma}{seqnonexpansive}\label{lem:seq_nonexpansive}
	Sequential composition in $\RegBeh$ is nonexpansive.
\end{restatable}
\begin{proof}
	Let $f,h \in \RegBeh(m,n)$ and $g,i \in \RegBeh(n,k)$. 
	\begin{align*}
		&d^{n,k}(f ;g, h;i)\\
		=& \sup_{1 \leq j \leq n} \left\{ \mathsf{bd}_{\overline\partial} \left(  f_j[(g_1, \dots, g_m)/\vec{v}], h_j[(i_1, \dots, i_m)/\vec{v}] \right)\right\}\\
		\leq & \sup_{1 \leq j \leq n} \left\{\max \left\{\mathsf{bd}_{\overline\partial} (f_j,h_j), \sup_{ 1 \leq l \leq m} \{\mathsf{bd}_{\overline\partial} (g_l, i_l)\}\right\}\right\} \tag{\Cref{cor:seq_nexp}} \\
		=  & \max \{ \sup_{1 \leq j \leq n} \{\mathsf{bd}_{\overline\partial} (f_j,h_j)\}, \sup_{1 \leq j \leq n} \sup_{ 1 \leq l \leq m} \{\mathsf{bd}_{\overline\partial} (g_l, i_l)\}\}  \tag{Interchanging of supremas} \\
		= & \max \{ \sup_{1 \leq j \leq n} \{\mathsf{bd}_{\overline\partial} (f_j,h_j)\}, \sup_{ 1 \leq l \leq m} \{\mathsf{bd}_{\overline\partial} (g_l, i_l)\}\}  \tag{$j$ not mentioned in the second argument}\\
		= & \max \{d^{n,m}(f,h), d^{m,k}(g,i)\} \tag*{\hfill\qedhere}
	\end{align*}
\end{proof}
Similarly to \Cref{lem:subst-stratified-bisim}, $\mu$-recursion interacts well with the stratification of bisimilarity.
\begin{lemma}\label{lem:rec_startified_bisim}
	Let $e, f \in {\Expr}/{\sim_{\partial}}$. Then, for all $n \in \N$, we have that
	$$
	e \sim^{(n)} f \implies \mu v_x. e \sim^{(n)} \mu v_x.f
	$$
\end{lemma}
\begin{proof}
	Base case holds immediately, as $\mu v_x.e \sim^{(0)} \mu v_x.f$ for all $e, f \in {\Expr}/{\sim}$. 
	
	Assume that $e \sim^{(n+1)} f$. For the successor case assume that $\mu v_x . e \sim^{(n)} \mu v_x. f$. We will argue that $\mu v_x . e \sim^{(n+1)} \mu v_x. f$.
	
	Assume that $\mu v_x.e \rhd v_k$. It is only the case, when $e \rhd {v_k}$ and $v_k \neq v_x$. Since $e \sim^{(n+1)} f$, then $f \rhd {v_k}$ and hence $\mu v_x . f \rhd v_k$. In other words, $\mu v_x.e \rhd v_k$ implies $\mu v_x. f \rhd v_k$. The reverse implication can be easily obtained via a symmetric proof.
	
	Now, assume that $\mu v_x.e \tr{a} s$. It is the case, when $e \tr{a} e'$ and $s = e'[\mu v_x.e / v_x]$. Since $e \sim^{(n+1)} f$, then there exists $f'$, such that $f \tr{a} f'$ and $e \sim^{(n)} f$. We can now use induction hypothesis and \Cref{lem:subst-stratified-bisim} and conclude that $e'[\mu v_x. e / v_x] \sim^{(n)} f' [\mu v. f / v_x]$. Moreover, we have that $\mu v.x f \tr{a} f'[\mu v_x.f/v_x]$. Hence, if $\mu v_x.e \tr{a} s$, then there exists $t$, such that $\mu v_x.f \tr{a} t$ and $s \sim^{(n)} t$. A reverse implication can be obtained via a symmetric proof. 
	
	Combing the above, allows us to conclude that $\mu v_x. e \sim^{(n+1)} \mu v_x . f$.
\end{proof}
We can use the above and conclude $\mu$-recursion is nonexpansive.
\begin{corollary}\label{cor:rec_nexp}
	Let $e,f \in {\Expr}/{\sim}$. We have that
	$$
		\mathsf{bd}_{\overline\partial} (\mu v_x.e,\mu v_x.f)\leq \mathsf{bd}_{\overline\partial} (e,f)
	$$
\end{corollary}
\begin{proof}
	Analogous proof to \Cref{cor:seq_nexp}, but utilising \Cref{lem:rec_startified_bisim} instead.
\end{proof}
We now show the following result for the case of prefixing:
\begin{lemma}\label{lem:prefixing_step}
	Let $e,f \in {\Expr}/{\sim}$. Then for all $n \in \N$, $a \in \Sigma$, we have that
	$$
	e \sim^{(n)} f \implies a.e \sim^{(n+1)} a.f 
	$$
\end{lemma}
\begin{proof}
	Both $a.e$ and $a.f$ do not output anything. Now, assume that $a.e \tr{a} e'$. Then, the only possibility is that $e'=e$. We can match that transition with an expression $a.f$ that performs an $a$-labelled transition to $f$. Since $e \sim^{(n)} f$, then $a.e \sim^{(n+1)} a.f$. The remaining condition works through a symmetric line of reasoning. 
\end{proof}
Hence, we obtain that prefixing is contractive.
\begin{restatable}{corollary}{prefixingdiscounts}\label{cor:prefixing_discounts}
	Let $e,f \in {\Expr}/{\sim}$. Then for all $n \in \N$, $a \in \Sigma$, we have that
	$
		\mathsf{bd}_{\overline{\partial}}(a.e,a.f) \leq \frac{1}{2}\mathsf{bd}_{\overline{\partial}}(e,f)
	$
\end{restatable}
\begin{proof}
	We employ the characterisation from~\Cref{thm:concrete_distance}. If $e \sim f$, then by \Cref{lem:congruence} we are done. Otherwise, we have that $\mathsf{bd}_{\overline\partial}(e,f)=2^{-k}$ and $e \sim^{(k)}_{\overline\partial} f$ for some $k \in \N$. By applying~\Cref{cor:prefixing_discounts}, we get that $a.e \sim^{(k+1)} a.f$ and hence $\mathsf{bd}_{\overline\partial}(e,f)\leq 2^{-(k+1)} = \frac{1}{2} 2^{-k} = \frac{1}{2}\mathsf{bd}_{\overline\partial}(e,f)$, as desired. 
\end{proof}
The mediating map of the binary coproduct is also nonexpansive.
\begin{lemma}\label{lem:pairs_nonexpansive}
	Let $f,f' \colon m \to k$, $g,g' \colon n \to k$ be morphisms of $\RegBeh$. We have that $d^{m +n, k}(\lc f, g \rc, \lc f', g' \rc) \leq \max \{d^{m,k}(f,f'), d^{n,k}(g,g')\}$
\end{lemma}
\begin{proof}
	\begin{align*}
		d^{m +n, k}(\lc f, g \rc, \lc f', g' \rc) &= d^{m +n, k}((f_1, \dots, f_m, g_1, \dots, g_n), (f'_1, \dots, f'_m, g'_1, \dots, g'_n)) \\
		&=\max \left\{d^{m,k}((f_1, \dots, f_m), (f'_1, \dots, f'_m)),\right.\\&\qquad \qquad\left. d^{n,k}((g_1, \dots, g_m), (g'_1, \dots, g'_m)) \right\}\\
		&\leq \max \left\{d^{m,k}(f,f'),d^{n,k}(g,g') \right\} \tag*{\hfill\qedhere}
	\end{align*}
\end{proof}
The above allows us to conclude the following:
\begin{restatable}{lemma}{tensnonexpansive}\label{lem:tens_nonexpansive}
	The coproduct in $\RegBeh$ is nonexpansive.
\end{restatable}
\begin{proof}
	Let $f,h \in \RegBeh(k,m)$ and $g,i \in \RegBeh(l,n)$. Given $j \in \N$, such that $1 \leq j \leq l$, we define
	\begin{gather*}
	g'_j = g_j[(v_{m + 1}, \dots, v_{m + n})/(v_1, \dots, v_n)]\\
	i'_j = i_j[(v_{m + 1}, \dots, v_{m + n})/(v_1, \dots, v_n)]
	\end{gather*}
	Using \Cref{cor:seq_nexp} one can easily obtain that for all $j \in \N$, such that $1 \leq j \leq l$, we have that
	\begin{align*}
		\mathsf{bd}_{\overline\partial} (g'_j, i'_j) \leq \mathsf{bd}_{\overline\partial} (g_j, i_j)
	\end{align*}
	Using that fact, we can prove the following
	\begin{align*}
		d^{k + l, m + n}(f \oplus g, h \oplus i) &= d^{k + l, m + n}(\lc f_1, \dots, f_k, g'_1, \dots, g'_l\rc,\lc h_1, \dots, h_k, i'_1, \dots, i'_l\rc)\\
		&=\max \left\{\sup_{1 \leq p \leq k}\{\mathsf{bd}_{\overline\partial} (f_p, h_p)\}, \sup_{1 \leq j \leq l} \{\mathsf{bd}_{\overline\partial} (g'_j, i'_j)\} \right\}\\
		&\leq \max \left\{\sup_{1 \leq p \leq k}\{\mathsf{bd}_{\overline\partial} (f_p, h_p)\}, \sup_{1 \leq j \leq l} \{\mathsf{bd}_{\overline\partial} (g_j, i_j)\} \right\}\\
		&= \max \{d^{k,m}(f,g), d^{l,n}(h,i)\} \tag*{\hfill\qedhere}
	\end{align*}
\end{proof}
Through an inductive argument, we can show the following:
\begin{restatable}{lemma}{daggernexp}\label{lem:dagger_nonexpansive}
	The dagger on $\RegBeh$ is nonexpansive.
\end{restatable}
\begin{proof}
	Let $f,g \colon n \to p + n$ be morphisms in $\mathsf{RefBeh}$. We proceed by induction on $n$. If $n = 0$, then $f^\dagger = f = 0_p = g = g^\dagger$ and hence $d^{0, p}(f^\dagger, g^\dagger) \leq d^{0, p}(f, g)$.
	
	If $n = 1$, then we have the following
	\begin{align*}
		d^{1,p}(f^\dagger, g^\dagger) &= \mathsf{bd}_{\overline\partial} (\mu v_{p+1}.f, \mu v_{p+1}. g)\leq \mathsf{bd}_{\overline\partial} (f, g) \tag{\Cref{cor:rec_nexp}} 
	\end{align*}
	
	Let $n = n' + 1$. Recall, that we can represent $f$ and $g$ in the following way
	\begin{gather*}
		f = \lc f_1, \dots, f_{n'}, f_{n' + 1} \rc = \lc \lc f_1, \dots, f_{n'} \rc , f_{n' + 1}\rc\\
		g = \lc g_1, \dots, g_{n'}, f_{g' + 1} \rc = \lc \lc g_1, \dots, g_{n'} \rc , g_{n' + 1}\rc\qquad
	\end{gather*}
	We can apply the induction hypothesis and obtain the following:
	$$
	d^{n', p + 1}(\lc f_1, \dots, f_{n'}\rc^\dagger, \lc g_1, \dots, g_{n'}\rc^\dagger ) \leq d^{n', n' + p + 1}(\lc f_1, \dots, f_{n'}\rc, \lc g_1, \dots, g_{n'}\rc ) 
	$$
%	For simplicity we will write $m_j$ for the $j$-th component of $\lc f_1, \dots, f_{n'}\rc^\dagger$ and similarly $n_j$ for the $j$-th component of  $\lc g_1, \dots, g_{n'}\rc^\dagger$
	Using it, one can show that:
	\begin{align*}
	d^{p + 1 + n' , p + 1}&\left(\lc\id_{p + 1},\lc f_1, \dots, f_{n'}\rc^\dagger \rc,\lc\id_{p + 1},\lc g_1, \dots, g_{n'}\rc^\dagger\rc \right)\\ &=d^{n', p + 1}(\lc f_1, \dots, f_{n'}\rc^\dagger, \lc g_1, \dots, g_{n'}\rc^\dagger)\\
	&\leq  d^{n', p + 1 + n'}(\lc f_1, \dots, f_{n'}\rc, \lc g_1, \dots, g_{n'}\rc ) 
	\end{align*}
	For the sake of simplicity, define the following:
	\begin{gather*}
	k = f_{n' + 1};\lc\id_{p + 1} ,\lc f_1, \dots, f_{n'}\rc^\dagger\rc\\
	l = g_{n' + 1};\lc\id_{p + 1} ,\lc g_1, \dots, g_{n'}\rc^\dagger\rc
	\end{gather*}
	Using \Cref{cor:seq_nexp} we know that 
	\begin{align*}
	d^{1,p+1}(k,l)&\leq \max\left\{d^{1,p + 1}(f_{n' + 1},g_{n' + 1}),\right.\\&\qquad\qquad\left. d^{p + n', p + 1}\left(\lc\id_{p + 1} ,\lc f_1, \dots, f_{n'}\rc^\dagger\rc,\lc\id_{p + 1} ,\lc g_1, \dots, g_{n'}\rc^\dagger \rc \right) \right\}\\
	&\leq \max \{d^{1,p + 1}(f_{n' + 1},g_{n' + 1}), d^{n', p + 1 + n'}(\lc f_1, \dots, f_{n'}\rc, \lc g_1, \dots, g_{n'}\rc ) \} \\
	&\leq d^{n' + 1, p + 1 + n'}(f,g)
	\end{align*}
	Because of the above, we can use \Cref{cor:rec_nexp} and obtain
	\begin{align*}
		d^{1,p}(k^\dagger, l^\dagger) \leq 	d^{1,p + 1}(k,l) \leq d^{n', p + 1 + n'}(f,g)
	\end{align*}
	Recall the \textbf{scalar pairing identity}, which states that
	\begin{gather*}
	f^\dagger = \lc\lc f_1, \dots, f_{n'}\rc^\dagger ; \lc \id_p ,k^\dagger\rc , k^\dagger\rc \\
	g^\dagger = \lc\lc g_1, \dots, g_{n'}\rc^\dagger ; \lc \id_p, l^\dagger \rc  \rc, l^\dagger\rc
	\end{gather*}
	
	We have the following:
	\begin{align*}
		&d^{n' + 1, p}(f^\dagger, g^\dagger)\\
		\leq & \max \{d^{n', p + 1}(\lc f_1, \dots, f_{n'}\rc^\dagger; \lc \id_p,k^\dagger\rc,\\&\qquad\qquad  \lc g_1, \dots, g_{n'}\rc; \lc \id_p , l^\dagger\rc), d^{1,p}(k^\dagger, l^\dagger)\}\\
		\leq & \max \{d^{n', 1 + p}(\lc f_1, \dots, f_{n'}\rc^\dagger, \lc g_1, \dots, g_{n'}\rc^\dagger),\\&\qquad\qquad  d^{p + 1, p}(\lc id_p , k^\dagger\rc, \lc id_p ,l^\dagger\rc),  d^{1,p}(k^\dagger, l^\dagger) \tag{\Cref{cor:seq_nexp}}\\
		\leq & \max \{d^{n', p + 1}(\lc f_1, \dots, f_{n'}\rc^\dagger, \lc g_1, \dots, g_{n'}\rc^\dagger), d^{1,p}(k^\dagger, l^\dagger)\\
		\leq & \max \{d^{n', p + 1 + n'}(\lc f_1, \dots, f_{n'}\rc, \lc g_1, \dots, g_{n'}\rc ), d^{1,p}(k^\dagger, l^\dagger)\} \tag{Induction hypothesis}\\
		\leq & \max \{d^{n', p + 1 + n'}(\lc f_1, \dots, f_{n'}\rc, \lc g_1, \dots, g_{n'}\rc ),  d^{n' + 1, p + 1 + n'}(f,g)\} \\
		&=  d^{n' + 1, p + 1 + n'}(f,g)
	\end{align*}
	which completes the proof.
\end{proof}
Since the trace on $\RegBeh$ is defined in terms of operations that we have shown to be nonexpansive, we can easily obtain the following result:
\begin{corollary}\label{cor:trace_nonexpansive}
	The trace on $\RegBeh$ is nonexpansive.
\end{corollary}
\begin{proof}
	Immediate consequence of \Cref{thm:trace}, \Cref{lem:seq_nonexpansive} and \Cref{lem:dagger_nonexpansive}.
\end{proof}
\subsection{A category of bidirectional regular behaviours}
 Each morphism $f \colon m \to n$ of $\RegBeh$ can be informally thought of as a process that has \emph{directionality} to it, i.e. it takes $m$ inputs and produces $n$ outputs. Moreover, the trace operator defined on these processes allows to \emph{globally} introduce the notion of feedback. At the same time, the syntax of our diagrammatic language is \emph{bidirectional} and the notion of feedback is introduced \emph{locally} by bending the wires. To reconcile these points of view, we rely on the \textbf{Int} construction~\cite{Joyal:1996:Traced}, which takes a traced monoidal category $\cat{C}$ and completes it into a compact closed category $\Int{\cat{C}}$, a categorical structure with sequential and parallel composition equipped with duals (allowing to swap directionality) and adjoints (allowing to form local loops representing feedback)~\cite{kellylaplaza}. $\Int{\cat{C}}$ carries the same information as $\cat{C}$, but represents it in an alternative, bidirectional way. Furthermore, when looking at the undirected fragment of $\Int{\cat{C}}$, this is precisely the same as the original category $\cat{C}$ of \emph{directional} processes. We now briefly describe $\Int{\RegBeh}$ (see \Cref{c3:subsec:int} for more detail). 
	\begin{itemize}
		\item The objects of $\Int{\RegBeh}$ are pairs $(m,n)$ of natural numbers. 
		\item A morphism $f \colon (k,l) \to (m,n)$, representing a process with $k$ left inputs, $l$ left outputs, $m$ right outputs and $n$ right inputs is a map $f \colon k + m \to l + n$ in $\RegBeh$, i.e. we group inputs and outputs together. Composition of $f \colon (k,l) \to (m,n)$ and $g \colon (m,n) \to (p,q)$ is defined by forming a trace that resolves the feedback involving $m$ and $n$.
		\item The parallel composition of $f \colon (m,n) \to (p,q)$ and $g \colon (m',n') \to (p',q')$ is given by the map $f \otimes g \colon (m + m', n + n') \to (p + p', q + q')$ that is defined via parallel composition in $\RegBeh$ combined with an appropriate reordering of elements of tuples involved.
		\item A dual of the object $(m,n)$ of $\Int{\RegBeh}$ is given by $(n,m)$. Intuitively, inputs become swapped with outputs. For each object $(m,n)$ of $\Int{\RegBeh}$, there is a unit map $\eta_{(m,n)} \colon (0,0) \to (m+n, m+n)$ and counit $\epsilon_{(m,n)} \colon (m+n, m+n) \to (0,0)$. These represent the bending of the wires on the right and left respectively. Appropriate formation of loops using those operations defines a trace on $\Int{\RegBeh}$.
		\item $\Int{\RegBeh}$ inherits the pseudometric structure from $\RegBeh$, by setting $d^{(k,l),(m,n)}$ to be given by $d^{k + n, l +n}$ (defined before).
	\end{itemize}
	The connection between $\RegBeh$ and $\Int{\RegBeh}$ is an instance of the following theorem:
	\begin{theorem}[{\cite[Proposition~5.1]{Joyal:1996:Traced}}]\label{thm:trace_embeds_int}
		There is a full and faithful traced monoidal functor $N \colon \RegBeh \to \Int{\RegBeh}$ that takes each $f \colon n \to m$ in $\RegBeh$ to $f \colon (n,0) \to (m,0)$
	\end{theorem}
	Informally, the theorem above states that on \emph{directional} processes $\Int{\RegBeh}$ is exactly the same as $\RegBeh$. Moreover, the pseudometric structure interacts well with the operations of $\Int{\RegBeh}$.
	\begin{restatable}{proposition}{propnexpint}\label{cor:sem_enriched}
		The sequential and parallel composition in $\Int{\RegBeh}$ is nonexpansive. Moreover, the fully faithful functor $N \colon \RegBeh \to \Int{\RegBeh}$ is locally an isometry, i.e. for all $f,g \colon m \to n$, we have that $d^{m,n}(f,g)=d^{(m,0), (n,0)}(N(f),N(g))$.
	\end{restatable}
	\begin{proof}
		All operations that are used to defined sequential and parallel composition in $\Int{\RegBeh}$ have been shown above to be nonexansive in \Cref{lem:seq_nonexpansive}, \Cref{lem:tens_nonexpansive}, \Cref{cor:trace_nonexpansive}.
		
		For the remaining claim, let $f,g \in \RegBeh(m,n)$. From the definition of $N$, we immediately have that $
		d^{N(m), N(n)}(N(f),(N(g))=d^{m,n}(f,g) $. 
	\end{proof}
	\subsection{Functorial semantics}
	We are ready to state the semantics of our diagrammatic language $\sem{-} \colon \Syn \to \Int{\RegBeh}$ as a symmetric monoidal functor from $\Syn$ to $\Int{\RegBeh}$. Since the syntax is a freely generated prop, in order to interpret arbitrary string diagrams it is enough to just define the interpretation of the generating morphisms of $\Syn$. We have:
	\vspace{-1em}
	\begin{gather*}
	\sem{\tikzfig{lr-copy}}=  N(v_1 + v_2)  \qquad 
	\sem{\tikzfig{lr-delete}} =  N(0)  \qquad
	\sem{\tikzfig{lr-generate}} =  N(()) \\
	\sem{\tikzfig{lr-merge}} = N(\nabla_1) \qquad
	\sem{\scalar{a}} =  N(a.v_1)  \qquad 
	\sem{\tikzfig{cap-down}} = \epsilon_{(1, 0)} \qquad
	\sem{\tikzfig{cup-down}} = \eta_{(1, 0)} \qquad
\end{gather*}


We interpret $\tikzfig{lr-copy}$ as nondeterministic choice, $\tikzfig{lr-delete}$ as the behaviour of the empty chart, while $\tikzfig{lr-generate}$ and $\tikzfig{lr-merge}$ correspond to the empty tuple and joining the variables respectively. For each letter $a \in \Sigma$ of the alphabet, we view $\scalar{a}$ as the prefixing operation. Finally, $\tikzfig{cap-down}$ and $\tikzfig{cup-down}$ are interpreted using counit and unit of $\Int{\RegBeh}$ allowing one to create loops.
\section{Axiomatisation}
\label{sec:axioms}
Our main aim in this chapter is to find a set of (quantitative) equations to reason about semantic distance directly at the level of the diagrams themselves. To do so, we distinguish two different relations on diagrams of the same type:
\begin{itemize}
\item An equational theory intended to capture (strong) bisimilarity of regular behaviours, allowing us to simplify the diagrams whose distance is being compared.
\item A quantitative equational theory intended to capture the behavioural distance of ~\Cref{sec:semantics}, that is the subject of the completeness theorem (\Cref{thm:completeness}) described in \Cref{sec:completeness}. Note that this theory contains the equational axioms as rules for distance zero.
\end{itemize}
\noindent
\textbf{Equational theory. } Our equational theory is the smallest congruence (w.r.t to vertical and horizontal compositions) that includes the axioms of Fig.~\ref{fig:equational-axioms}. In practice, this means that, if we find a sub-diagram that matches one side of an axiom in a larger diagram, we can replace it with the other side of the axiom (the left and right-hand side of any axiom have the same type)~\cite[Section 2.1]{piedeleu2023introduction}. 
%
\begin{figure}[h!]
{ \scriptsize
\begin{gather*}
\begin{align*}
\tikzfig{yanking-bis}\;&\myeq{A1}\;\arrowright \qquad\qquad\tikzfig{yanking}\;\myeq{A2}\;\arrowleft\qquad \qquad
 \tikzfig{co-associativity} \; \myeq{B1} \; \tikzfig{co-associativity-1}\\
  \tikzfig{right-co-unitality} &\myeq{B2} \; \arrowright\qquad\qquad 
\tikzfig{co-commutativity}\; \myeq{B3}\; \tikzfig{large-copy}\qquad\qquad \tikzfig{associativity} \; \myeq{B4} \; \tikzfig{associativity-1}
\\
\tikzfig{right-unitality}\; &\myeq{B5} \; \arrowright \qquad \tikzfig{commutativity}\; \myeq{B6}\; \tikzfig{large-merge} \qquad
\tikzfig{bimonoid}\; \myeq{B7} \;\tikzfig{bimonoid-1}\qquad
\tikzfig{merge-delete}\; \myeq{B8} \;\tikzfig{merge-delete-1}
\\
\tikzfig{copy-co-delete}\; &\myeq{B9} \;\tikzfig{copy-co-delete-1}
\qquad
\tikzfig{idempotence}\; \myeq{B10} \;\arrowright \quad \tikzfig{feedback}\; \myeq{B11} \; \arrowright\quad {\small \tikzfig{co-copy-atom}} \myeq{C1}\: {\small \tikzfig{co-copy-atom-1}}
\end{align*}
\end{gather*}
}
\caption{Equational axioms for regular behaviours.}
\label{fig:equational-axioms}
\end{figure}
%

Axioms \textsf{A1}-\textsf{A2} are those of \emph{compact closed categories}~\cite{kellylaplaza} and allow us to bend and straighten wires at will, only keeping track of their directions. Crucially, they also allow us to manipulate feedback loops. \textsf{B1-B3} encode the fact that $\Bcomult$ and $\Bcounit$ form a \emph{cocommutative comonoid}. These guarantee that nondeterministic choice behaves like a commutative, associative and unital operation in our diagrammatic syntax. At the same time, \textsf{B4-B6} are the dual of the previous three, and make $\Bmult$ and $\Bunit$ into a \emph{commutative monoid}. These guarantee that output wires behave like the variables of our diagrammatic syntax. \textsf{B7}-\textsf{B9} make the previous monoid-comonoid pair into a \emph{bimonoid}, while \textsf{B10} makes nondeterministic choice an idempotent operation. Axiom \textsf{B11} allows us to remove unguarded loops, while \textsf{C1} encodes the fact that merging tuples of variables interacts as expected with prefixing: $(a.v_1, a.v_2);(v_1,v_1) = (a.v_1, a.v_1)$. Note that, if we replace the $\Bmult$ with $\Bcomult$, the resulting equality (prefixes distribute over nondeterministic sum) is not valid.
\begin{restatable}[Soundness]{lemma}{soundnessequality}
For any two diagrams $f,g\from v\to w$ of $\Syn$, if $f=g$ then $\sem{f}=\sem{g}$. 
\end{restatable}
\begin{proof}
	We verify that all equations defining $\Syn$ are satisfied. When dealing with left-to-right diagrams, we will make use of the fact that $\RegBeh$ fully faithfully embeds into $\Int{\RegBeh}$ (\Cref{thm:trace_embeds_int}) and hence it suffices to verify the axioms in $\RegBeh$, rather then in their completion to $\Int{\RegBeh}$. \textsf{(A1)} is satisfied because of the yanking property of trace operation defined on $\RegBeh$, while \textsf{(A2)} is its dual in $\Int{\RegBeh}$ and can be verified similarly. \textsf{(B1)}, \textsf{(B2)} and \textsf{(B3)} are satisfied because $+$ defined on ${\Expr}/{\sim}$ is a commutative monoid with $0$ being its identity. Similarly, \textsf{(B4)}, \textsf{(B5)} and \textsf{(B6)} are satisfied because of the universal property of coproduct on $\RegBeh$ and $\nabla_1$ being the codiagonal morphism. For \textsf{(B8)} we rely on the fact that $\nabla_1 ; \lc v_1 + v_2 \rc = \lc v_1, v_1\rc ; \lc v_1 + v_2 \rc = \lc v_1 + v_2, v_1 + v_2 \rc$. \textsf{(B8)} holds because $\nabla_1 ; \lc  0\rc= \lc v_1, v_1\rc ; \lc 0 \rc = \lc 0, 0 \rc $. 
	\textsf{(B9)} is satisfied because $+$ is idempotent. Finally, \textsf{(B10)} corresponds to taking the dagger of $\lc v_1 + v_2 \rc$ and captures the identity $\mu v_2.(v_1 + v_2) = v_1$ of Milner's Algebra of Regular Behaviours. Finally, \textsf{(C1)} holds, because $\nabla_1 ; \lc a . v_1 \rc = \lc v_1, v_1 \rc ; \lc a. v_1 \rc = \lc a. v_1, a.v_1\rc$.
\end{proof}
\noindent
\textbf{Quantitative theory. } We define $E_q$ as the set of triples of the form $(f, r, g)$, where $f,g$ are string diagrams of the same type and $r \in \Qp$, as the least set closed under the rules of Fig.~\ref{fig:quantitative-axioms}. We will call elements of that set \emph{derivable equations}. 
\begin{figure}[h!]
{
\mprset{vskip=1ex}
\footnotesize
\begin{equation*}
\inferrule{\dbox{f}{m}{n} \disteq{r} \dbox{g}{m}{n}\qquad \vec{a} \in\Sigma^m}{\tikzfig{prefix-f} \disteq{r/2} \tikzfig{prefix-g}}{\mathsf{(Pref)}} 
\qquad 	\inferrule{\diagbox{f}{v}{w} \disteq{r} \diagbox{g}{v}{w}\qquad s \geq r}{\diagbox{g}{v}{w} \disteq{s} \diagbox{f}{v}{w}}{\mathsf{(Max)}}
\end{equation*}
\vspace{1em}
\begin{equation*}
\inferrule{\diagbox{f}{v}{w} = \diagbox{g}{v}{w}}{\diagbox{f}{v}{w}\disteq{0} \diagbox{g}{v}{w}}{\mathsf{(Refl)}}
\qquad
	\inferrule{\diagbox{f}{v}{w} \disteq{r} \diagbox{g}{v}{w}\qquad \diagbox{g}{v}{w} \disteq{s} \diagbox{h}{v}{w}}{\diagbox{f}{v}{w} \disteq{r + s} \diagbox{h}{v}{w}}{\mathsf{(Triang)}}
\end{equation*}
\vspace{1em}
\begin{equation*}
	\inferrule{\left\{\diagbox{f}{v}{w} \disteq{s} \diagbox{g}{v}{w}\right\}_{s > r}}{\diagbox{f}{v}{w} \disteq{r} \diagbox{g}{v}{w}}{\mathsf{(Cont)}}
\qquad
	\inferrule{\diagbox{f}{v}{w} \disteq{r} \diagbox{g}{v}{w}}{\diagbox{g}{v}{w} \disteq{r} \diagbox{f}{v}{w}}{\mathsf{(Sym)}}
\end{equation*}
\vspace{1em}
\begin{equation*}
	\inferrule{\diagbox{f}{u}{v}\disteq{r} \diagbox{h}{u}{v}\qquad \diagbox{g}{v}{w} \disteq{s} \diagbox{i}{v}{w}}{\tikzfig{comp-sequential-fg}  \disteq{\max\{r,s\}} \tikzfig{comp-sequential-hi}}{\mathsf{(Seq)}}\qquad
	\inferrule*[width=20pt]{ }{\diagbox{f}{v}{w} \disteq{1} \diagbox{g}{v}{w}}{\mathsf{(Top)}}
\end{equation*}
\vspace{1em}
\begin{equation*}
	\inferrule{\diagbox{f_1}{v_1}{w_1} \disteq{r} \diagbox{g_1}{v_1}{w_1}\qquad \diagbox{f_2}{v_2}{w_2} \disteq{s} \diagbox{g_2}{v_2}{w_2}}{\tikzfig{comp-parallel-fg}  \disteq{\max\{r,s\}} \tikzfig{comp-parallel-hi}}{\mathsf{(Tens)}}
	\qquad
	\inferrule{\qquad}{\;\Bunitn{n} \;\disteq{0}\; \tikzfig{co-del-d}\;}{\mathsf{(Codel)}}
\end{equation*}
%\vspace{1em}
%\begin{equation*}
%\inferrule{\dbox{f}{m}{n} \disteq{\varepsilon} \dbox{g}{m}{n}\qquad \vec{a} \in\Sigma^m}{\tikzfig{prefix-f} \disteq{\epsilon/2} \tikzfig{prefix-g}}{\mathsf{(Pref)}} 
%\end{equation*}
}
\caption{Quantitative axioms for regular behaviours.}
\label{fig:quantitative-axioms}
\end{figure}
For any two diagrams $f,g\from v\to w$ of $\Syn$, we say a quantitative equation $f\disteq{r} g$ is \emph{valid} if $d^{\sem{v},\sem{w}}(\sem{f}, \sem{g}) \leq r$. Analogously, an inference rule is valid if, whenever all quantitative equations in the premise are valid, then the equation in the conclusion in the equation is also valid. We now briefly explain each of the rules of our inference system depicted on \Cref{fig:quantitative-axioms}. \textsf{(Refl)}, \textsf{(Sym)} and \textsf{(Triang)} respectively capture reflexivity, symmetry and triangle inequality of pseudometric spaces. Importantly, rule \textsf{(Refl)} allows one to state that equal diagrams (modulo strictly equational rules described above) are at distance zero of each other. \textsf{(Top)} allows us to state that any two diagrams are at most within distance $1$ of each other, while \textsf{(Max)} allows one to always weaken the bound on the distance at which two diagrams are.  \textsf{(Cont)} is the key analytic inference rule here: it allows us to conclude that two diagrams are within distance $r$, provided we can show that they are within all distances that are strictly greater than $r$, thereby passing to the limit. Next, \textsf{(Seq)} and \textsf{(Tens)} relate the horizontal and vertical compositions of diagrams to the distance. There are two domain-specific rules that we use. \textsf{(Pref)} witnesses the fact that prefixing by the same actions decreases the distance by half. Note that it applies to diagram $\objr^m\to\objr^n$ and that we use $\tikzfig{m-a-m}$ to denote the vertical composition of $m$ many $\scalar{a}$ generators, for any $m\in\mathbb{N}$. \textsf{(Codel)} axiom encodes that any diagram with no initial state has no behaviour and is therefore at distance zero of the empty chart.

Through a straightforward argument, one can show the soundness of the proposed quantitative rules.
\begin{lemma}\label{lem:soundness_sublemma}
		All the inference rules defining the distance on $\Syn$ are satisfied in $\Int{\RegBeh}$.
	\end{lemma}
	\begin{proof}
		For most of the rules, the proof is straightforward. The soundness of \textsf{(Top)} follows from the fact that the distance on morphisms of $\Int{\RegBeh}$ is $1$-bounded, while \textsf{(Max)} captures the transitivity of partial order on the rational numbers. \textsf{(Refl)}, \textsf{(Sym)} and \textsf{(Triang)} are satisfied because the distance function on each hom-set of $\Int{\RegBeh}$ is a pseudometric space. \textsf{(Cont)} captures the Cauchy completeness of reals, while \textsf{(Seq)} and \textsf{(Tens)} are immediate consquence of \Cref{cor:sem_enriched}. For the remaining two rules, we will make use of the fact that the fully faithful embedding $N \colon \RegBeh \to \Int{\RegBeh}$ is an isometry (\Cref{cor:sem_enriched}), hence for the left-to-right diagrams it suffices to check the rules in $\RegBeh$. The soundness of \textsf{(Pref)} is an immediate consequence of \Cref{cor:prefixing_discounts}. Finally, \textsf{(Codel)} follows from the uniqueness of maps from the initial object in $\RegBeh$.
		\end{proof}
		Through a simple inductive argument, we can extended the above to any derivable equation.
\begin{theorem}[Quantitative soundness]\label{c3:thm:soundness}
Every derivable equation $f \disteq{r} g$ is valid.
\end{theorem}
\begin{proof}
	Induction on the length of derivation and \Cref{lem:soundness_sublemma}.
\end{proof}
\begin{example}
We revisit the charts from \Cref{fig:intro} and axiomatically show that their distance is bounded by $\frac{1}{4}$. We use compositionality to our advantage and break them into two parts which we will compose later with the \textsf{(Comp)} rule. First, we have\\
	{
\circlednum{1}
\scalebox{0.58}{
\ensuremath{
\inferrule*[Right={\textsf{(Refl;Triang)}}]{
\inferrule*[Right={\textsf{(Comp)}}]{
\inferrule*[Right={\textsf{(Pref)}}]{
\inferrule*[Right={\textsf{(Refl;Triang)}}]{
\inferrule*[Right={\textsf{(Comp)}}]{
\inferrule*[Right={\textsf{(Pref)}}]{
\inferrule*[Right={\textsf{(Top)}}]{ }{
\tikzfig{delete-zero} \disteq{1} \tikzfig{a-star}}}
{\tikzfig{a-zero} \disteq{1/2} \tikzfig{a-a-star}}}
{\tikzfig{copy-a-delxid}\;\myeq{B6;B5}\;\tikzfig{copy-a-zeroxid-merge} \disteq{1/2} \tikzfig{a-star-unroll} \;\myeq{Unroll}\; \tikzfig{a-star} }}
{\tikzfig{copy-a-delxid} \disteq{1/2} \tikzfig{a-star}}}
{\tikzfig{a-copy-a-delxid} \disteq{1/4} \tikzfig{a-a-star}}}
{\tikzfig{ex-diag-1-l}\;\myeq{C1}\;\tikzfig{ex-diag-1-l-alt} \disteq{1/4} \tikzfig{a-star-unroll-b}\;\myeq{Unroll}\;\tikzfig{a-star-b} }}
{\tikzfig{ex-diag-1-l} \disteq{1/4} \tikzfig{a-star-b}}
}
}
}

In the rules labelled with $(\mathsf{Refl};\mathsf{Triang})$ we have used the strict equality of diagrams to simplify the quantitative equations. The equalities marked with \textsf{(Unroll)} follow from \Cref{lem:unroll}, which we state in the next section. Then, for the second part of our diagrams, we can show \circlednum{2}, as depicted below.\\
{
\begin{minipage}{.65\textwidth}
\circlednum{2}\\
	\scalebox{0.7}{
\ensuremath{
\inferrule*[Right={\textsf{(Refl;Triang)}}]{
\inferrule*[Right={\textsf{(Refl;Triang)}}]{
\inferrule*[Right={\textsf{(Pref)}}]{
\inferrule*[Right={\textsf{(Top)}}]{ }{
\tikzfig{ex-diag-1-r}\disteq{1} \tikzfig{ex-diag-2-r}}}
{\tikzfig{a-ex-diag-1-r}\disteq{1/2} \tikzfig{a-ex-diag-2-r}}}
{\tikzfig{ex-diag-1-r}\;\myeq{C1}\;\tikzfig{a-ex-diag-1-r-alt}\disteq{1/2} \tikzfig{a-ex-diag-2-r-alt}}}
{\tikzfig{ex-diag-1-r}\disteq{1/2} \tikzfig{ex-diag-2-r}}
}}
\end{minipage}
\begin{minipage}{.34\textwidth}
	\circlednum{3}\quad
	\scalebox{0.7}{\ensuremath{\tikzfig{ex-diag-1-r}\disteq{r} \tikzfig{ex-diag-2-r}}}\\
	\vspace{0.5em}
	\\
	\circlednum{4}\quad
	\scalebox{0.7}{\ensuremath{\tikzfig{ex-diag-1-r}\disteq{0} \tikzfig{ex-diag-2-r}}}\\
\end{minipage}
}

Then, using the same reasoning, we can show \circlednum{3} for $r = 1/2^n$ for any $n\in\mathbb{N}$, and thus for any $r>0$. Finally, the \textsf{(Cont)} rule allows us to conclude \circlednum{4}. Finally, combining \circlednum{1} and \circlednum{4} together with the \textsf{(Comp)} rule, allows us to recover the equality we wanted to show:
$$
\tikzfig{ex-diag-1}\disteq{1/4} \tikzfig{ex-diag-2}
$$
\end{example}
\section{Completeness}
\label{sec:completeness}
We finally arrive at the main technical section of the chapter, where we gradually present a sequence of results leading to the completeness of our axioms for the behavioural distance. First, we show that we can safely focus solely on $\objr^m \to \objr^n$ diagrams. Then, through an analytic proof relying on \textsf{(Cont)} rule, we show that each diagram can be \emph{co-copied}. Consequently, we can decompose any $\objr^m \to \objr^n$ diagram into a collection of $\objr \to \objr^n$ diagrams, which correspond to individual charts. We argue that each of those $\objr \to \objr^n$ diagrams has a normal form from which one can extract a finite prechart structure. It turns out that the distance between states of this prechart precisely captures the distance between the diagrams being related and very importantly, admits a simple characterisation that can be simulated through the inference rules of our system, eventually leading to the completeness result.
\subsection{Left-to-right diagrams} 
The following result allows us to turn any bidirectional diagram into a left-to-right one by appropriately \emph{bending} the the wires using $\tikzfig{cap-down}$ and $\tikzfig{cup-down}$. We will see later that this process does not change distances between diagrams. 
\begin{restatable}{lemma}{compact}\label{lem:compact}
There are bijections between the sets $\Syn(v_1\!\objl\! v_2,w)$ and $\Syn(v_1v_2,w\!\objr)$, and between $\Syn(v,w_1\!\objl\! w_2)$ and $\Syn(v\!\objr,w_1w_2)$, \emph{i.e.} between sets of string diagrams of the form
$$
\tikzfig{wrong-way-left}\;\text{ and }\; \tikzfig{right-way-right}$$
as well as between
$$ \tikzfig{wrong-way-right}\;\text{ and }\; \tikzfig{right-way-left} 
$$
where $v,w, v_i, w_i$ are words over $\{\objr,\objl\}$.
\end{restatable}
\begin{proof}
The lemma holds in any compact closed category and relies on the ability to bend wires using $\tikzfig{cap-down}$ and $\tikzfig{cup-down}$. Explicitly, given a diagram of the first form, we can obtain one of the second form as follows:
\begin{equation*}
\tikzfig{wrong-way-left}\quad \mapsto\quad \tikzfig{bent-wires}
\end{equation*}
The inverse mapping is given by the same wiring with the opposite direction. That they are inverse transformations follows immediately from the defining axioms of compact closed categories (A1-A2). 
\begin{equation*}
 \tikzfig{bent-wires} \quad\mapsto\quad  \tikzfig{unbent-wires} \myeq{A1} \tikzfig{wrong-way-left}
\end{equation*}
The other bijection is constructed analogously. 
\end{proof}
Intuitively, Lemma~\ref{lem:compact} tells us that we can always bend incoming wires to the left and outgoing wires to the right to obtain a $\objr^m\to\objr^n$ diagram from any given diagram.
Let $S(f)\from\objr^m\to\objr^n$ be the diagram obtained by applying the bijections of Lemma~\ref{lem:compact} to a diagram $f\from v\to w$ until all the objects occurring in its domain and codomain are $\objr$. 
\begin{lemma}\label{lem:right-to-right}
Given two diagrams $f,g\from v\to w$, $S(f)=S(g)$ iff $f=g$. 
\end{lemma}
\begin{proof}
The idea is that, if $S(f)=S(g)$, we can always show that $f=g$ using a similar derivation, by simply applying the transformation of Lemma~\ref{lem:compact} before using the derivation that $S(f)=S(g)$, and then recover the original orientation of the wires by bending them back into their original place afterwards; and the same idea applies to show that $f=g$ implies $S(f)=S(g)$. 
\end{proof}
A \emph{block} is simply a diagram freely composed from a restricted set of generators (possibly including identities and symmetries). In this chapter, we will make use of two special kinds of diagrams that can be factored into blocks:
\begin{itemize}
	\item A \emph{matrix-diagram} is a diagram $\objr^m\to\objr^n$ that factors as a composition of a block of $\tikzfig{lr-copy}, \tikzfig{lr-delete}$, another of $\scalar{a}$ for $a\in \Sigma$, and a last one of $\tikzfig{lr-merge}, \tikzfig{lr-generate}$. A matrix-diagram is \emph{guarded} when any path from left to right port encounters at least one $\scalar{a}$. 
	\item A \emph{relation-diagram} is a diagram $\objr^m\to\objr^n$ that factors as a composition of a block of $\tikzfig{lr-copy}, \tikzfig{lr-delete}$ followed by the block of $\tikzfig{lr-merge}, \tikzfig{lr-generate}$.
\end{itemize} 
\begin{lemma}\label{lem:matrix-cocopy}
For any matrix-diagram $d\from \objr^m\to \objr^n$, we have
\begin{align*}
\tikzfig{global-merge}\quad = \quad \tikzfig{global-merge-1}
\end{align*}
\end{lemma}
\begin{proof}
See~\cite[Lemma 4.9]{piedeleu2023finite} (\textsf{co-cpy}). It is a simple  structural induction. For the base cases, all the generators of matrix-diagrams satisfy the equality of the lemma, by axioms \textsf{(B5)}, \textsf{(B7)},\textsf{(B8)}, and \textsf{(C1)}. The inductive cases are straightforward.
\end{proof}
Now, we show that one can generalise \textsf{(Pref)} inference rule to arbitrary guarded matrix-diagrams, rather than just vectors of $\scalar{a}$. In other words, prepending a guarded matrix-diagram to any pair of diagrams contracts the distance between them. 
\begin{lemma}\label{lem:guarded-precompose}
For any guarded matrix-diagram $c\from \objr^\ell\to\objr^m$ and any two diagrams $d_1,d_2\from \objr^m\to\objr^n$ such that
\[\dbox{d_1}{m}{n}\disteq{r}\dbox{d_2}{m}{n}\]
we have
\[\tikzfig{c-d1}\disteq{r/2}\tikzfig{c-d2}\]
\end{lemma}
\begin{proof}
We rely on the definition of guarded matrix diagrams. Recall that since $c$ is guarded, we can factor it as
\[\dbox{c}{\ell}{m} = \tikzfig{matrix-diagram-blocks}\]
where $c_0$ is a diagram composed only of $\Bcomult,\Bcounit$, $\vec{a}$ is a vertical composite of $k$ $\scalar{a_i}$ generators, and $c_1$ is a diagram composed only of $\Bmult,\Bunit$. Hence,
{
\begin{equation*}
\scalebox{0.75}{
	\inferrule{
	\inferrule{
	\inferrule{
	\dbox{d_1}{m}{n}\disteq{r}\dbox{d_2}{m}{n}\\ \dbox{c_1}{k}{m}\disteq{0}\dbox{c_1}{k}{m}}{\tikzfig{c1-d1}\disteq{r} \tikzfig{c1-d2} \\ \vec{a}\in\Sigma^k}{\textsf{(Seq)}}}
	{\tikzfig{prefix-c1-d1}\disteq{r/2} \tikzfig{prefix-c1-d2} \qquad \dbox{c_0}{k}{m}\disteq{0}\dbox{c_0}{k}{m}}{\textsf{(Pref)}}}{\tikzfig{c0-prefix-c1-d1}\disteq{r/2} \tikzfig{c0-prefix-c1-d2}}{\textsf{(Seq)}}}
\end{equation*}
}
The last line is what we wanted to show.
\end{proof} 

Intuitively, matrix-diagrams are representations of labelled transition relations, while relation-transition diagrams are representations of the output relations. This idea can be captured formally through the notion of a \emph{representation}. For a diagram $d\from \objr^m\to \objr^n$, a \emph{representation} is a pair $(a,o)$ of a guarded matrix-diagram $c\from \objr^{\ell+m}\to \objr^{\ell+m}$ and a relation-diagram $o\from \objr^{\ell+m}\to \objr^n$, such that
\begin{equation}\label{eq:rep}
\scalebox{0.9}{
\dbox{d}{m}{n} \; = \; \tikzfig{automata-rep-star}\; := \;\tikzfig{automata-rep}
}
\end{equation} 
\noindent
Using the rules for strict equality, we can rearrange the any diagram into the form described above.
\begin{restatable}{theorem}{representation}
\label{thm:representation}
Any diagram $\objr^m\to \objr^n$ has a representation.
\end{restatable}
\begin{proof}
The proof is the same as~\cite[Proposition 4.7]{piedeleu2023finite}. All axioms used in that proof are in our theory.
\end{proof}
The matrix-diagram in the representation that is being fed through feedback, can be \emph{unrolled}.
\begin{restatable}{lemma}{unrolling}\label{lem:unroll}
For any matrix-diagram $d\from \objr^n\to \objr^n$, we have


\[\tikzfig{d-star} \;= \; \tikzfig{d-star-unroll}\]
\end{restatable}
\begin{proof}
\begin{align*}
\tikzfig{d-star} & \myeq{B7} \tikzfig{d-star-1}\\
&\myeq{A1} \tikzfig{d-star-2}\\
& \myeq{SMC} \tikzfig{d-star-3}\\
&\myeq{A1} \tikzfig{d-star-4}\\
&\myeq{Lemma~\ref{lem:matrix-cocopy}} \tikzfig{d-star-5}\\
& \myeq{A1} \tikzfig{d-star-unroll}
\end{align*}
\end{proof}
\subsection{Co-copying}
It turns out that bringing each diagram to a form corresponding to its representation, combined with the usage of unrolling (\Cref{lem:unroll}) and generalisation of \textsf{(Pref)} to guarded matrix-diagrams (\Cref{lem:guarded-precompose}) allows to show that the following two diagrams are arbitrarily close and hence by \textsf{(Cont)} are in zero distance
\begin{restatable}{theorem}{globalcocopy}
\label{thm:co-copy-delete}
For any diagram $d\from \objr^m\to \objr^n$, we have that 

\[
\tikzfig{global-merge}\quad \disteq{0} \quad \tikzfig{global-merge-1}
\]
\end{restatable}
\begin{proof}
First, by \Cref{thm:representation}, we can find a matrix-diagram, $a\from \objr^{\ell+m}\to \objr^{\ell+m}$ and a relation-diagram $o\from \objr^{\ell+m}\to \objr$ such that
\[\dbox{d}{m}{n} \; = \;\tikzfig{automata-rep}\] 
We will show that 
\[\tikzfig{c-star-o-merge}\quad\disteq{0}\quad\tikzfig{merge-c-star-o}\]
from which the statement of the lemma immediately follows, by pre-composing with $\tikzfig{lr-generate}$. Since $c\from m+\ell\to m+\ell$ is a guarded matrix-diagram, so is
\[\tikzfig{cxc}\]
Therefore, by Lemma~\ref{lem:guarded-precompose}, we get
{
\small
\[\tikzfig{prefix-c-star-o-merge} \quad\disteq{1/2}\quad\tikzfig{prefix-merge-c-star-o} \]
}
and thus, 
\begin{align*}
\tikzfig{unroll-c-star-o-merge}\\
\qquad \disteq{1/2}\;\quad\tikzfig{unroll-merge-c-star-o}
\end{align*}
We also have
\begin{align*}
&\qquad\tikzfig{unroll-merge-c-star-o}\\
&\disteq{0}\quad\tikzfig{unroll-merge-c-star-o-1}\\
&\disteq{0} \;\tikzfig{unroll-merge-c-star-o-2}\\
&\disteq{0} \;\tikzfig{unroll-merge-c-star-o-3}
\end{align*}
where the last step uses Lemma~\ref{lem:matrix-cocopy} and \textsf{(Refl)} to merge the two occurrences of the matrix-diagram $c$. Resuming, we get
\begin{align*}
&\qquad\tikzfig{unroll-merge-c-star-o-3}\\
& \disteq{0} \;\tikzfig{unroll-merge-c-star-o-4} \\
& \disteq{0} \;\tikzfig{unroll-merge-c-star-o-5}\\
&\disteq{0} \;\tikzfig{merge-c-star-o}
\end{align*}
We can show in the same way that
{
\footnotesize
\[\tikzfig{unroll-c-star-o-merge}\;\disteq{0}\;  \tikzfig{c-star-o-merge}\]
}
Thus, we have shown that 
\[\tikzfig{c-star-o-merge}\quad\disteq{1/2}\quad\tikzfig{merge-c-star-o}\]
In the same way, we can show that 
\[\tikzfig{c-star-o-merge}\quad\disteq{2^{-n}}\quad\tikzfig{merge-c-star-o}\]
for any $n\in\N$ and thus, by the continuity axiom \textsf{(Cont)}, we conclude that
\[\tikzfig{c-star-o-merge}\quad\disteq{0}\quad\tikzfig{merge-c-star-o}\]
as we wanted to show.
\end{proof}
A very important consequence of the above combined with the usage of \textsf{(Codel)} rule is the fact that each $\objr^m\to \objr^n$ diagram can be separated to a collection of $\objr\to \objr^n$ intuitively corresponding to individual entries of tuples being manipulated in $\RegBeh$.
\begin{lemma}
\label{lem:injections}
Let  $f\from \objr^m\to \objr^n$ and define $f_i$ to be the diagram $\objr\to \objr^n$ obtained by composing all but the $i$-th input of $f$ with $\Bunit$ (co-deleting all inputs except the $i$-th one). We have that
\[\dbox{f}{m}{n} \;\disteq{0} \;\tikzfig{d-decomposition}\]
\end{lemma}
The semantics of those diagrams is precisely given by pairing:
\begin{lemma}\label{lem:merge-repr}
	Let $e,f\from\objr\to\objr^n$, such that $\sem{e} = N(s)$ and $\sem{f} = N(d)$, where $s, t \in \RegBeh(1,n)$. We have that
	\begin{align*}
		\sem{\tikzfig{merge-cxd}} &= N \left( \lc s, t \rc\right )
	\end{align*}
\end{lemma}
\begin{proof}
	\begin{align*}
		\sem{\tikzfig{merge-cxd}} &=(N(s)\oplus N(f)); N(\nabla_1) \\
		&= N((s \oplus t) ; \nabla_1 ) \tag{Functoriality of $N$}\\
		&= N( \lc s,t[v_2/v_1] \rc ; \lc \id_1, \id_1\rc )\\
		&=N( \lc s , t \rc ) \qedhere
	\end{align*}
\end{proof}
Hence, behavioural distance between the denotations of arbitrary diagrams $f,g \colon \objr^m \to \objr^n$ is simply the maximum of the component-wise distances between each $f_i$ and $g_i$ for $i \in \{1, \dots, m\}$.
\begin{lemma}\label{lem:distance_on_merge}
	Let $e_1, e_2, f_1,f_2 \colon \objr \to \objr^n$. We have that
	\begin{align*}
		&d^{N(2),N(n)}\left(\sem{\tikzfig{merge-cxd-1}}, \sem{\tikzfig{merge-cxd-2}}\right)\\& \quad= \max \left\{d^{N(1),N(n)}\left(\sem{\dbox{e_1}{}{n}},\sem{\dbox{e_2}{}{n}} \right),\right.\\&\qquad\qquad\left. d^{N(1),N(n)} \left(\sem{\dbox{f_1}{}{n}}, \sem{\dbox{f_2}{}{n}} \right)\right\}
	\end{align*}
\end{lemma}
\begin{proof}
	Since $e_1, e_2, f_1,f_2$ are left-to-right diagrams, we can safely assume that there exist $s_1, s_2, t_1, t_2 \in \RegBeh(1,n)$ such that $\sem{c_1} = N(s_1)$,$\sem{c_2} = N(s_2)$,$\sem{d_1} = N(t_1)$. We have the following
	\begin{align*}
		&d^{N(2),N(n)}\left(\sem{\tikzfig{merge-cxd-1}}, \sem{\tikzfig{merge-cxd-2}}\right)\\
		&\qquad = d^{N(2),N(n)}(N(\lc e_1, f_1 \rc), N\lc e_2, f_2 \rc)\tag{\Cref{lem:merge-repr}}\\
		&\qquad = d^{2,n}(\lc e_1, f_1 \rc, \lc e_2, f_2 \rc)\tag{\Cref{cor:sem_enriched}}\\
		&\qquad= \max \{\mathsf{bd}_{\overline \partial} (e_1, e_2), \mathsf{bd}_{\overline \partial} (f_1, f_2)\}\tag{Def. in distance of $\RegBeh$}\\
		&\qquad = \max \{d^{1,n}(e_1, e_2), d^{1,n}(f_1, f_2)\}\\
		&\qquad = \max \{d^{N(1), N(n)}(N(e_1), N(e_2)), d^{N(1), N(n)}(N(f_1), N(f_2))\}\tag{\Cref{lem:merge-repr}}\\
		&\qquad = \max \left\{d^{N(1),N(n)}\left(\sem{\dbox{e_1}{}{n}},\sem{\dbox{e_2}{}{n}} \right),\right.\\&\qquad\qquad\qquad\left. d^{N(1),N(n)} \left(\sem{\dbox{f_1}{}{n}}, \sem{\dbox{f_2}{}{n}} \right)\right\}\
	\end{align*}
	This concludes the proof.
\end{proof}
From now on, we will temporarily shift focus to $\objr \to \objr^n$ diagrams.

\noindent
\subsection{One-to-n diagrams}
Each of the $\objr \to \objr^n$ diagrams represents a behaviour of the single state of the prechart structure on ${\Expr}/{\sim}$ or equivalently, defines a chart. Turns out that appropriately combining these diagrams corresponds to operations of ARB described in \Cref{c3:sec:preliminaries}.  
\begin{restatable}{lemma}{sumconvolutions}\label{lem:sum-convolution}
For any two $c,d\from\objr\to\objr^n$, we have that
\[
\sem{\tikzfig{convolution-cxd}} = \sem{e} + \sem{f}\]
\end{restatable}
\begin{proof}
First, since $c$ and $d$ are left-to-right, there exists expressions $s,t\in\RegBeh(1,n)$, such that $\sem{c} = N(s)$ and $\sem{d} = N(t)$. Then,
%TODO: Fix formatting, line break + qedhere
\begin{align*}
&\sem{\tikzfig{convolution-cxd}}\\ 
&\qquad = \sem{\Bcomult}; (\sem{c}\oplus \sem{d});\sem{\Bmult}
\\
&\qquad = N(v_1+v_2) ; (N(s)\oplus N(f)) ;  N(\nabla_1) & 
\\
&\qquad = N((v_1+v_2); (s\oplus f); \nabla_1) & (\text{Functoriality of $N$})
\\
&\qquad = N(s+f) & (\text{Definition of $N$})
\\
&\qquad = N(s) + N(t) = \sem{c} + \sem{d} \qedhere
\end{align*}

\end{proof}
This operation of combining two $\objr \to \objr^n$ string diagrams (that we call \emph{convolution}) can easily be extended to any finite collection of $\objr \to \objr^n$ diagrams. Let $F = \{f_i \colon \objr \to \objr^n\}_{i \in I}$ be an indexed collection of string diagrams. Given a finite indexed collection $A = \{f_{i_1}, \dots, f_{i_k}\}_{k \in K} \subseteq F$ of string diagrams from the set $F$, we define its convolution to be the string diagram $R_A \colon \objr \to \objr^n$ given by
	$$
	\tikzfig{set-repr}
	$$ 
	The above is well defined up to permutations and removing duplicates, while staying at distance zero. Hence, given a finite subset of $F$ we can unambiguously talk about its convolution.
\begin{lemma}
\label{lem:convolution-aci}
Any two finite indexed collections $A = \{f_{i_1}, \dots, f_{i_k}\}_{k \in K}$ and $B = \{g_{i_1}, \dots, g_{i_k}\}_{k \in K}$ that are equal as sets, then their convolution are at distance zero from each other.
\end{lemma}
\begin{proof}
It is enough to show that the convolution of two string diagrams is an associative, commutative and idempotent operation (up to $\disteq{0}$).
\begin{description}
\item[Associativity:] For any $f_1,f_2$, and $f_3$, we have
\begin{align*}
&\qquad\tikzfig{convolution-assoc}\\
&= \tikzfig{convolution-assoc-1}\\
& = \tikzfig{convolution-assoc-2}
\end{align*}
\item[Commutativity:]
\begin{align*}
\tikzfig{convolution-commut} &= \tikzfig{convolution-commut-1}
\\
& = \tikzfig{convolution-commut-2}
\\
& = \tikzfig{convolution-commut-3}
\end{align*}
\item[Idempotence:]
\begin{align*}
\tikzfig{convolution-idemp} &\disteq{0} \tikzfig{convolution-idemp-1} \tag{\Cref{thm:co-copy-delete}}
\\
& = \dbox{f_1}{}{n} \tag*{\hfill\qedhere}
\end{align*}
\end{description}
\end{proof}
\sumconvolutions*
\begin{proof}
First, since $c$ and $d$ are left-to-right, there exists expressions $s,t\in\RegBeh(1,n)$, such that $\sem{c} = N(s)$ and $\sem{d} = N(t)$. Then,
\begin{align*}
\sem{\tikzfig{convolution-cxd}} & = \sem{\Bcomult}; (\sem{c}\oplus \sem{d});\sem{\Bmult}
\\
& = N(v_1+v_2) ; (N(s)\oplus N(f)) ;  N(\nabla_1) & 
\\
& = N((v_1+v_2); (s\oplus f); \nabla_1) \tag{{Functoriality of $N$}}
\\
& = N(s+f) \tag{{Definition of $N$}}
\\
& = N(s) + N(t) = \sem{c} + \sem{d} \tag*{\hfill\qedhere}
\end{align*}

\end{proof}
If a diagram is in the representation normal form we can express each the subdiagrams $f_i \colon \objr \to \objr^n$ from \Cref{lem:injections} as a certain convolution.
\begin{lemma}
\label{lem:diagram-to-eq-system}
For any diagram $f\from \objr^m\to \objr^n$, if
$$
\dbox{f}{m}{n} \; \disteq{0} \;\tikzfig{automata-rep-all-states}
$$ 
for some guarded matrix-diagram $c\from \objr^{\ell+m}\to \objr^{\ell+m}$ and a relation-diagram $o\from \objr^{\ell+m}\to \objr^n$,
then, for all $i\in\{1,\dots,m\}$ we can find $\{a_j, f_{i_j}\}_{1\leq j\leq k}$, and $\{v_{q_j}\}_{1\leq j\leq \ell}$ such that
$$
\dbox{f_i}{}{n} \;\disteq{0} \tikzfig{state-eq}
$$
where $f_i$, $1\leq i\leq m$ and $v_{q_j}$, $1\leq i\leq \ell$  are defined as above.
\end{lemma}
\begin{proof}
First,  by unrolling (Lemma~\ref{lem:unroll}),we have
\begin{align*}
\dbox{f}{m}{n} \; \disteq{0} \;\tikzfig{automata-rep-all-states}\;\disteq{0}  \;\tikzfig{automata-rep-all-states-1}
\end{align*}
Thus, for any $i\in\{1,\dots,m\}$, say $i=m$ for simplicity, we get
\begin{align*}
\dbox{f_m}{}{n} \;&\disteq{0} \;\tikzfig{automata-rep-last-state-1}  \;\disteq{0} \;\tikzfig{automata-rep-last-state-2}\\
& \disteq{0} \;\tikzfig{automata-rep-last-state-3}
\\
& \disteq{0} \;\tikzfig{automata-rep-last-state-4}
\\
& \disteq{0} \;\tikzfig{automata-rep-last-state-5}
\\
& \disteq{0} \;\tikzfig{automata-rep-last-state-6}
\end{align*}
where $c^i_m$ is either $\scalar{a}$ for some $a\in \Sigma$, when there is an $a$-transition connecting its only input wire to some $f_j$, or $\Bcounit \;\;\Bunit$ otherwise (recall that $c$ is guarded), and $o^i_m$ is either an identity, when the only input of $o_m$ is connected to some output wire, or $\Bcounit \;\;\Bunit$ otherwise. Since all $f_j$ connected to some $\Bcounit \;\;\Bunit$ can be removed (using co-deleting), we get the equality we wanted.
\end{proof}
Since every diagram can be brought to the representation normal form, we can easily obtain the following result.
\begin{restatable}{lemma}{fundamental}\label{lem:fundamental}
	For any diagram $f \colon \objr^m \to \objr^n$ and $f_i$, $1 \leq i \leq m$ defined as above, for all $i \in \{1, \dots,m\}$, we can derive 
	

	\[
	\dbox{f_i}{}{n} \;\disteq{0} \tikzfig{state-eq}
	\]
	
	\noindent
	where, for $1\leq j\leq \ell$, each $v_{q_j}\from \objr\to \objr^n$ is a diagram encoding the output variables to which the $i$-th input wire of $f$ is directly connected, that is, without going through any $\scalar{a}$ generator (in particular, each $v_{q_j}$ is a monoidal product of a single identity with $n-1$ $\Bunit$ generators).
\end{restatable}
\begin{proof}
	Follows from \Cref{thm:representation} and \Cref{lem:diagram-to-eq-system}.
\end{proof}
The informal intuition is that each of the $f_i \colon \objr \to \objr^n$ diagrams represents a state of a prechart and the behaviour of each such state is the union of all possible labelled transitions to other states and variable outputs. To make this formal, we first establish the lemma below.
\begin{lemma}
\label{lem:fixpoint}
For any $f\from \objr^m\to \objr^n$ and $f_i$, $1\leq i\leq m$ defined as above, for all $i\in\{1,\dots,m\}$, we have that
{
\small
\[\sem{f_i}= \sum_{j=1}^k a_{j}.\sem{f_{i_j}} + \sum_{j=1}^{\ell} \sem{v_{q_k}} \quad \text{ if }\quad \dbox{f_i}{}{n} \;\disteq{0} \tikzfig{state-eq}\]
}
where, for $1\leq j\leq \ell$,
each $v_{q_j}\from \objr\to \objr^n$ is a diagram encoding the output variables, as defined in \Cref{lem:fundamental}.
\end{lemma}
\begin{proof}
This is a consequence of Lemma~\ref{lem:sum-convolution} and the semantics of composition and prefixing.
% For the `only if' direction, assume that $\sem{f_i}= \sum_{j=1}^k a_{j}.\sem{f_{i_j}} + \sum_{j=1}^{\ell} \sem{v_{q_j}} $ as in the statement of the lemma. Then, by ????,
%$$\sem{f_i} = \mu x_{i_1}.\dots\mu x_{i_\ell}.\left(\sum_{j=1}^k a_{j}.x_{i_j}\right) + \sum_{j=1}^{\ell} v_{q_k}$$
%where we have substituted each $f_{i_j}$ with a corresponding variable $x_{i_j}$ bound by some $\mu$. By the definition of the dagger (Definition~\ref{def:dagger}) and the trace operator (Definition~\ref{def:trace}), we have
%$$\sem{f_i} = \left(\sum_{j=1}^k a_{j}.x_{i_j}\right)^{\dagger\dots\dagger} + \sum_{j=1}^{\ell} v_{q_k} = \Tr^k_{k,n}\left(\nabla_n \,; \left(\sum_{j=1}^k a_{j}.x_{i_j}\right)\right) + \sum_{j=1}^{\ell} v_{q_k}$$ 
\end{proof}
It turns out that we can make the intuition about each diagram corresponding to state of a prechart formal, by extracting a prechart over the set $Q_f = \{f_1, \dots, f_m\}$, whose transition function $\beta$ is given by the following; we define $f_i \tr{a} f_{j}$ iff $\dbox{f_i}{}{n}$ contains $\tikzfig{prefix-transition}$ and similarly $f_i \rhd v_s$ iff $\dbox{f_i}{}{n}$ contains $\dbox{v_s}{}{n}$. The behavioural distance between states of this prechart, precisely captures the behavioural distance between each of the $f_i$ diagrams.
\begin{restatable}{lemma}{extracteddist}\label{cor:dist-chart-diag}
	For all $f_i, f_j \in Q_f$, we have that $\mathsf{bd}_{\beta}(f_i,f_j) = \mathsf{bd}(\sem{f_i}, \sem{f_j})$
\end{restatable}
\begin{proof}
First, we observe that a function mapping each state $f_i \in Q_f$ to $\sem{f_i}$ is a prechart homomorphism from $(Q_f, \beta)$ to ${\Expr}/{\sim}$. This immediately follows from \Cref{lem:fixpoint} and the definition on transition structure on ${\Expr}/{\sim}$ (given by \Cref{lem:quotient_chart}). Essentially, homomorphisms are maps that preserve and reflect prechart transitions~\cite[Example~2.1]{Rutten:2000:Universal} and $(Q_f, \beta)$ is precisely defined to satisfy this. Since homomorphisms are isometries (\Cref{thm:beh_dist}), we obtain the desired result.
\end{proof}
\subsection{Completeness result}
Recall that a prechart $(Q_f, \beta)$ is finite and hence we can employ an iterative characterisation of behavioural distance from \Cref{lem:finite_dist}. The completeness argument relies on showing that we can axiomatically derive each of the approximants from \Cref{c2:thm:kleene}. First, we observe the following:
\begin{remark}\label{rem:repr_transitions}
	Let $F$ be a set of string diagrams of the type $\objr \to \objr^n$. The set $\Sigma \times F + V_n$ is isomorphic to the set
	$$
	G = \left\{\tikzfig{prefix-transition} \mid a \in \Sigma, f_j \in F \right\} \cup \left\{\dbox{v_s}{}{n} \mid 1 \leq s \leq n\right\}
	$$
\end{remark}
Then, we show that we can axiomatically simulate the behaviour of lifting for the functor $\Sigma \times (-) + V$.
\begin{lemma}\label{lem:transition_approximation}
	Let $F$ be a set of string diagrams of the type $\objr \to \objr^n$ that is equipped with a $1$-bounded pseudometric $d_F \colon F \times F \to [0,1]$. Assume that for all $f_i, f_k \in F$, $r \in \Qp$, such that $d_F(f_i, f_k)\leq r$, we have that $\dbox{f_i}{}{n} \disteq{r} \dbox{f_k}{}{n}$ is derivable. For all $g_u, g_v \in G$, with $G$ defined as above and all $r \in \Qp$, such that $d_F^\uparrow(g_u, g_v) \leq r$, we have that $\dbox{g_u}{}{n} \disteq{r} \dbox{g_v}{}{n}$ is derivable.
\end{lemma}
\begin{proof}
Let $r \geq d_F^\uparrow(g_u, g_v)$. First, consider the case, when $\dbox{g_u}{}{n} = \tikzfig{prefix-transition-1}$ and $\dbox{g_v}{}{n} = \tikzfig{prefix-transition-2}$. We have that $d_F^\uparrow(g_u, g_v)= \frac{1}{2} d_F(f_i, f_k)$ and hence $2 r \geq d_F(f_i, f_k)$. By the assumption, we know that $\dbox{f_i}{}{n} \disteq{2r} \dbox{f_k}{}{n}$ is derivable. 

Using \textsf{(Pref)}, we can derive $\tikzfig{prefix-transition-1} \disteq{r} \tikzfig{prefix-transition-2}$, which is the same as $\dbox{g_u}{}{n} \disteq{r} \dbox{g_v}{}{n}$. In all the remaining cases, $d_F^\uparrow$ behaves like a discrete pseudometric, hence there are two remaining subcases. In the situation when $\dbox{g_u}{}{n} = \dbox{g_v}{}{n}$, we have that $d_F^\uparrow(g_u, g_v)=0$ and hence we can derive $\dbox{g_u}{}{n} \disteq{r} \dbox{g_v}{}{n}$ by first applying \textsf{(Refl)} and then \textsf{(Max)}. Othwerise, when $\dbox{g_u}{}{n} \neq \dbox{g_v}{}{n}$, we have that $d_F^\uparrow(g_u, g_v)=1$ and hence we can derive $\dbox{g_u}{}{n} \disteq{r} \dbox{g_v}{}{n}$ by first applying \textsf{(Top)} and then \textsf{(Max)}.
\end{proof}
Then, we establish a similar result for Hausdorff lifting. Crucially, we make use of the alternative characterisation of Hausdorff distance via couplings.
\begin{lemma}\label{lem:hausdorff_approx}
	Let $F$ be a finite set of string diagrams of the type $\objr \to \objr^n$ that is equipped with a $1$-bounded pseudometric $d_F \colon F \times F \to [0,1]$. Assume that for all $f_i, f_k \in F$, $r \in \Qp$, such that $d_F(f_i, f_k)\leq r$, we have that $\dbox{f_i}{}{n} \disteq{r} \dbox{f_k}{}{n}$ is derivable. Then, for all $A,B \subseteq F$ and all $r \in \Qp$, such that $\mathcal{H}(d_F)(A,B) \leq r$, we have that $\dbox{R_A}{}{n} \disteq{r} \dbox{R_B}{}{n}$ is also derivable.
\end{lemma}
\begin{proof} Pick an arbitrary $r \in \Qp$, such that $\mathcal{H}(d_F)(A,B) \leq r$.
	If $A=B=\emptyset$, then by the usage of \textsf{(Refl)} and \textsf{(Max)} we are done. Similarly, when only one of $A$ and $B$ is empty, that we can immediately obtain the desired result using \textsf{(Top)} and \textsf{(Max)} rules. From now on, we can safely assume that $A$ and $B$ are nonempty. Recall the characterisation of Hausdorff distance from \Cref{rem:hausdorff_duality}. One can easily observe that in the case when $A$ and $B$ are nonempty, the set $\Gamma(A,B)$ of relational couplings between $A$ and $B$ is nonempty and hence 
	$$
	\mathcal{H}(d_F)(A,B) = \min \left\{\sup_{(f_i,f_k) \in R} d_F(f_i,f_k) \mid R \in \Gamma(A,B)\right\} \leq r
	$$
	There must exist some optimal coupling $R_{\min} \in \Gamma(A,B)$, which witnesses the above minimum. Hence, we have that $
	\sup_{(f_i, f_k) \in R_{\min}} d_F(f_i, f_k) \leq r
	$, which in turn implies that $d_F(f_i, f_k) \leq r$ for all $(f_i, f_k) \in R_{\min}$. Using the assumption, we know that for all pairs $(f_i, f_k) \in R_{\min}$, we have that
	$$
	\dbox{f_i}{1}{n} \disteq{r} \dbox{f_k}{1}{n}
	$$
	For the sake of simplicity, assume that $R_{\min} = \{(f_{i_1}, f_{k_1}), \dots, (f_{i_j}, f_{k_j})\}$. Using the $\mathsf{(Tens)}$ rule we can stack in parallel all these pairs and obtain:
	$$
	\tikzfig{par-stack-hausdorff-l} \disteq{r} \tikzfig{par-stack-hausdorff-r} 
	$$
	Using the \textsf{(Seq)} rule, we can derive that
	$$
	\tikzfig{repr-hausdorff-l} \disteq{r} \tikzfig{repr-hausdorff-r} 
	$$
	From the definition of relational couplings, we have that $\pi_1(R_{\min}) = A$ and $\pi_2(R_{\min}) = B$ and hence the diagrams above are convolutions of the sets $A$ and $B$ respectively. This allows us to conclude that $\dbox{R_A}{1}{n} \disteq{r} \dbox{R_B}{1}{n}$ is derivable.
\end{proof}
We can now combine the above results and show that upper bounds on each of the approximants can be derived syntactically through the means of axiomatic manipulation.
\begin{restatable}{lemma}{approximation}\label{lem:approximation}
	Let $f\from \objr^m\to \objr^n$, $f_i$, $1\leq i \leq m$ and $(Q_f, \beta)$ be defined as above. For all $f_g, f_h \in Q_f$, all $p \in \N$ and any $r \geq \Phi^{(p)}_\beta({f_g}, {f_h})$, we have that
	$\dbox{f_g}{}{n} \disteq{r} \dbox{f_h}{}{n} $ is derivable.
\end{restatable}
\begin{proof}
	Pick an arbitrary $f_g,f_h \in Q_f$.
	By induction on $p$. When $p=0$, $\Phi_{\beta}^{(p)}$ is a discrete pseudometric on the set $Q_f$ and hence for all $r \geq \Phi_{\beta}^{(p)}(f_g, f_h)$, we can derive $\dbox{f_g}{}{n} \disteq{r} \dbox{f_h}{}{n}$ using \textsf{(Refl)}, \textsf{(Top)} and \textsf{(Max)} rules, similarly to the proof of \Cref{lem:transition_approximation}.	
	For the induction step, when $p = p' + 1$. Recall that $\Phi_\beta^{p'+1}(f_g, f_h) = \mathcal{H}\left({\Phi_\beta^{(p')}}^\uparrow\right)(\beta(f_g), \beta(f_h))$. Pick an arbitrary $r \geq \mathcal{H}\left({\Phi_\beta^{(p')}}^\uparrow\right)(\beta(f_g), \beta(f_h))$. In order to derive that $\dbox{f_g}{}{n} \disteq{r} \dbox{f_h}{}{n}$, we will rely on \Cref{lem:hausdorff_approx}. In order to use it, we need to be able to derive approximations to the distance given by ${\Phi_\beta^{(p')}}^\uparrow$ on the string diagrams representing the elements of the set $\Sigma \times Q_f + V_n$ (see \Cref{rem:repr_transitions}). For this we will use \Cref{lem:transition_approximation}, which requires that for all $f_{g'}, f_{h'} \in Q_f$, $r' \geq \Phi^{(p')}_\beta$ one can derive that $\dbox{f_{g'} }{}{n} \disteq{r'}\dbox{f_{h'}}{}{n}$. This in turn is guaranteed by the induction hypothesis, which completes the proof.
\end{proof}
 Using \textsf{(Cont)} rule and characterisation from \Cref{lem:finite_dist}, we obtain a completeness result for distances between $f_i \colon \objr \to \objr^n$ components of $f \colon \objr^m \to \objr^n$.
\begin{restatable}{lemma}{onemcompleteness}\label{lem:one-to-m-completeness}
	Let $f\from \objr^m\to \objr^n$ and $f_i$, $1\leq i \leq m$ be defined as above. For all $g,h\in\{1,\dots,m\}$, any valid equation $\dbox{f_g}{}{n} \disteq{r} \dbox{f_h}{}{n}$ is derivable.
\end{restatable}
\begin{proof}
	Let $\dbox{f_g}{}{n} \disteq{r} \dbox{f_h}{}{n}$ be valid, that is $\mathsf{bd}_{\overline \partial}(\sem{f_g}, \sem{f_h}) \leq r$.
	We will rely on \textsf{(Cont)} rule. In order to deduce that $\dbox{f_g}{}{n} \disteq{r} \dbox{f_h}{}{n}$ we need to show that for all $r' > r$, we have that $\dbox{f_g}{}{n} \disteq{r'} \dbox{f_h}{}{n}$ is derivable. Since $r' > r$, we have that $\mathsf{bd}_{\overline \partial}(\sem{f_g}, \sem{f_h}) < r'$. Because of \Cref{cor:dist-chart-diag} and \Cref{cor:kleene_locally_finite}, we have that
	$$
		\inf_{p \in \N}\left\{\Phi^{(p)}_\beta(f_g, f_h)\right\} < r'
	$$
	We will argue that there exists $p \in \N$, such that $\Phi^{(p)}_\beta(f_g,f_h) < r'$. Assume that for all $p \in \N$, we have that $\Phi^{(p)}_\beta(f_g,f_h) \geq r'$. This would make $r'$ into the lower bound of the $\omega$-cochain $\left\{\Phi^{(p)}_\beta(f_g, f_h)\right\}_{p \in \N}$ and hence $r' \leq 	\inf_{p \in \N}\left\{\Phi^{(p)}_\beta(f_g, f_h)\right\} < r'$, which leads to contradiction. Combining that argument with \Cref{lem:approximation} allows us to conclude that $\dbox{f_g}{}{n} \disteq{r'} \dbox{f_h}{}{n}$ is derivable, which completes the proof. 
\end{proof}
Relying on \Cref{lem:injections}, we can reduce the problem of deriving distance between arbitrary $\objr^m \to \objr^n$ diagrams, to the case of $\objr \to \objr^n$ solved above. This yields completeness result for left-to-right diagrams. 
\begin{restatable}{theorem}{completeness}\label{lem:mncompleteness}
Let $f,g \colon \objr^m \to \objr^n$. Any valid equation $\dbox{f}{m}{n} \disteq{r} \dbox{g}{m}{n}$ is derivable.
\end{restatable}
\begin{proof}
	Assume that $\dbox{f}{m}{n} \disteq{r} \dbox{g}{m}{n}$ is valid.
	Recall that because of \Cref{lem:injections}, we have that
	\begin{gather*}
		\dbox{f}{m}{n} \disteq{0} \tikzfig{d-decomposition} \qquad \text{and}\qquad \dbox{g}{m}{n} \disteq{0} \tikzfig{d-decomposition-r}  
	\end{gather*}
	Assume that $\sem{f_i} = N(s_i)$ and $\sem{g_i}=N(t_i)$ for $1 \leq i \leq m$. Because of \Cref{lem:distance_on_merge}, we have that $d^{1,n}(s_i, t_i) \leq r$.
	We will consider the following diagram
	$$\tikzfig{comp-par-lr} \disteq{0} \tikzfig{comp-par-states}$$
	Using \Cref{lem:fundamental}, we can show that each of the $\objr \to \objr^{m}$ subdiagrams is in the form allowing to use \Cref{lem:one-to-m-completeness}. In turn, that lemma allows to derive any valid equations between the subdiagrams mentioned above. In particular, we can derive that $\diagbox{f_i}{}{m} \disteq{r} \diagbox{g_i}{}{m}$ for all $1 \leq i \leq m$. We can use \textsf{(Tens)} rule to derive
	$$
		\tikzfig{par-stack-completeness-l} \disteq{r} \tikzfig{par-stack-completeness-r}
	$$
	We can then apply \textsf{(Seq)} to postcompose co-copying to the diagrams above to obtain
	$$
	 \tikzfig{d-decomposition} \disteq{r}  \tikzfig{d-decomposition-r}
	$$
	By previous reasoning and \textsf{(Triang)} rule this is the same as
	$$
	\diagbox{f}{m}{n} \disteq{r} \diagbox{g}{m}{n}
	$$
	which completes the proof.
\end{proof}
Since arbitrary diagrams can be turned into $\objr^m \to \objr^n$ diagrams by appropriately composing $\tikzfig{cup-down}$ and $\tikzfig{cap-down}$, which happens to preserve distances between diagrams, we arrive at the desired completeness result.
\begin{restatable}[Quantitative completeness]{theorem}{generalcompleteness}\label{thm:completeness}
	Let $f,g \colon v \to w$ be two arbitrary diagrams. Any valid equation  $\diagbox{f}{v}{w} \disteq{r} \diagbox{g}{v}{w}$ is derivable.
\end{restatable}
\begin{proof}
	Observe that, given a pair $f,g \colon v \to w$ we obtain $S(f)$ and $S(g)$ by postcomposing \tikzfig{cap-down} (or precomposing \tikzfig{cup-down}). Since composition is nonexpansive (\Cref{cor:sem_enriched}), if $\diagbox{f}{v}{w} \disteq{r} \diagbox{g}{v}{w}$ is valid, so is $\dbox{S(f)}{m}{n} \disteq{r} \dbox{S(g)}{m}{n}$. The rest follows as a consequence of \Cref{lem:mncompleteness}.
\end{proof}
\section{Discussion}
\label{sec:discussion}

In this chapter, we presented a sound and complete quantitative axiomatisation of the behavioural distance of Milner's charts~\cite{Milner:1984:Complete}. We have relied on a compositional, string diagrammatic syntax~\cite{piedeleu2023finite,antoinecsl2025} and equipped it with a quantitative inference system for reasoning about bounds on behavioural distance, inspired by recent advances in metric universal algebra~\cite{Mardare:2016:Quantitative,MiliusU19,Mio:2024:Universal}.

Originally introduced for probabilistic systems~\cite{Breugel:2001:Towards,Desharnais:2004:Metrics}, behavioural distances have recently been generalised to a broad range of systems modelled via the abstract framework of universal coalgebra~\cite{Rutten:2000:Universal}, leveraging pseudometric liftings of functors~\cite{Baldan:2018:Coalgebraic}. The notion of behavioural distance for charts used in this chapter is an instance of this coalgebraic framework. Our concrete characterisation closely resembles the metric on trees studied by Nivat~\cite{Nivat:1979:Infinite}. A similar characterisation was studied by Golson and Rounds~\cite{Golson:1984:Connections}, who instead examined de Bakker and Zucker's metric domain for nondeterministic processes~\cite{Bakker:1982:Processes}, also derived via a fixpoint construction involving the Hausdorff distance. 

The idea of reasoning about distances between string diagrams has been explored before in quantum theory~\cite{kissinger2017pictureperfectquantumkeydistribution,Breiner:2019:Graphical,HLarsen2021} and probability theory~\cite{Perrone:2024:Markov}. However, in contrast with the growing body of work on cartesian quantitive algebra~\cite{Mardare:2016:Quantitative,Mio:2024:Universal, Bacci:2024:Sum}, a systematic foundation to axiomatising distances between string diagrams appeared only very recently, in the work of Lobbia et al~\cite{Lobbia:2024:Quantitative}. Besides the basic examples provided in~ \cite{Lobbia:2024:Quantitative}, our work is the first to propose a complete axiomatisation of a quantitative calculus of string diagrams. The approach of~\cite{Lobbia:2024:Quantitative} is based on enriched category theory: similarly, one could observe that the equipment of our semantic category with pseudometric structures making sequential and parallel composition nonexpansive yields the enrichment in the category of pseudometric spaces. However, our axiomatisation relies on the domain-specific implicational rule \textsf{(Pref)} and an axiom schema \textsf{(Codel)} that cannot be expressed in the framework of Lobbia et al~\cite{Lobbia:2024:Quantitative}, which only supports quantitative equations. Reconciling those rule formats with the general framework of Lobbia et al~\cite{Lobbia:2024:Quantitative} is an interesting direction for future research.

Axiomatising behavioural distances have been originally studied through ad-hoc inference systems~\cite{Larsen:2011:Metrics,Argenio:2014:Axiomatizing}. The introduction of quantitative equational theories made more principled approaches possible, leading to axiomatisations of behavioural distance for probabilistic systems~\cite{Bacci:2018:Bisimilarity,Bacci:2018:Algebraic}. In \Cref{chapter2}, we extended these results within a coalgebraic framework, focusing on the simple case of DFA, which enjoys a straightforward algebraic representation via the syntax of Kleene Algebra. While we rely here on the general pattern of the completeness proof from~\Cref{chapter2} the case of Milner's charts was significantly more involved, requiring the ability to simulate the behaviour of Hausdorff lifting syntactically.

In constructing the semantic category, we have used the fact that charts form a Conway theory~\cite{Esik:1999:Group}, studied in the literature on parametrised fixpoint operators~\cite{Haghverdi:2000:Categorical,Simpson:2000:Complete,Abramsky:2002:Geometry}, and which can be seen as a relaxation of iteration theories~\cite{Bloom:1993:Iteration}. The connection between charts and these structures was previously investigated by Bloom, Esik, and Taubner~\cite{Bloom:1993:Iteration} and Sewell~\cite{Sewell:1995:Algebra}, while the interplay of parametrised fixpoint operators with traced monoidal categories was studied by Hasegawa~\cite{Hasegawa:1997:Models}, Haghverdi~\cite{Haghverdi:2000:Categorical}, and Simpson and Plotkin~\cite{Simpson:2000:Complete} independently.

Our work constitutes a necessary first step towards a similar diagrammatic treatment of behavioural distance for quantitative automata, such as probabilistic and weighted systems, for which distances are a more suitable way of reasoning rather than Boolean equivalences. The string diagrammatic point of view would enable a desirable, compositional treatment that reflects well the underlying operational models, in a way that is not available through conventional syntaxes. Another promising direction for future work would be to consider Guarded Kleene Algebra with Tests (GKAT)~\cite{Smolka:2020:Guarded,Schmid:2021:Guarded}, an efficiently decidable language for reasoning about equivalence of uninterpreted programs. The completeness proof of GKAT relies on a metric argument that could be internalised within an inference system like the one introduced in this chapter. Moreover, the syntax of GKAT is insufficiently expressive, as it can only describe a part of the behaviours of its underlying operational model -- in fact there is no finite purely algebraic syntax that could do so~\cite{Cate:2025:Algebras}. A string diagrammatic treatment could allow us to express all such behaviours and obtain a simpler yet more expressive completeness result, that would in turn enable axiomatic reasoning about decompilation algorithms, that were recently shown to be expressible via GKAT automata (but not in GKAT)~\cite{Zhang:2025:CFGKAT}.
 