\chapter{Completeness Theorem for Probabilistic Regular Expressions}
\label{chapter4}
{\color{red} Write introduction!}
\section{Overview}\label{c4:sec:overview}
In this section, we will introduce the syntax and the language semantics of probabilistic regular expressions ({PRE}), as well as a candidate inference system to reason about the equivalence of {PRE}. 

\subsection{Syntax}\label{s4:subsec:syntax}
Given a finite alphabet $\alphabet$, the syntax of {PRE} is given by:
$$e,f \in \PExp ::= \zero \mid \one \mid a \in \alphabet \mid e \oplus_p f \mid e\seq f \mid e^{[p]} \quad\quad\quad p \in\interval{0}{1}$$
We denote the expressions that immediately abort and successfully terminate by $\zero$ and $\one$ respectively. For every letter $a \in \alphabet$ in the alphabet, there is a corresponding expression representing an atomic action. Given two expressions $e, f \in {\PExp}$ and $p \in \interval{0}{1}$, probabilistic choice $e \oplus_p f$ denotes an expression that performs $e$ with probability $p$ and performs $f$ with probability $1-p$. One can think of $ \oplus_p$ as the probabilistic analogue of the
 plus operator ($e + f$) in Kleene's regular expressions. $e \seq f$ represents sequential composition, while $e^{[p]}$ is a probabilistic analogue of Kleene star: it successfully terminates with probability $1-p$ or with probability $p$ performs $e$ and then iterates $e^{[p]}$ again.  In terms of the notational convention, the sequential composition $(\seq)$ has higher precedence than the probabilistic choice $(\oplus_p)$.

\begin{example}
    The expression $a \seq a^{[\frac{1}{4}]}$ first performs action $a$ with probability $1$ and then enters a loop which successfully terminates with probability $\frac{3}{4}$ or performs action $a$ with probability $\frac{1}{4}$ and then repeats the loop again. Intuitively, if we think of the action $a$ as observable, the expression above denotes a probability associated with a non-empty sequence of $a$'s. For example, the sequence $aaa$ would be observed with probability $1 \cdot (1/4)^2 \cdot 3/4=3/64$.
\end{example}
\subsection{Language semantics}\label{c4:subsec:language}
{PRE} denote probabilistic languages $\alphabet^\ast \to \interval{0}{1}$. For instance, the expression $\zero$ denotes a function that assigns $0$ to every word, whereas $\one$ and $a$ respectively assign probability $1$ to the empty word and the word containing a single letter $a$ from the alphabet. The probabilistic choice $e \oplus_p f$ denotes a language in which the probability of each word is the total sum of its probability in $e$ scaled by $p$ and its probability in $f$ scaled by $1-p$. Describing the semantics of sequential composition and loops inductively is more involved. In particular, the semantics of loops would require a fixpoint calculation, which does not have as clear and straightforward (closed-form) formula, as the asterate of regular languages. Instead, we take an \emph{operational approach}, and we formally define the language semantics of {PRE} in \Cref{sec:language_semantics} through a small-step operational semantics, using a specific type of probabilistic transition system, which we introduce next.

\subsection{Generative probabilistic transition systems}\label{c4:subsec:generative}
A {GPTS} consists of a set of states $Q$ and a transition function that maps each state $q\in Q$ to finitely many distinct outgoing arrows of the form:
\begin{itemize}
    \item \emph{successful termination} with probability $t$ (denoted $q \xRightarrow[]{t} \checkmark$), or 
    \item to another state $r$, via an \emph{$a$-labelled transition}, with probability $s \in \interval{0}{1} $ (denoted $q \xrightarrow[]{a \mid s} r$).
\end{itemize} 
We require that, for each state, the total sum of probabilities appearing on outgoing arrows sums up to less or equal to one. The remaining probability mass is used to model unsuccessful termination, hence the state with no outgoing arrows can be thought of as exposing deadlock behaviour. 

Given a word $w \in \alphabet^\ast$ the probability of it being generated by a state $q\in Q$ (denoted $\langmap(q)(w) \in \interval{0}{1}$) is defined inductively:
\begin{equation}\label{c4:eqn:language}
    \langmap(q) (\emptyword)=t \quad\text{if } q \xRightarrow[]{t} \checkmark \qquad\qquad
    \langmap(q)(av) = \sum_{q \xrightarrow[]{a \mid s} r} s \cdot \langmap(r)(v)
\end{equation}
We say that two states $q$ and $q'$ are \emph{language equivalent} if for all words $w \in \alphabet^*$, we have that $\langmap(q)(w)=\langmap(q')(w)$.
\begin{example}\label{c4:ex:systems}
 Consider the following {GPTS}:
 \begin{gather*}
\begin{tikzpicture}[baseline=-3ex]
        \node (0) {$q_0$};
        \node (1) [right= 1.15 cm of 0]{$q_1$};
        \draw (0) edge[-latex] node[ fill=white] {\scriptsize\( {a} \mid {1}\)} (1);
        \draw (1) edge[loop above] node[left] {\scriptsize\( {a} \mid {\frac{1}{4}}\)} (1);
        \node (o1) [right= 0.5 cm of 1]{$\checkmark$};
        \draw (1) edge[-implies, double, double distance=0.5mm] node[above] {\scriptsize\( \frac{3}{4}\)} (o1);
        \node (2) [right= 0.5 cm of o1] {$q_2$};
         \node (2a) [right= 1.25 cm of 2] {};
        \node (3) [below= -.01 cm of 2a] {$q_3$};
        \draw (2) edge[-latex] node[ fill=white] {\scriptsize\( {a} \mid {\frac{1}{4}}\)} (3);
        \draw (3) edge[loop below] node[right] {\scriptsize\( {a} \mid {\frac{1}{4}}\)} (3);
        \node (4) [right= 3 cm of 2] {$q_4$};
        \draw (3) edge[-latex] node[ fill=white] {\scriptsize\( {a} \mid {\frac{3}{4}}\)} (4);
        \draw (2) edge[-latex, bend left] node[ fill=white] {\scriptsize\( {a} \mid {\frac{3}{4}}\)} (4);
        \node (o2) [right= 0.5 cm of 4]{$\checkmark$};
        \draw (4) edge[-implies, double, double distance=0.5mm] node[above] {\scriptsize\( 1\)} (o2);
\end{tikzpicture}
\end{gather*}
%States $q_0$ and $q_2$ despite not being bisimilar (in the sense from~\cite{Larsen:1991:Bisimulation}), 
States $q_0$ and $q_2$ both assign probability $0$ to the empty word $\emptyword$ and each word $a^{n+1}$ is mapped to the probability $\left(\frac{1}{4}\right)^n \cdot \frac{3}{4}$. Later in the paper, we show that the languages generated by states $q_0$ and $q_2$ can be specified using expressions $a\seq a^{\left[ \frac{1}{4} \right]}$ and $a \oplus_{\frac{3}{4}} ( a\seq a^{\left[ \frac{1}{4} \right]} \seq a)$ respectively.
\end{example}
In \Cref{sec:operational_semantics}, we will associate to each {PRE} $e$ an operational semantics or, more precisely, a state $q_e$ in a {GPTS}. The language semantics $\sem{e}$ of $e$ will then be the language $\langmap( q_e) \colon \alphabet^\ast \to \interval{0}{1}$ generated by $q_e$. Two {PRE} $e$ and $f$ are language equivalent if $\langmap(q_e)=\langmap(q_f)$. One of our main goals is to present a complete inference system to reason about language equivalence. In a nutshell, we want to present a system of (quasi-)equations of the form $e \equiv f$ such that:
\[
e\equiv f \Leftrightarrow \sem {e} = \sem{g} \Leftrightarrow \langmap(e) = \langmap(f)
\]
Such an inference system will have to contain rules to reason about all constructs of {PRE}, including probabilistic choice and loops. We describe next the system, with some intuition for the inclusion of each group of rules. 

\subsection{Axiomatisation of language equivalence of {PRE}}\label{c4:subsec:axiomatisation}
We define ${\equiv} \subseteq \PExp \times \PExp$ to be the least congruence relation closed under the axioms shown on \Cref{c4:fig:axioms}. We will show in \Cref{sec:completeness} that these axioms are complete with respect to language semantics. 
\begin{figure}[h]
\begin{center}	
{
\small
\(
\begin{array}{ll}
&\textbf{Probabilistic choice}\\
(\mathsf{C1})\;\; 
&  e \oplus_p e \equiv e \\
(\mathsf{C2})\;\; 
&  e \oplus_1 f \equiv  e  \\
(\mathsf{C3})\;\; 
&  e \oplus_p f \equiv f \oplus_{1-p} e  \\
(\mathsf{C4})\;\; 
&  (e \oplus_{p} f) \oplus_{q} g \equiv e \oplus_{pq} \left(f \oplus_{\frac{{(1-p)}q}{1-pq}} g\right)  \\\\
&\textbf{Sequential composition}\\
	(\mathsf{1S})\;\; 
&  \one \seq e \equiv e \,, \\
(\mathsf{S})\;\; 
&  e \seq (f \seq g) \equiv (e \seq f) \seq g \,, \\
(\mathsf{S1})\;\; 
&  e \seq \one \equiv e \,, \\
(\mathsf{0S})\;\; 
&  \zero \seq e \equiv \zero \,, \\
(\mathsf{S0})\;\; 
&  e \seq \zero \equiv \zero \,, \\
(\mathsf{D1})\;\; 
&  e \seq (f \oplus_p g) \equiv e \seq f \oplus_p e \seq g  \\
(\mathsf{D2})\;\; 
&  (e \oplus_p f) \seq g \equiv e \seq g \oplus_p f \seq g \\\\

%% recursion
&\textbf{Loops} \\
(\mathsf{Unroll})\;\; &  e^{[p]} \equiv e \seq e^{[p]} \oplus_p \one  \\[1.2ex]
(\mathsf{Tight})\;\; & (e \oplus_p 1)^{[q]}  \equiv e^{\left[\frac{pq}{1-(1-p)q}\right]}  \\[1.2ex]
(\mathsf{Div})\;\; & 1^{[1]}  \equiv 0  \\[1.2ex]
(\mathsf{Unique})\;\; & \inferrule{g \equiv e\seq g \oplus_p f \quad \fcolorbox{red}{white}{$E(e)=0$}}{g \equiv e^{[p]}\seq f} \\\\
%%(\Fix)\;\; & \{ s \equiv_b t[s / X] \}  s \equiv_b \rec{X}{t} \,, \text{ for $X$ guarded in $t$} \,, \\
%% distance
\
\end{array}
\)\\
\textbf{Termination conidition: $E \colon \PExp \to \interval{0}{1}$}\\
\fcolorbox{red}{white}{$
        \begin{array}{l}
            \quad E(\one)=1 \qquad E(\zero)=E(a) = 0 \qquad
            E \left( e \oplus_p f \right)=pE(e) + {(1-p)}E(f)\\[1.4ex]
            E(e\seq f)=E(e)E(f)\qquad
            \quad E\left(e^{[p]}\right)=
                \begin{cases}
                0 &  \text{\scriptsize $E(e)=1 \wedge p=1$} \\ 
                \frac{1-p}{1-pE(e)} & \text{\scriptsize otherwise}
                \end{cases}   
                \end{array}$
     }
}
\end{center}	
\caption{Axioms for language equivalence of PRE. The rules involving the division of probabilities are defined only when the denominator is non-zero. The function $E(-)$ provides a termination side condition to the (\textsf{Unique}) fixpoint axiom.}
\label{c4:fig:axioms}
\end{figure}

%\begin{figure*}
%        \centering
%        \begin{multicols}{2}
%        	 \begin{flushleft}\underline{\bf Probabilistic Choice}  	 \end{flushleft}
%        \begin{alignat*}{4}
%		\textbf{(C1)} & \;\, 
%		& e &{} \equiv e \oplus_p e\\
%				\textbf{(C2)} & \;\, 
%		& e &{} \equiv e \oplus_1 f\\
%		\textbf{(C3)} & \;\, 
%		& e \oplus_p  f &{} \equiv f \oplus_{\overline{p}} e\\
%		\textbf{(C4)} & \;\, 
%		& (e \oplus_{p} f) \oplus_{q} g & {} \equiv e \oplus_{pq} (f \oplus_{\frac{{(1-p)}q}{1-pq}} g)\\
%		\textbf{(D1)} & \;\, 
%		& (e \oplus_{p} f) \seq g & {} \equiv e \seq g \oplus_{p} f \seq g\\[-0.25ex]
%		\textbf{(D2)} & \;\, 
%		& e \seq (f \oplus_{p} g) & {} \equiv e \seq g \oplus_{p} e \seq f\\[-0.25ex]\\\\
%        \end{alignat*}
%          \begin{flushleft}   \underline{\bf Sequencing} \end{flushleft}
%        \begin{alignat*}{4}
%        \textbf{(0S)} & \;\, 
%		& 0 \seq e & {} \equiv 0 & \\[-0.25ex]
%		\textbf{(S0)} & \;\, 
%		& e \seq 0 & {} \equiv 0 & \\[-0.25ex]
%		\textbf{(1S)} & \;\, 
%		& 1 \seq e & {} \equiv e & \\[-0.25ex]
%		\textbf{(S1)} & \;\, 
%		& e \seq 1 & {} \equiv e \\[-0.25ex]
%		\textbf{(S)} & \;\, 
%		& e \seq (f \seq g) & {} \equiv (e \seq f ) \seq g \\[-0.25ex]
%        \end{alignat*}
%        \end{multicols}
%        \vspace{-2cm}
%         \begin{multicols}{2}
%     \begin{flushleft}    \underline{\bf Loops} \end{flushleft}
%        \begin{alignat*}{4}
%       	\textbf{(Unroll)} & \;\, 
%		& e \seq e^{[p]} \oplus_p 1& {} \equiv e^{[p]} \\
%		\textbf{(Tight)} & \;\, 
%		& (e \oplus_p 1)^{[q]} \seq 1 & {} \equiv e^{\left[\frac{pq}{1-\ol{p}q}\right]} \\[-0.25ex]
%		\textbf{(Div)} & \;\, 
%		& 1^{[1]} & {} \equiv 0 \\
%%		 \\ \quad\;\;\textbf{(Unique)} \;\, 
%%		\rlap{$\inferrule{g \equiv e\seq g \oplus_p f \quad \fcolorbox{red}{white}{$E(e)=0$}}{g \equiv e^{[p]}\seq f}$}
%        \end{alignat*}
%          \begin{flushleft}   \underline{\bf (Unique) fixpoint rule} \end{flushleft}
%		$\inferrule{g \equiv e\seq g \oplus_p f \quad \fcolorbox{red}{white}{$E(e)=0$}}{g \equiv e^{[p]}\seq f}$
%\end{multicols}
%        \vspace{-.5cm}
%     \begin{flushleft}    \underline{\bf Termination cond. $E : \PExp \to \interval{0}{1}$} \end{flushleft}
%        \fcolorbox{red}{white}{$
%        \begin{array}{l}
%            \quad E(\one)=1 \qquad E(\zero)=E(a) = 0 \qquad
%            E \left( e \oplus_p f \right)=pE(e) + \ol{p}E(f)\qquad 
%            E(e\seq f)=E(e)E(f)\quad \\[1.4ex]
%            \quad E\left(e^{[p]}\right)=
%                \begin{cases}
%                0 &  \text{\scriptsize $E(e)=1 \wedge p=1$} \\ 
%                \frac{1-p}{1-pE(e)} & \text{\scriptsize otherwise}
%                \end{cases}   
%                \end{array}$
%     }
%     %        \end{tabular}
%      %		\begin{align*}
%%            \textbf{(Unroll)} \quad e^{[p]} &\equiv e \seq e^{[p]}\\
%%            \textbf{(Tight)} \quad (e \oplus_p \one)^{[q]} &\equiv e^{\left[\frac{pq}{1-\ol{p}q}\right]}\\
%%            \one^{[1]} &\equiv \zero &\textbf{(Div)}\\
%%           \omit\rlap{$\inferrule{g \equiv e\seq g \oplus_p f \quad \fcolorbox{red}{white}{$E(e)=0$}}{g \equiv e^{[p]}\seq f}$}&&\textbf{(Unique)}\\
%%        \end{align*}
%        \caption{\label{fig:axioms} For $p \in \interval{0}{1}$, we write $\ol{p}=1-p$. The rules involving the division of probabilities are defined only when the denominator is non-zero. The function $E(-)$ provides a termination side condition to the \textbf{Unique} fixpoint axiom.}
%            \vspace{-.4cm}
%    \end{figure*}
%We will also write ${\equiv_b} \subseteq {\PExp \times \PExp}$ for the least congruence relation containing all the above rules except the two marked with $\heartsuit$. Intuitively, removing these rules axiomatises bisimilarity, which is the finer notion of equivalence. This relation will be used in the intermediate step of the proof of soundness. We will use the following notation for the quotient maps:
%% https://q.uiver.app/?q=WzAsMyxbMSwwLCJ7XFxFeHB9L3tcXGVxdWl2XzB9Il0sWzIsMCwie1xcRXhwfS97XFxlcXVpdn0iXSxbMCwwLCJcXEV4cCJdLFswLDEsIlstXV97XFxlcXVpdn0iLDJdLFsyLDAsIlstXV97XFxlcXVpdl8wfSIsMl0sWzIsMSwiWy1dIiwwLHsiY3VydmUiOi0zfV1d
%\[\begin{tikzcd}
%	\PExp & {{\PExp}/{\equiv_b}} & {{\PExp}/{\equiv}}
%	\arrow["{[-]_{\equiv}}"', from=1-2, to=1-3]
%	\arrow["{[-]_{\equiv_b}}"', from=1-1, to=1-2]
%	\arrow["{[-]}", curve={height=-18pt}, from=1-1, to=1-3]
%\end{tikzcd}\]

The first group of axioms capture properties of the probabilistic choice operator $\oplus_p$ (\textsf{C1-C4}) and its interaction with sequential composition (\textsf{D1-D2}). Intuitively, (\textsf{C1-C4}) are the analogue of the semilattice axioms governing the behaviour of $+$ in regular expressions. These four axioms are reminiscent of the axioms of barycentric algebras~\cite{Stone:1949:Postulates}. (\textsf{D1}) and (\textsf{D2}) are \emph{right and left distributivity} rules of $\oplus$ over $\seq$. The sequencing axioms (\textsf{1S}), (\textsf{S1}), (\textsf{S})  state {PRE} have the structure of a monoid (with neutral element $\one$ with absorbent element $\zero$ -- see axioms (\textsf{0S}), (\textsf{S0}). The loop axioms contain respectively \emph{unrolling}, \emph{tightening}, and \emph{divergency} axioms plus a \emph{unique fixpoint} rule. The (\textsf{Unroll}) axiom associates loops with their intuitive behaviour of choosing, at each step, probabilistically between successful termination and executing the loop body once. (\textsf{Tight}) and (\textsf{Div}) are the probabilistic analogues of the identity $(e + \one)^{*} \equiv e^{*}$ from regular expressions. In the case of {PRE}, we need two axioms: (\textsf{Tight}) states that the probabilistic loop whose body might instantly terminate, causing the next loop iteration to be executed immediately is provably equivalent to a different loop, whose body does not contain immediate termination; (\textsf{Div}) takes care of the edge case of a no-exit loop and identifies it with failure. Finally, the unique fixpoint rule is a re-adaptation of the analogous axiom from Salomaa's axiomatisation and provides a partial converse to the loop unrolling axiom, given the loop body is productive -- i.e. cannot immediately terminate. This productivity property is formally written using the side condition $E(e) = 0$, which can be thought of as the probabilistic analogue of empty word property from Salomaaâ€™s axiomatisation. Consider an expression $a^{\left[\frac{1}{2}\right]} \seq (b \oplus_{\frac{1}{2}} \one)$. The only way it can accept the empty word is to leave the loop with the probability of $\frac{1}{2}$ and then perform $1$, which also can happen with probability $\frac{1}{2}$. In other words, $\llbracket a^{\left[\frac{1}{2}\right]} \seq (b \oplus_{\frac{1}{2}} \one)\rrbracket(\emptyword) = \frac{1}{4}$. A simple calculation allows to verify that $E( a^{\left[\frac{1}{2}\right]} \seq (b \oplus_{\frac{1}{2}} \one)) = \frac{1}{4}$.




\begin{example} We revisit the expressions from \Cref{c4:ex:systems} and show their equivalence via axiomatic reasoning.
\begin{align*}
     a \seq a^{[\frac{1}{4}]} &\equiv a \seq (a^{[\frac{1}{4}]} \seq a \oplus_{\frac{1}{4}} \one) \tag{$\dagger$}\\ 
     &\equiv  (a \seq a^{[\frac{1}{4}]}\seq a) \oplus_{\frac{1}{4}} a \seq \one \tag{\textsf{D2}}\\
     &\equiv (a \seq a^{[\frac{1}{4}]}\seq a) \oplus_{\frac{1}{4}} a \tag{\textsf{S1}}\\
     &\equiv a \oplus_{\frac{3}{4}} (a \seq a^{[\frac{1}{4}]}\seq a)  \tag{\textsf{C3}}
\end{align*}

The $\dagger$ step of the proof above relies on the equivalence $e^{[p]}\seq e \oplus_p \one \equiv e$ derivable from other axioms under the assumption $E(e)=0$ through a following line of reasoning:
\begin{align*}
    e^{[p]} \seq e \oplus_p \one  &\equiv (e \seq e^{[p]} \oplus_p \one)\seq e\oplus_p \one \tag{\textsf{Unroll}}\\
    &\equiv (e \seq e^{[p]}\seq e \oplus_p \one\seq e) \oplus_p \one \tag{\textsf{D1}}\\
    &\equiv (e \seq e^{[p]}\seq e \oplus_p e) \oplus_p \one \tag{\textsf{1S}}\\
        &\equiv (e \seq e^{[p]}\seq e \oplus_p e\seq \one) \oplus_p \one \tag{\textsf{S1}}\\
    &\equiv e \seq (e^{[p]}\seq e \oplus_p \one) \oplus_p \one \tag{\textsf{D2}}
\end{align*}
Since $E(e)=0$,  we then have: 
\(
     e^{[p]} \seq e \oplus_p \one \stackrel{(\textsf{Unique})}\equiv e^{[p]}\seq \one 
     \stackrel{(\textsf{S1})}\equiv e^{[p]} .
\)
\end{example}
\section{Preliminaries}
In this section, we review the main preliminaries for the technical development outlined in the subsequent sections.
\label{c4:sec:preliminaries}
\subsection{Locally finitely presentable categories}\label{c4:subsec:lfp}
$\D$ is a filtered category, if every finite subcategory $\D_0 \hookrightarrow \D$ has a cocone in $\D$. A filtered colimit is a colimit of the diagram $\D \to \C$, where $\D$ is a filtered category. A directed colimit is a colimit of the diagram $\D \to \C$, where $\D$ is a directed poset. We call a functor \emph{finitary} if it preserves filtered colimits. An object $C$ is \emph{finitely presentable (fp)} if the representable functor $\C(C,-) : \C \to \Set$ preserves filtered colimits. Similarly, an object $C$ is \emph{finitely generated (fg)} if the representable functor $\C(C,-) : \C \to \Set$ preserves directed colimits of monos. Every fp object is fg, but the converse does not hold in general. A category $\C$ is \emph{locally finitely presentable (lfp)} if it is cocomplete and there exists a set of finitely presentable objects, such that every object of $\C$ is a filtered colimit of objects from that set. $\Set$ is the prototypical example of a locally finitely presentable category, where finite sets are the fp objects.

\subsection{Monads and their algebras}\label{c4:subsec:monads}
A monad (over the category $\Set$) is a triple $\monadT = (T, \mu, \eta)$ consisting of a functor $T \colon \Set \to \Set$ and two natural transformations: a unit $\eta \colon \Id \Rightarrow T$ and multiplication $\mu \colon T^2 \Rightarrow T$ satisfying $\mu \circ \eta_T = \id_T=  \mu \circ T\eta$ and $\mu \circ \mu_T = \mu \circ T \mu$
A $\monadT$-algebra (also called an Eilenberg-Moore algebra) for a monad $T$ is a pair $(X, h)$ consisting of a set $X \in \Obj(\C)$, called carrier, and a function $h \colon T X \to X$ such that $h \circ \mu_X = h \circ Th$ and $h \circ \eta_X = \id_X$. A $\monadT$-algebra homomorphism between two $T$-algebras $(X,h)$ and $(Y,k)$ is a function 	$f \colon X \to Y$ satisfying $k \circ Tf = f \circ h$.

$\monadT$-algebras and $\monadT$-homomorphisms form a category $\Set^\monadT$. There is a canonical forgetful functor $\forget \colon \Set^\monadT \to \Set$ that takes each $\monadT$-algebra to its carrier. This functor has a left adjoint $X \mapsto (TX, \mu_X \colon T^2 X \to T)$, mapping each set to its free $\monadT$-algebra. If $X$ is finite, then we call $(TX, \mu_X)$ free finitely generated.

Given a function $f \colon X \to Y$, where $Y$ is a carrier of a $\monadT$-algebra $(Y, h)$, there is a unique homomorphism $f^\sharp \colon (TX, \mu_X) \to (Y,h)$ satisfying $f^\sharp \circ \eta_X = f$ that is explicitly given by $f^\sharp = h \circ Tf$.

\subsection{Generalised determinisation}\label{sec:c4:generalised_determinisation}
Language acceptance of nondeterministic automata (NDA) can be captured via determinisation. {NDA} can be viewed as coalgebras for the functor $N = 2 \times {\powf}^\alphabet$, where $\powf$ is the finite powerset monad. Determinisation converts a {NDA} $(X, \beta \colon X \to 2 \times {\powf X}^\alphabet)$ into a deterministic automaton $\left({\powf X}, \beta^{\sharp} \colon {\powf X} \to 2 \times {(\powf X)}^\alphabet \right)$, where for $A \subseteq X$, we define $\beta^{\sharp}(A) = \bigcup_{x \in \alphabet} \beta(a)$. Additionally, $\beta^\sharp$ satisfies $\beta^\sharp(\{x\}) = \beta(x)$ for all $x \in X$. A language of the state $x \in X$ of {NDA}, is given by the language accepted by the state $\{x\}$ in the determinised automaton $({\powf X}, \beta^\sharp)$. 


This construction can be generalised~\cite{Silva:2010:Generalizing} to $HT$-coalgebras, where $T \colon \Set \to \Set$ is an underlying functor of finitary monad $\monadT$ and $H \colon \Set \to \Set$ an endofunctor that admits a final coalgebra that can be lifted to the functor $\overline{H} \colon \Set^\monadT \to \Set^\monadT$. Liftings of functors $H \colon \Set \to \Set$ to $\overline{H} \colon \Set^\monadT \to \Set^\monadT$, are in one-to-one correspondence with distributive laws of the monad $\mathsf{T}$ over the functor $H$~\cite{Jacobs:2015:Trace}, which are natural transformations $\rho \colon TH \Rightarrow HT$ satisfying
$H\eta_X = \rho_X \circ \eta_{HX}$ and $H \mu_X \circ \rho_{TX} \circ T\rho_X = \rho_X \circ \mu_{HX}$. In particular, given a $\monadT$-algebra $(X, k \colon TX \to X)$, we can equip $HX$, with a $\monadT$-algebra structure, given by the following composition of maps:
% https://q.uiver.app/#q=WzAsMyxbMCwwLCJUSFgiXSxbMiwwLCJIVFgiXSxbNCwwLCJIWCJdLFswLDEsIlxccmhvX1giXSxbMSwyLCJIdCJdXQ==
\[\begin{tikzcd}
	THX && HTX && HX
	\arrow["{\rho_X}", from=1-1, to=1-3]
	\arrow["Ht", from=1-3, to=1-5]
\end{tikzcd}\]


Generalised determinisation turns $HT$-coalgebras $(X, \beta \colon X \to HT X)$ into $H$-coalgebras $(T X , \beta^\sharp \colon T X \to H T X)$, where $\beta^\sharp$ is the unique extension arising from the free-forgetful adjunction between $\Set$ and $\Set^\monadT$. The language of a state $x \in X$ is given by $\beh{\beta^\sharp} \circ \eta_X \colon X \to \nu H$, where $\eta$ is the unit of the monad $\monadT$. Since $\beta^\sharp \colon TX \to HTX$ can be seen as a $\monadT$-algebra homomorphism $(TX, \mu_X) \to \overline{H}(TX, \mu_X)$, each determinisation $(TX, \beta^{\sharp})$ can be viewed as an $\overline{H}$-coalgebra $((TX, \mu_X), \beta^{\sharp})$. The carrier of the final $H$-coalgebra can be canonically equipped with $\monadT$-algebra structure, yielding the final $\overline{H}$-coalgebra. In such a case, the unique final homomorphism from any determinisation (viewed as an $H$-coalgebra) is precisely an underlying function of the final $\overline{H}$-coalgebra homomorphism. 

\subsection{Subdistribution monad}\label{c4:subsec:subdistribution}
 A function $\nu \colon X \to \interval{0}{1}$ is called a subprobability distribution or subdistribution, if it satisfies $\sum_{x \in X} \nu(x) \leq 1$. A subdistribution $\nu$ is \emph{finitely supported}  if the set $\supp(\nu) = \{x \in X \mid \nu(x) > 0\}$ is finite. We use $\distf {X}$ to denote the set of finitely supported subprobability distributions on $X$. The weight of a subdistribution $\nu \colon X \to \interval{0}{1}$ is a total probability of its support:
$$|\nu| = \sum_{x \in X} \nu(x)$$
Given $\nu\in\distf X$ and $Y \subseteq X$, we will write $\nu[Y] = \sum_{x \in Y} \nu(x)$. This sum is well-defined as only finitely many summands have non-zero probability. 
 
  
 Given $x \in X$, its \emph{Dirac} is a subdistribution $\delta_x$ which is given by $\delta_x(y)=1$ only if $x=y$, and $0$ otherwise. We will moreover write $\emptydist \in \distf X$ for a subdistribution with an empty support. It is defined as $\emptydist(x)=0$ for all $x \in X$. When $\nu_1, \nu_2 \colon X \to \interval{0}{1}$ are subprobability distributions and $p \in \interval{0}{1}$, we write $p\nu_1 + (1-p)\nu_2$ for the convex combination of $\nu_1$ and $\nu_2$, which is the probability distribution given by $$(p \nu_1 + (1-p) \nu_2)(x) = p\nu_1(x) + (1-p)\nu_2(x)$$
 for all $x \in X$. Note that this operation preserves finite support. 
 
  $\distf$ is in fact a functor on the category $\Set$, which maps each set $X$ to $\distf X$ and maps each arrow $f \colon X \to Y$ to the function $\distf \funF \colon \distf X \to \distf Y$ given by $$\distf \funF (\nu)(x) = \sum_{y \in f^{-1}(x)} \nu(y)$$
   Moreover, $\distf$ also  carries a monad structure with unit  $\eta_X(x) = \delta_x$ and multiplication $\mu_X(\Phi)(x) = \sum_{\varphi \in \distf X }\Phi(\varphi)\varphi(x)$ for $\Phi \in \distf^2 X$. Using the free-forgetful adjunction between $\Set$ and category of $\distf$-algebras, given $f \colon X \to \distf Y$, there exists a unique map $f^\sharp \colon \distf X \to \distf Y$ satisfying $f = f^\sharp \circ \delta$ called the \emph{convex extension of $f$}, and explicitly given by $f^\sharp(\nu)(y) = \sum_{x \in X} \nu(x) f(x)(y)$.
   
\subsection{Positive convex algebras}\label{c4:subsec:positive}
By $\sigpca$ we denote a signature given by
$$\sigpca = \left\{\bigboxplus_{i \in I} p_i \cdot (-)_i \mid I \text{ finite}, \forall i \in I \ldotp p_i \in \interval{0}{1}, \sum_{i \in I} p_i \leq 1\right\} $$
A positive convex algebra is a an algebra for the signature $\sigpca$, that is a pair $\A = \left(X, \sigpca^\A\right)$, where $X$ is the carrier set and $\sigpca^\A$ is a set of interpretation functions $\bigboxplus_{i \in I} p_i \cdot (-)_i \colon X^{|I|} \to X$ satisfying the axioms:
\begin{enumerate}
    \item (Projection) \(\bigboxplus_{i \in I} p_i \cdot x_i = x_j\) if \(p_j=1\)
    \item (Barycenter) \(\bigboxplus_{i \in I} p_i \cdot \left(\bigboxplus_{j \in J}{q_{i,j}} \cdot {x_j}\right) = \bigboxplus_{j \in J} \left(\sum_{i \in I} p_i q_{i,j} \right) \cdot x_j\)
\end{enumerate}
In terms of notation, we denote the unary sum by $p_0 \cdot x_0$. Throughout this chapter we will we abuse the notation by writing $$\left(\bigboxplus_{i \in I} p_i \cdot e_i\right) \boxplus \left(\bigboxplus_{i \in J} q_j \cdot f_j\right)$$ for a single sum $\bigboxplus_{k \in I + J} r_k \cdot g_k$, where $r_k = p_k$ and $g_k = e_k$ for $k \in I$ and similarly $r_k = q_k$ and $g_k = f_k$ for $k \in J$. Note that this is well-defined only if $\sum_{i \in I} p_i + \sum_{j \in J} r_j \leq 1$.

The signature of positive convex algebras can be alternatively presented as a family of binary operations, in the following way:

\begin{proposition}\label{c4:prop:binary}
    If  $X$ is a set equipped with a binary operation $\boxplus_{p} : X \times X \to X$ for each $p \in \interval{0}{1}$ and a constant $0_\boxplus \in X$ satisfying for all $x,y,z \in X$ (when defined) the following:
    \begin{gather*}
        x \boxplus_{p} x = x \qquad x \boxplus_{1} y = x \qquad x \boxplus_{p} y = y \boxplus_{1-{p}} x \\ (x \boxplus_{p} y) \boxplus_{q} z = x \boxplus_{pq} \left(y \boxplus_{\frac{(1-p)q}{1-pq}} z\right)
    \end{gather*}
    then $X$ carries the structure of a positive convex algebra. The interpretation of $\boxplus_{i \in I} p_i \cdot (-)_{i}$ is defined inductively by the following
    $$\bigboxplus_{i \in I} p_i \cdot x_i = \begin{cases}
        0_\boxplus & \text{if } I = \emptyset \\
        x_0 & \text{if } p_0 = 1\\
        x_n \boxplus_{p_k} \left(\bigboxplus_{i \in I \setminus \{k\}} \frac{p_i}{1-{p_k}}\cdot x_i  \right) &\text{otherwise, for some } k \in I
    \end{cases} $$
\end{proposition}
%\begin{proof}
%    A straightforward re-adaptation of \cite[Proposition~7]{Bonchi:2017:Power}.
%\end{proof}
Below we state several properties of positive convex algebras, that we will use throughout this chapter.
\begin{proposition}\label{c4:prop:properties_of_positive_convex_algebras}
    Let $I$ be a finite indexed set, and let $\{p_i\}_{i \in I}$ and $\{x_i\}_{i \in I}$ be indexed collections of elements of $\interval{0}{1}$ and $X$ respectively. Then, in any positive convex algebra, the following statements hold:
    \begin{enumerate}
        \item
        $${\bigboxplus_{i \in I} p_i \cdot x_i} = {\bigboxplus_{x \in \bigcup_{i \in I} \{x_i\}} \left(\sum_{x_i = x} p_i\right)\cdot x}$$
        \item Let ${=_R} \subseteq {X \times X}$ be a congruence relation, with $[-]_R \colon X \to X/{=_R}$ being its canonical quotient map. Then, 
        $${\bigboxplus_{i \in I} p_i \cdot x_i} =_R {\bigboxplus_{[x]_R \in \bigcup_{i \in I} \left\{[x_i]_R\right\}} \left(\sum_{x_i =_R x} p_i\right)\cdot x}$$
        \item All terms $\bigboxplus_{i \in I } 0 \cdot x_i $ coincide and are all provably equivalent to the empty convex sum.
        \item If $J \subseteq I$ and $\{i \in I \mid p_i \neq 0\} \subseteq J$, then 
        $$
        \bigboxplus_{i \in I} p_i \cdot x_i = \bigboxplus_{j \in J} p_j \cdot x_j
        $$
        \item Let $\sigma \colon I \to I$ be a permutation of the index set $I$. Then, we have that
        $$
        	\bigboxplus_{i \in I} p_i \cdot x_i = \bigboxplus_{i \in I} p_{\sigma(i)} \cdot x_{\sigma(i)}
        $$
    \end{enumerate}
\end{proposition}
\begin{proof}
    We write $[\Phi]$ to denote Iverson bracket, which is defined to be $1$ if $\Phi$ is true and $0$ otherwise.
    
    For \circlednum{1} we have that
    \begin{align*}
        \bigboxplus_{i \in I} p_i \cdot x_i &= \bigboxplus_{i \in I} p_i \cdot \left( \bigboxplus_{x \in \cup_{i \in I} \{x_i\}} [x_i = x] \cdot  x \right) &\tag{Projection axiom}\\
        &= \bigboxplus_{x \in \cup_{i \in I} \{x_i\}} \left( \sum_{i \in I} p_i[x_i = x] \right) \cdot x \tag{Barycenter axiom} \\
        &=  \bigboxplus_{x \in \cup_{i \in I} \{x_i\} } \left(\sum_{x_i = x} p_i\right) \cdot x
    \end{align*}
    \circlednum{2} can be shown by picking a representative for each equivalence class and then using \circlednum{1}. For \circlednum{3}, by \cite[Lemma~3.4]{Sokolova:2015:Congruences} we know that all terms $\bigboxplus_{i \in I} 0 \cdot x_i$ coincide. To see that they are provably equivalent to the empty convex sum, observe that
    \begin{align*}
        \bigboxplus_{i \in I} 0 \cdot x_i &= \bigboxplus_{i \in I} 0 \cdot \left(\bigboxplus_{j \in \emptyset} p_j \cdot y_j\right)\tag{\cite[Lemma~3.4]{Sokolova:2015:Congruences}}\\
        &= \bigboxplus_{j \in \emptyset} 0 \cdot y_j \tag{Barycenter axiom}\\
    \end{align*}
    Finally, \circlednum{4} follows from \cite[Lemma~3.4]{Sokolova:2015:Congruences}, while \circlednum{5} was proved in \cite[Proposition~3.1]{Doberkat:2008:Erratum}.
\end{proof}
\begin{lemma}\label{c4:lem:flattening_convex_sums}
    Let $I, J$ be finite index sets, $\left\{p_i\right\}_{i \in I}$, $\{q_{i,j}\}_{(i,j) \in I\times J}$ and $\{x_{i,j}\}_{(i,j) \in I \times J}$ indexed collections such that for all $i \in I$ and $j \in J$, $p_i, q_{i,j} \in \interval{0}{1}$ and $x_{i,j} \in X$. If $X$ carries $\pca$ structure, then:
    $$\bigboxplus_{i \in I} p_i \cdot \left(\bigboxplus_{j \in J} q_{i,j} \cdot x_{i,j}\right) = \bigboxplus_{(i,j) \in I \times J} p_iq_{i,j} \cdot x_{i,j}$$
\end{lemma}
\begin{proof}
    \begin{align*}
        \bigboxplus_{i \in I} p_i \cdot \left(\bigboxplus_{j \in J} q_{i,j} \cdot x_{i,j}\right) &= \bigboxplus_{i \in I} p_i \cdot \left(\bigboxplus_{(k,j) \in \{i\} \times J} q_{k,j} \cdot x_{k,j}\right) \\
        &= \bigboxplus_{i \in I} p_i \cdot \left(\bigboxplus_{(k,j) \in I \times J} [k = i]q_{k,j} \cdot x_{k,j}\right) \tag{\Cref{c4:prop:properties_of_positive_convex_algebras}} \\
        &= \bigboxplus_{(k,j) \in I \times J} \left(\sum_{i \in I} p_i [k=i]q_{k,j} \right) \cdot x_{k,j} \tag{Barycenter axiom} \\
        &= \bigboxplus_{(k,j) \in I \times J} p_k q_{k,j}  \cdot x_{k,j} \\
        &= \bigboxplus_{(i,j) \in I \times J} p_i q_{i,j}  \cdot x_{i,j} \tag{Renaming indices}\\
    \end{align*}
\end{proof}
\begin{lemma}\label{c4:lem:grouping_probabilities}
    Let $I$ be a finite index set, $\{p_i\}_{i \in I}$ and $\{q_i\}_{i \in I}$ indexed collections such that $p_i,q_i \in \interval{0}{1}$ for all $i \in I$, $\sum_{i \in I} p_i + \sum_{i \in I} q_i \leq 1$ and let $\{x_i\}_{i \in I}$ and $\{y_i\}_{i \in I}$ indexed collection such that $x_i, y_i \in X$ for all $i \in I$. If $X$ carries $\pca$ structure, then:
    $$
    \left(\bigboxplus_{i \in I} p_i \cdot x_i\right) \boxplus\left(\bigboxplus_{i \in I} q_i \cdot y_i\right) = \bigboxplus_{i \in I} (p_i + q_i) \cdot \left(\frac{p_i}{p_i + q_i} \cdot x_i \boxplus \frac{q_i}{p_i + q_i} \cdot y_i \right)
    $$
\end{lemma}
\begin{proof}
    Let $J = \{0,1\}$. Define indexed collections $\{r_{i,j}\}_{(i,j) \in I \times J}$ and $\{z_{i,j}\}_{(i,j) \in I \times J}$, such that $r_{i,0} = \frac{p_i}{p_i + q_i}$ and $z_{i,0} = x_i$ and $r_{i,1} = \frac{q_i}{p_i + q_i}$ and $z_{i,1} = x_i$.
    We have the following:
    \begin{align*}
        \bigboxplus_{i \in I} (p_i + q_i) \cdot \left(\frac{p_i}{p_i + q_i} \cdot x_i \boxplus \frac{q_i}{p_i + q_i} \cdot y_i\right) &= \bigboxplus_{i \in I} (p_i + q_i) \cdot \left(\bigboxplus_{j \in J} r_{i,j} \cdot z_{i,j} \right) \\
        &= \bigboxplus_{(i,j) \in I \times J} (p_i + q_i)r_{i_j} \cdot z_{i,j} \tag{\Cref{c4:lem:flattening_convex_sums}} \\
        &= \left(\bigboxplus_{i \in I} p_i \cdot x_{i}\right) \boxplus \left(\bigboxplus_{i \in I} q_i \cdot y_i\right)
    \end{align*}
\end{proof}
Speaking more abstractly, positive convex algebras and their homomorphisms (in the sense of homomorphisms of algebras for the signature from universal algebra) form a category, that we will call $\pca$. This category can be seen as a concrete presentation of an Eilenberg-Moore algebra for the subdistribution monad.

\begin{theorem}\label{c4:thm:correspondence}
	There is an isomorphism of categories between $\pca$ and $\Set^{\distf}$. Given a set $X$ equipped with a positive convex algebra structure, we can define a map $h \colon \distf X \to X$, given by 
	$$
		h(\nu) = \bigboxplus_{x \in \supp(\nu)} \nu(x) \cdot x
	$$
	for all $\nu \in \distf X$, making $(X, h)$ into an algebra for the monad $\distf$. Equivalently, given a $\distf$-algebra $(X, h)$, one can define 
	$$
		\bigboxplus_{i \in I} p_i \cdot x_i = h \left(\sum_{i \in I} p_i \cdot \delta_{x_i}\right)
	$$
	for all finite $I$ and indexed collections $\{p_i\}_{i \in I}$, $\{x_i\}_{i \in I}$, such that $\sum_{i \in I} p_i \leq 1$ and for all $i \in I$, $x_i \in X$. This equips the set $X$ with a positive convex algebra structure.  
	\end{theorem}
	\begin{proof}
		See \cite[Theorem~4]{Jacobs:2010:Convexity} or \cite[Proposition~5.3]{Doberkat:2008:Erratum}.
	\end{proof}
	Moreover, $\pca$ as a category enjoys the following property: 
	\begin{theorem}[{\cite{Sokolova:2015:Congruences}}]
		In $\pca$ finitely presented and finitely generated objects coincide.
	\end{theorem}
	\subsection{Rational fixpoint}\label{c4:subsec:rational}
	Let $B \colon \C \to \C$ be a finitary functor. We write $\coaf{B}$ for the subcategory of $\coa{B}$ consisting only of $B$-coalgebras with finitely presentable carrier. The \emph{rational fixpoint} is defined as $(\varrho B,r) = \colim(\coaf{B} \hookrightarrow \coa{B})$ -- a colimit of the inclusion functor from the subcategory of coalgebras with finitely presentable carriers. We call it a fixpoint, as the map $r \colon \varrho B \to B (\varrho B) $ is an isomorphism~\cite{Adamek:2006:Iterative}. 
% The rational fixpoint can be both viewed as a final locally finitely presentable $F$-coalgebra and an initial iterative $F$-algebra~\cite{Adamek:2006:Iterative}. 
Following~{\cite[Corollary~3.10, Theorem~3.12]{Milius:2020:New}}, if finitely presentable and finitely generated objects coincide in $\C$ and $B : \C \to \C$ is a finitary endofunctor preserving non-empty monomorphisms, then rational fixpoint is fully abstract - ie. $(\varrho B, r)$ is a subcoalgebra of the final coalgebra $(\nu B, t)$.

\section{Operational semantics}\label{c4:sec:operational}
{\color{red} Write introduction for the section!}
\subsection{Language semantics of GPTS}\label{c4:subsec:language_semantics}
Let $\funF \colon \Set \to \Set$ be an endofunctor given by $\funF = \{\checkmark\} + \alphabet \times (-)$. GPTS are precisely $\distf \funF$-coalgebras, that is pairs $(X, \beta)$, where $X$ is a set of states and $\beta \colon X \to \distf (\{\checkmark\} + \alphabet \times X)$ is a transition structure. Because of this, we will interchangeably use terms "$\distf \funF$-coalgebra" and "GPTS".

The functor $\distf \funF$ admits a final coalgebra, but unfortunately it is not carried by the set of probabilistic languages, that is $\interval{0}{1}^{\alphabet^{\ast}}$, because the canonical semantics of $\distf \funF$-coalgebras happens to correspond to the more restrictive notion of probabilistic bisimilarity (also known as Larsen-Skou bisimilarity~\cite{Larsen:1991:Bisimulation}). Probabilistic bisimilarity is a branching-time notion of equivalence, requiring observable behaviour of compared states to be equivalent at every step, while probabilistic language equivalence is a more liberal notion comparing sequences of observable behaviour. In general, if two states are bisimilar, then they are language equivalent, but the converse does not hold.
\begin{example}\label{c4:ex:bisimilarity}
 Consider the following {GPTS}:
 \begin{gather*}
\begin{tikzpicture}[baseline=-3ex]
        \node (0) {$q_0$};
        \node (1) [right= 1.25 cm of 0]{$q_1$};
        \node (2) [right= 1.25 cm of 1]{$q_2$};
        \node (o1) [right= 0.75 cm of 2]{$\checkmark$};
        \node (3) [right = 1.8 cm of o1]{$q_3$};
        \node (4) [right= 1.25 cm of 3]{$q_4$};
        \node (5) [right= 1.25 cm of 4]{$q_5$};
        \node (o2) [right= 0.75 cm of 5]{$\checkmark$};
        \draw (0) edge[-latex] node[ fill=white] {\scriptsize\( {a} \mid {\frac{2}{3}}\)} (1);
		\draw (1) edge[-latex] node[ fill=white] {\scriptsize\( {b} \mid {\frac{1}{2}}\)} (2);
		\draw (2) edge[-implies, double, double distance=0.5mm] node[above] {\scriptsize\( 1\)} (o1);
		\draw (3) edge[-latex] node[ fill=white] {\scriptsize\( {a} \mid {\frac{1}{2}}\)} (4);
		\draw (4) edge[-latex] node[ fill=white] {\scriptsize\( {b} \mid {\frac{2}{3}}\)} (5);
		\draw (5) edge[-implies, double, double distance=0.5mm] node[above] {\scriptsize\( 1\)} (o2);
\end{tikzpicture}
\end{gather*}
States $q_0$ and $q_3$ are language equivalent because they both accept the string $ab$ with the probability $\frac{1}{3}$, but are not bisimilar, because the state $q_0$ can make $a$ transition with the probability $\frac{2}{3}$, while $q_3$ can perform an $a$ transition with probability $\frac{1}{2}$.
\end{example}
A similar situation happens when looking at nondeterministic automata through the lenses of universal coalgebra, where again the canonical notion of equivalence is the one of bisimilarity. A known remedy is the powerset construction from classic automata theory, which converts a nondeterministic automaton to a deterministic automaton, whose states are sets of states of the original nondeterministic automaton we have started from. In such a case, the nondeterministic branching structure is factored into the state space of the determinised automaton. The language of an arbitrary state of the nondeterministic automaton corresponds to the language of the singleton set containing that state in the determinised automaton.

Generalised determinisation extends the above idea to $HT$-coalgebras, where $T \colon \Set \to \Set$ is an underlying functor of a finitary monad $\monadT$ and $H \colon \Set \to \Set$ is a functor that can be lifted to category $\Set^\monadT$ of $\monadT$-algebras. Generalised determinisation provides a uniform treatment of language semantics of variety of transition systems, where the final $H$-coalgebra provides a notion of language. Unfortunately, $\distf \funF$-coalgebras do not fit immediately to this picture.  Luckily, each such $\distf \funF$-coalgebra can be seen as a special case of a more general kind of transition system, known as reactive probabilistic transition systems~({RPTS})~\cite{Glabbeek:1995:Reactive} or Rabin probabilistic automata~\cite{Rabin:1963:Probabilistic}. 



{RPTS} can be intuitively viewed as a probabilistic counterpart of nondeterministic automata and they can be determinised to obtain probabilistic language semantics. In an {RPTS}, each state $x$ is mapped to a pair $\langle o_x,n_x \rangle$, where $o \in \interval{0}{1}$ is the acceptance probability of state $x$ and $n_x\colon \alphabet \to \distf(X)$ is the next-state function, which takes a letter $a \in \alphabet$ and returns the subprobability distribution over successor states. Formally speaking, let $\funG \colon \Set \to \Set$ be an endofunctor $\funG = \interval{0}{1} \times (-)^\alphabet$. RPTS are precisely $\funG\distf$-coalgebras, that is pairs $(X, \beta)$, where $X$ is a set of states and $\beta \colon X \to \interval{0}{1} \times \distf (X)^\alphabet$ is a transition function. Following the convention outlined before, we will use terms "$G\distf$-coalgebras" and "RPTS" interchangeably.

$\funG \distf$-coalgebras fit into framework of generalised determinisation~\cite{Silva:2011:Sound}. In particular, there exists a distributive law $\rho \colon \distf \funG \Rightarrow \funG \distf$ of the monad $\distf$ over the functor $\funG$ that allows to lift $\funG \colon \Set \to \Set$ to $\overline{\funG} \colon \pca \to \pca$. Speaking in concrete terms, if the set $X$ is equipped with a convex sum operation $\bigboxplus_{i \in I} p_i \cdot (-)$, then so is $\interval{0}{1} \times X^\alphabet$. Let $\{\langle o_i , t_i\rangle\}_{i \in I}$ be an indexed collection of elements of $\interval{0}{1} \times X^\alphabet$. Then, we can define
\begin{equation}\label{c4:eqn:pca_on_G}
	\bigboxplus_{i \in I} p_i \cdot \langle o_i, t_i \rangle = \left\langle \sum_{i \in I} p_i\cdot o_i, \lambda a\ldotp \bigboxplus_{i \in I} p_i \cdot t_i(a) \right\rangle
\end{equation}
The final coalgebra for the functor $\funG$ is precisely carried by the set $\interval{0}{1}$ of probabilistic languages.

In order to talk about language semantics of $\distf \funF$-coalgebras, we first provide an informal intuition that each $\distf \funF$-coalgebra can be seen as a special case of a $\funG \distf$-coalgebra.
\begin{example}\label{ex:converting}
Fragment of a {GPTS} (on the left) and of the corresponding RPTS (on the right).
 \begin{gather*}
\begin{tikzpicture}[baseline=-3ex]
        \node (o1) {$\checkmark$};
        \node (0) [right= 0.5 cm of o1]{$q_0$};
        \draw (0) edge[-implies, double, double distance=0.5mm] node[above] {\scriptsize\(\frac{1}{4}\)} (o1);
        \node (1) [below left= .9 cm of 0]{$q_1$};
        \node (2) [below right= .9 cm of 0]{$q_2$};
        \draw (0) edge[-latex] node[above, pos=0.6] {\scriptsize\( {a} \mid {\frac{1}{4}}\qquad  \)} (1);
        \draw (0) edge[-latex] node[above, pos=0.6] {\scriptsize\(\quad {a} \mid {\frac{1}{2}}\)} (2);
        \node (o2) [right= 2cm of 0]{$\frac{1}{4}$};
        \node (3) [right= 0.5 cm of o2]{$q_0$};
        \draw (3) edge[-implies, double, double distance=0.5mm] (o2);
        \node (4) [right= 0.75 cm of 3]{$\circ$};
        \draw (3) edge[-latex] node[above] {\scriptsize\( {a}\)} (4);
        \node (5) [below left= 0.9 cm of 4]{$q_1$};
        \node (6) [below right= 0.9 cm of 4]{$q_2$};
        \draw (4) edge[-latex, dashed] node[left, pos = 0.1] {\scriptsize\( {\frac{1}{4}}\quad\)} (5);
        \draw (4) edge[-latex, dashed] node[right, pos = 0.1] {\scriptsize\(\quad {\frac{1}{2}}\)} (6);
%        \node (2) [right= 1.25 cm of 1]{$q_2$};
%        \node (o1) [right= 0.75 cm of 2]{$\checkmark$};
%        \node (3) [below = 0.6 cm of 0]{$q_3$};
%        \node (4) [right= 1.25 cm of 3]{$q_4$};
%        \node (5) [right= 1.25 cm of 4]{$q_5$};
%        \node (o2) [right= 0.75 cm of 5]{$\checkmark$};
%        \draw (0) edge[-latex] node[ fill=white] {\scriptsize\( {a} \mid {\frac{2}{3}}\)} (1);
%		\draw (1) edge[-latex] node[ fill=white] {\scriptsize\( {b} \mid {\frac{1}{2}}\)} (2);
%		\draw (2) edge[-implies, double, double distance=0.5mm] node[above] {\scriptsize\( 1\)} (o1);
%		\draw (3) edge[-latex] node[ fill=white] {\scriptsize\( {a} \mid {\frac{1}{2}}\)} (4);
%		\draw (4) edge[-latex] node[ fill=white] {\scriptsize\( {b} \mid {\frac{2}{3}}\)} (5);
\end{tikzpicture}
\end{gather*}
In the corresponding {RPTS} state $q_0$ accepts with probability $\frac{1}{4}$ and given input $a$ it transitions to subprobability distribution that has $\frac{1}{4}$ probability of going to to $q_1$ and $\frac{1}{2}$ probability of going to $q_2$. \end{example}

We can make the above intuition formal. Let $X$ be a set, and let $\zeta \in \distf \funF X$. Define a function $\gamma_X \colon \distf \funF X \to \funG \distf X$, given by
$$
\gamma_X(\zeta) = \langle \zeta(\checkmark), \lambda a \ldotp \lambda x\ldotp \zeta(a,x)\rangle
$$
Such functions define components of the natural transformation.
\begin{proposition}{\cite{Silva:2011:Sound}}\label{c4:prop:natural}
	$\gamma \colon \distf \funF \Rightarrow \funG \distf$ is a natural transformation with injective components. 
\end{proposition}
We now have all ingredients to specify language semantics of $\distf \funF$-coalgebras. Given a $\distf \funF$-coalgebra  $(X, \beta)$, one can use the natural transformation $\gamma$ and obtain $\funG \distf$-coalgebra $(X, \gamma_X \circ \beta)$. Since $\funG$ can be lifted to $\pca$, we can obtain $\funG$-coalgebra $\left(\distf X, (\gamma_X \circ \beta)^\sharp\right)$. Note that this coalgebra carries an additional algebra structure and its transition map is a $\pca$ homomorphism, thus making $\left( (\distf X, \mu_X), (\gamma_X \circ \beta)^\sharp \right)$ into a $\overline{\funG}$-coalgebra. The resulting language semantics of $(X, \beta)$ are given by the map $\langmap_{(X, \beta)} \colon X \to \interval{0}{1}^\alphabet$ explicitly given by $$\langmap_{(X, \beta)} = \beh{(\gamma_X \circ \beta)^\sharp} \circ \eta_X$$ where $\eta \colon X \to \distf X$ is a unit of the monad $\distf$ taking each state $x \in X$ to its Dirac $\delta_x \in \distf X$.

This can be summarised by the following commutative diagram:
% https://q.uiver.app/#q=WzAsNixbMCwwLCJYIl0sWzAsMSwiXFxkaXN0ZiBcXGZ1bkYgWCJdLFsxLDAsIlxcZGlzdGYgWCJdLFswLDIsIlxcZnVuRyBcXGRpc3RmIFgiXSxbMywwLCJcXGludGVydmFsezB9ezF9XlxcYWxwaGFiZXQiXSxbMywyLCJcXGZ1bkcgXFxsZWZ0KFxcaW50ZXJ2YWx7MH17MX1ee1xcYWxwaGFiZXR9XFxyZ2l0aCkiXSxbMCwxLCJcXGJldGEiXSxbMSwzLCJcXGdhbW1hX1giXSxbMCwyLCJcXGV0YV9YIl0sWzIsMywiKFxcZ2FtbWFfWCBcXGNpcmMgXFxiZXRhKV5cXHNoYXJwIiwwLHsic3R5bGUiOnsiYm9keSI6eyJuYW1lIjoiZGFzaGVkIn19fV0sWzQsNSwidCJdLFsyLDQsIlxcYmVoeyhcXGdhbW1hX1ggXFxjaXJjIFxcYmV0YSleXFxzaGFycH0iLDAseyJzdHlsZSI6eyJib2R5Ijp7Im5hbWUiOiJkYXNoZWQifX19XSxbMyw1LCJcXGZ1bkcgXFxiZWh7KFxcZ2FtbWFfWCBcXGNpcmMgXFxiZXRhKV5cXHNoYXJwfSIsMCx7InN0eWxlIjp7ImJvZHkiOnsibmFtZSI6ImRhc2hlZCJ9fX1dXQ==
\[\begin{tikzcd}
	X & {\distf X} && {\interval{0}{1}^{\alphabet^\ast}} \\
	{\distf \funF X} \\
	{\funG \distf X} &&& {\funG \left(\interval{0}{1}^{\alphabet^\ast}\right)}
	\arrow["{\eta_X}", from=1-1, to=1-2]
	\arrow["\beta", from=1-1, to=2-1]
	\arrow["{\beh{(\gamma_X \circ \beta)^\sharp}}", dashed, from=1-2, to=1-4]
	\arrow["{(\gamma_X \circ \beta)^\sharp}", dashed, from=1-2, to=3-1]
	\arrow["t", from=1-4, to=3-4]
	\arrow["{\gamma_X}", from=2-1, to=3-1]
	\arrow["{\funG \beh{(\gamma_X \circ \beta)^\sharp}}", dashed, from=3-1, to=3-4]
\end{tikzcd}\]

The language semantics defined above coincide with the explicit definition of $\langmap$ we gave in \Cref{c4:eqn:language} (this is a consequence of a result in~\cite{Silva:2011:Sound}). 



Moreover, the natural transformation $\gamma \colon \distf \funF \Rightarrow \funG \distf$ interacts well with the distributive law $\rho \colon \distf \funG \Rightarrow \funG \distf$, making the following diagram commute:
% https://q.uiver.app/#q=WzAsNSxbMCwwLCJcXGRpc3RmXjIgXFxmdW5GIl0sWzAsMSwiXFxkaXN0ZiBcXGZ1bkcgXFxkaXN0ZiJdLFsyLDEsIlxcZnVuRyBcXGRpc3RmXjIiXSxbNCwxLCJcXGZ1bkdcXGRpc3RmIl0sWzQsMCwiXFxkaXN0ZlxcZnVuRiJdLFswLDEsIlxcZGlzdGYgXFxnYW1tYSIsMl0sWzEsMiwiXFxyaG9fXFxkaXN0ZiIsMl0sWzIsMywiXFxmdW5HIFxcbXUiLDJdLFs0LDMsIlxcZ2FtbWEiXSxbMCw0LCJcXG11X1xcZnVuRyJdXQ==
\[\begin{tikzcd}
	{\distf^2 \funF} &&&& {\distf\funF} \\
	{\distf \funG \distf} && {\funG \distf^2} && {\funG\distf}
	\arrow["{\mu_\funG}", from=1-1, to=1-5]
	\arrow["{\distf \gamma}"', from=1-1, to=2-1]
	\arrow["\gamma", from=1-5, to=2-5]
	\arrow["{\rho_\distf}"', from=2-1, to=2-3]
	\arrow["{\funG \mu}"', from=2-3, to=2-5]
\end{tikzcd}\]
The above is a consequence of $\gamma \colon \distf \funF \Rightarrow \funG \distf$ being so-called extension law -- for more details see~\cite[Section~7.2]{Jacobs:2015:Trace}. Using this fact, we can show the following:
\begin{proposition}\label{c4:prop:extension}
	For any $\distf \funF$-coalgebra $(X, \beta)$, the following diagram commutes:
	% https://q.uiver.app/#q=WzAsNCxbMCwwLCJcXGRpc3RmIFgiXSxbMiwwLCJcXGRpc3RmXjJcXGZ1bkYgWCJdLFs0LDAsIlxcZGlzdGYgXFxmdW5GIFgiXSxbNiwwLCJcXGZ1bkcgXFxkaXN0ZiBYIl0sWzAsMSwiXFxkaXN0ZiBcXGJldGEiXSxbMSwyLCJcXG11X1xcZnVuRiJdLFsyLDMsIlxcZ2FtbWFfWCJdLFswLDMsIihcXGdhbW1hX1ggXFxjaXJjIFxcYmV0YSleXFxzaGFycCIsMCx7ImN1cnZlIjotNX1dXQ==
\[\begin{tikzcd}
	{\distf X} && {\distf^2\funF X} && {\distf \funF X} && {\funG \distf X}
	\arrow["{\distf \beta}", from=1-1, to=1-3]
	\arrow["{(\gamma_X \circ \beta)^\sharp}", curve={height=-30pt}, from=1-1, to=1-7]
	\arrow["{\mu_{\funF X}}", from=1-3, to=1-5]
	\arrow["{\gamma_X}", from=1-5, to=1-7]
\end{tikzcd}\]
\end{proposition}
\begin{proof}
	We first argue that $ (\gamma_X \circ \beta)^\sharp \circ \eta_X =  \gamma_X \circ \mu_{\funF X} \circ \distf \beta \circ \eta_X  $
	\begin{align*}
		\eta_X \circ \distf \beta \circ \mu_{\funF X} \circ \gamma_X &= \beta\circ \eta_{\distf \funF X} \circ \mu_{\funF X} \circ \gamma_X \tag{$\eta$ is natural}\\
		&= \beta \circ \gamma_X \tag{Monad laws}\\
		&= (\beta \circ \gamma_X)^\sharp \circ \eta_X \tag{Kleisli extension} 
	\end{align*}
	Then, we argue that $\gamma_X \circ \mu_{\funF X} \circ \distf \beta$ is a $\pca$ homomorphism from the free $\pca$ $(X, \mu_X)$ to $\overline{\funG}(X, \mu_X)$, by checking the commutativity of the diagram below.
	% https://q.uiver.app/#q=WzAsOSxbMCwyLCJcXGRpc3RmIFgiXSxbMCwwLCJcXGRpc3RmXjJYIl0sWzIsMiwiXFxkaXN0Zl4yXFxmdW5GIFgiXSxbMiwwLCJcXGRpc3RmXjMgXFxmdW5GIFxcYmV0YSJdLFs0LDIsIlxcZGlzdGYgXFxmdW5GIFgiXSxbNCwwLCJcXGRpc3RmXjIgXFxmdW5GIFgiXSxbNiwyLCJcXGZ1bkcgXFxkaXN0ZiBYIl0sWzYsMCwiXFxkaXN0ZiBcXGZ1bkYgXFxkaXN0ZlgiXSxbNiwxLCJcXGZ1bkdeMiBcXGRpc3RmIFgiXSxbMSwwLCJcXG11X1giLDJdLFswLDIsIlxcZGlzdGYgXFxiZXRhIiwyXSxbMSwzLCJcXGRpc3RmXjIgXFxiZXRhIl0sWzMsMiwiXFxtdV97XFxkaXN0ZiBcXGZ1bkYgWH0iXSxbMiw0LCJcXG11X3tcXGZ1bkYgWH0iXSxbNSw0LCJcXG11X3tcXGRpc3RmIFxcZnVuRiBYfSIsMl0sWzMsNSwiXFxkaXN0ZiBcXG11X3tcXGZ1bkYgWH0iXSxbNCw2LCJcXGdhbW1hX1giXSxbNSw3LCJcXGRpc3RmIFxcZ2FtbWFfWCJdLFs3LDgsIlxccmhvX3tcXGRpc3RmIFh9Il0sWzgsNiwiXFxmdW5HIFxcbXVfWCJdXQ==
\[\begin{tikzcd}
	{\distf^2X} && {\distf^3 \funF X} && {\distf^2 \funF X} && {\distf \funF \distf X} \\
	&&&&&& {\funG^2 \distf X} \\
	{\distf X} && {\distf^2\funF X} && {\distf \funF X} && {\funG \distf X}
	\arrow["{\distf^2 \beta}", from=1-1, to=1-3]
	\arrow["{\mu_X}"', from=1-1, to=3-1]
	\arrow["{\distf \mu_{\funF X}}", from=1-3, to=1-5]
	\arrow["{\mu_{\distf \funF X}}", from=1-3, to=3-3]
	\arrow["{\distf \gamma_X}", from=1-5, to=1-7]
	\arrow["{\mu_{\distf \funF X}}"', from=1-5, to=3-5]
	\arrow["{\rho_{\distf X}}", from=1-7, to=2-7]
	\arrow["{\funG \mu_X}", from=2-7, to=3-7]
	\arrow["{\distf \beta}"', from=3-1, to=3-3]
	\arrow["{\mu_{\funF X}}", from=3-3, to=3-5]
	\arrow["{\gamma_X}", from=3-5, to=3-7]
\end{tikzcd}\]
The left diagram commutes because $\mu$ is natural, while the middle one commutes because of $\mu$ being a multiplication map of the monad. Finally, the commutativity of the rightmost subdiagram is guaranteed by $\gamma$ being an extension law (see discussion above).

Since, $\mu_{\funF X} \circ \distf \beta \circ \eta_X $ is a $\pca$ homomorphism that factorises through $\eta$ in the same way as $(\gamma_X \circ \beta)^\sharp $, we have that  $ (\gamma_X \circ \beta)^\sharp =  \gamma_X \circ \mu_{\funF X} \circ \distf \beta$.
\end{proof}
\subsection{Antimirov derivatives}\label{c4:subsec:antimirov}
We now equip $\PExp$ with a $\distf \funF$-coalgebra structure, that is, we define a function $\partial : \PExp \to \distf (1+A\times \PExp)$. We refer to $\partial$ as the \emph{Antimirov derivative}, as it is reminiscent of the analogous construction
for regular expressions and nondeterminisic automata due to Antimirov~\cite{Antimirov:1996:Partial}. Given $a \in \alphabet$, $e,f \in \PExp$ and $p \in \interval{0}{1}$ we define:
\begin{gather*}
    \partial(\zero) = \emptydist \quad\quad \partial(\one)=\delta_{\checkmark} \quad\quad \partial(a)=\delta_{(a,\one)}  \\  \partial(e \oplus_p f)=p\partial(e) + (1-p)\partial(f)
\end{gather*}
The expression $\zero$ is mapped to the empty subdistribution, intuitively representing a deadlock. On the other hand, the expression $\one$ represents immediate acceptance, that is it transitions to $\checkmark$ with probability $1$. For any letter $a \in \alphabet$ in the alphabet, the expression $a$ performs $a$-labelled transition to $\one$ with probability $1$. The outgoing transitions of the probabilistic choice $e \oplus_p f$ consist of the outgoing transitions of $e$ with
probabilities scaled by $p$ and the outgoing transitions of $f$ scaled by $1-p$.

The definition of $\partial(e;f)$ is slightly more involved. We need to factor in the possibility that $e$ may accept with some probability $t$, in which case the outgoing transitions of $f$ contribute to the outgoing transitions of $e \seq f$. Formally, $\partial(e \seq f) = \partial(e) \lhd f$ where for any $f \in \PExp$ the operation $( - \lhd f) : \distf \funF \PExp \to \distf \funF \PExp$ is given by $( - \lhd f) = {c_f}^{\sharp}$, the convex extension of $c_f : 1+A\times \PExp \to \distf (1+A \times \PExp)$ given below on the left.
\begin{gather*}
c_f(x) = \begin{cases}
    \partial(f) & x = \checkmark \\
    \delta_{(a, e' \seq f)} & x = (a,e')
\end{cases}\qquad\qquad
\begin{tikzpicture}[baseline=-5ex]
        \node (0) {${e}\seq{f}$};
        \node (4) [below=.75cm of 0] {${e}'{ {} \seq {f}}$};
        \node (5) [left=0.5cm of 0] {{ \bcancel\checkmark}};
            \node (5a) [left=-.2cm of 5] {{ \(\partial({f})\)}};
        \draw (0) edge[-implies, double, double distance=0.5mm] node[above] {\({t}\)} (5);
        \draw (0) edge[-latex] node[left] {\footnotesize\( {a} \mid {s}\)} (4);
\end{tikzpicture}
\end{gather*}
Intuitively, $c_{f}$ reroutes the transitions coming out of ${e}$: acceptance (the first case) is replaced by the behaviour of ${f}$, and the probability mass of transitioning to ${e}'$ (the second case) is reassigned to $ e\seq f$.
A pictorial representation of the effect on the derivatives of ${e} \seq {f}$ is given above on the right.
Here, we assume that \(\partial({e})\) can perform a \({a}\)-transition to \({e'}\) with probability \({s}\); we make the same assumption in the informal descriptions of derivatives for the loops, below. 

For loops, we require $\partial\left(e^{[p]}\right)$ to be the least subdistribution satisfying $\partial\left(e^{[p]} \right) =  p \partial(e) \lhd e^{{[p]}} + (1-p) \partial(\checkmark)$. In the case when $\partial(e)(\checkmark)\neq 0$, the above becomes a fixpoint equation (as in such a case, the unrolling of the definition of $(- \lhd e^{[p]})$ involves $\partial \left( e{[p]}\right)$). We can define $\partial \left( e^{[p]} \right)$ as a closed form, but we need to consider two cases. If $\partial(e)(\checkmark)=1$ and $p = 1$, then the loop body is constantly executed, but the inner expression $e$ does not perform any labelled transitions. We identify such divergent loops with deadlock behaviour and hence $\partial(e^{[p]})(x)=0$. Otherwise, we look at $\partial(e)$ to build $\partial\left({e}^{[p]}\right)$. First, we make sure that the loop may be skipped with probability $1-p$.
Next, we modify the branches that perform labelled transitions by adding ${e}^{[p]}$ to be executed next.
The remaining mass is $p\partial(e)(\checkmark)$, the probability that we will enter the loop and immediately exit it without performing any labelled transitions. We discard this possibility and redistribute it among the remaining branches. 
As before, we provide an informal visual depiction of the probabilistic loop semantics below, using the same conventions as before. The crossed-out checkmark along with the dashed lines denotes the redistribution of probability mass described above.
\[
	\begin{tikzpicture}
        \node (0) {${e}^{[p]}$};
        \node (6) [below=.5cm of 0] {\checkmark};
        \node (4) [right=2cm of 0] {${e}'{ \seq {e}^{[{p}]}}$};
        \node (5) [left=.5cm of 0] {{ \(\bcancel{\checkmark}\)}};
        \draw (0) edge[-implies, double, double distance=0.5mm] node[left] {\footnotesize \(\frac{1-{p}}{1-{pt}}\)} (6);
        \draw (0) edge[-implies, double, double distance=0.5mm, pos=0.3] node[above, gray] {\({pt}\)} (5);
        \draw (0) edge[-latex] node[above] {\footnotesize\( {a} \mid {{{p}}}{s}/{ (1-{pt})}\)} (4);
        \draw (5) edge[->,dashed,bend left, out=90] ($(4.west) + (-0.5,0.35)$);
        \draw (5) edge[->,dashed,bend right, out=-90] ($(6.west) + (-0.5,0.35)$);
  %      \draw[dotted,bend right=20] (5) edge[-latex] (4);
   %     \draw[dotted,bend left=20] (5) edge[-latex] (6);
    \end{tikzpicture}
\]
Formally speaking, the definition of $\partial\left({e}^{[{p}]}\right)$ can be given by the following:
\begin{gather*}
\partial\left(e^{[p]}\right)(x)= \begin{cases}
    \frac{1-p}{1-p\partial(e)(\checkmark)} & x = \checkmark \\[1.2ex]
    \frac{p\partial(e)(a,e')}{1-p\partial(e)(\checkmark)} & x = (a, (e' \seq e^{[p]}))\\
    0 & \text{otherwise}
\end{cases}
\end{gather*}
% Having defined the semantics, we can easily observe that the termination operator $E : \PExp \to \interval{0}{1}$ captures the probability of immediate acceptance.
% \begin{restatable}{lemma}{exitoperatorlemma}\label{c4:lem:exit_operator_lemma}
% For all $e \in \PExp$ it holds that $E(e)=\partial(e)(\checkmark)$
% \end{restatable}
% In our case, the canonical concept of coalgebraic bisimilarity (which in the case of {GPTS} directly corresponds to the notion from~\cite{Larsen:1991:Bisimulation}) is too discriminating notion of equivalence. For example, the states in the Brzozowski transition system for expressions $(a \oplus_{\frac{1}{2}} \zero) \seq (b \oplus_{\frac{1}{3}} \zero) $ and $(a \oplus_{\frac{1}{3}} \zero) \seq (b \oplus_{\frac{1}{2}} \zero) $ both generate a word $ab$ with probability $\frac{1}{6}$, while not being bisimilar. The state for the first expression can perform an $a$-transition with probability $\frac{1}{2}$, while the second one performs the same action with the probability of $\frac{1}{3}$, thus making them distinguished by the notion of bisimilarity.

% As mentioned before, if we omit the axioms marked with $\heartsuit$ from \cref{fig:axioms}, we obtain a coarser congruence relation ${\equiv_b} \subseteq \PExp \times \PExp$, sound wrt. coalgebraic bisimilarity. 
% % We will later use it in the proof of soundness of our axiomatisation wrt. language equivalence, as an intermediate step.
% \begin{restatable}{lemma}{soundnessbisim}\label{c4:lem:soundness_bisim}
%     The relation ${\equiv_b} \subseteq {\PExp \times \PExp}$ is a bisimulation equivalence
% \end{restatable}
% As a consequence~\cite{Rutten:2000:Universal}, there exists a unique coalgebra structure $\qcoa : {\PExp}/{\equiv_b} \to \distf \funF {\PExp}/{\equiv_b}$, which makes the quotient map $[-]_{\equiv_b} : \PExp \to {\PExp}/{\equiv_b}$ into $\distf \funF$-coalgebra homomorphism from $(\PExp, \equiv)$ to $({{\PExp}/{\equiv_b}}, \qcoa)$.

Having defined the Antimirov transition system, one can observe that the termination operator $E(-) \colon \PExp \to \interval{0}{1}$ precisely captures the probability of an expression transitioning to $\checkmark$ (successful termination) when viewed as a state in the Antimirov {GPTS}.

\begin{lemma}\label{c4:lem:exit_operator_lemma}
    For all $e \in \PExp$ it holds that $E(e)=\partial(e)(\checkmark)$.
\end{lemma}
\begin{proof}
By structural induction. The base cases $E(\zero)=0=\partial(\zero)(\checkmark)$, $E(\one)=1=\partial(\one)(\checkmark)$ and $E(a)=0=\partial(a)(\checkmark)$ hold immediately. For the inductive steps, we have the following:
\begin{itemize}
	 \item[] \fbox{Probabilistic choice}
	 	\begin{align*}
	 		E(e \oplus_p f) &= pE(e) + (1-p)E(f)\\ &= p\partial(e)(\checkmark) + (1-p)\partial(f)(\checkmark)\\ &= \partial(e \oplus_p f)(\checkmark)
	 	\end{align*}
	 \item[] \fbox{Sequential compositon}
	 \begin{align*}
	 	E(e \seq f)&=E(e)E(f)\\
	 	&=\partial(e)(\checkmark)\partial(f) (\checkmark)\\
	 	&= (\partial (e) \lhd f)(\checkmark)\\
	 	&=\partial(e \seq f)(\checkmark)
	 \end{align*}
	 \item[] \fbox{Loops} First, we consider the case when $\partial(e)(\checkmark)=1$ and the loop probability is $1$. By induction hypothesis, also $E(e)=1$ and hence $E\left(e^{[1]}\right)=\partial\left(e^{[1]}\right)(\checkmark)$. Otherwise, we have the following:
	\begin{align*}
		E(e^{[p]})&=\frac{1-p}{1-pE(e)}\\
		&=\frac{1-p}{1-p\partial(e)(\checkmark)}\\
		&=\partial\left(e^{[p]}\right)(\checkmark)
	\end{align*}
\end{itemize}
\end{proof}


Given an expression $e \in \PExp$, we write $\langle e\rangle \subseteq \PExp$ for the set of states reachable from $e$ by repeatedly applying $\partial$.
It turns out that the operational semantics of every {PRE} can be always described by a finite-state {GPTS} given by $(\langle e \rangle, \partial)$.
\begin{lemma}\label{c4:lem:locally_finite}
    For all $e \in \PExp$, the set $\langle e \rangle$ is finite. In fact, the number of of states is bounded above by $\#(-) \colon \PExp \
    \to \N$, where $\#(-)$ is defined recursively by:
    \begin{align*}
        \#(\zero)=\#(\one)=1 \quad \#(a) = 2 \quad \#(e \oplus_p f) = \#(e) + \#(f)\\ 
        \#(e \seq f) = \#(e) + \#(f) \quad \#(e^{[p]}) = \#(e) + 1
    \end{align*}
\end{lemma}
\begin{proof}
    We adapt the analogous proof for {GKAT}~\cite{Schmid:2021:Guarded}.

    For any \({e} \in \PExp\), let \(|\langle e \rangle|\) be the cardinality of the carrier set of the least subcoalgebra of \((\PExp, \partial)\) containing \(e\). We show by induction that for all \(e \in \PExp\) it holds that \(|\langle e \rangle|\leq \#({e})\).

     For the base cases, observe that for $\zero$ and $\one$ the subcoalgebra has exactly one state. Hence, \(\#(\zero) = 1 = |\langle \zero \rangle|\). Similarly, we have \(\#(\one) = 1 = |\langle \one \rangle|\).
    For \(a \in \alphabet\), we have two states; the initial state, which transitions with probability \(1\) on \(a\) to the state which outputs \(\checkmark\) with probability \(1\).

    For the inductive cases, assume that \(|\langle e \rangle| \leq \#(e)\), \(|\langle f \rangle| \leq \#(f)\) and \(p \in \interval{0}{1}\).
     \begin{itemize}
         \item
         Every derivative of \({e} \oplus_p {f}\) is either a derivative of \({e}\) or \({f}\) and hence \(|\langle e \oplus_p f \rangle| \leq |\langle e \rangle| + |\langle f \rangle| = \#({e}) + \#({f}) = \#({e} \oplus_p {f})\).
         \item
         In the case of \({e}\seq{f}\), every derivative of this expression is either a derivative of \({f}\) or some derivative of \({e}\) followed by \({f}\). Hence, \(|\langle e \seq f \rangle| = |\langle e \rangle\times \{{f}\}| + |\langle f \rangle| \leq \#({e}) + \#({f}) = \#({e}\seq{f}) \).

         \item
         For the probabilistic loop case, observe that every derivative of \({e}^{[{p}]}\) is a derivative of \({e}\) followed by \({e}^{[{p}]}\) or it is the state that outputs $\checkmark$ with probability $1$. It can be easily observed,that \(|\langle e^{[p]}\rangle| \leq |\langle e \rangle| + 1 = \#({e}) = \#({e}^{[p]})\). 
    \end{itemize}
\end{proof}



\begin{example} Operational semantics of the expression $e = a \oplus_{\frac{3}{4}} a \seq a^{[\frac{1}{4}]}\seq a$ correspond to the following {GPTS}: 
\begin{center}
\begin{tikzpicture}%[baseline=0ex]
        \node (2) {$a \oplus_{\frac{3}{4}} a \seq a^{[\frac{1}{4}]}\seq a$};
        \node (2a) [ right= 2 cm of 2]{};
        \node (3) [below= .5 cm of 2a] {$a^{[\frac{1}{4}]}\seq a$};
        \draw (2) edge[-latex] node[below] {\scriptsize\( {a} \mid {\frac{1}{4}}\)} (3);
        \draw (3) edge[-latex,out=-20,in=0,looseness=6] node[right] {\scriptsize\( {a} \mid {\frac{1}{4}}\)} (3);
        \node (4) [right= 4.5 cm of 2] {$\one$};
        \draw (3) edge[-latex] node[below] {\scriptsize\( {a} \mid {\frac{3}{4}}\)} (4);
        \draw (2) edge[-latex] node[ fill=white] {\scriptsize\( {a} \mid {\frac{3}{4}}\)} (4);
        \node (o2) [right= 0.75 cm of 4]{$\checkmark$};
        \draw (4) edge[-implies, double, double distance=0.5mm] node[above] {\scriptsize\( 1\)} (o2);
\end{tikzpicture}
\end{center}
One can observe that the transition system above for $e$ is isomorphic to the one starting in $q_2$ in \cref{ex:systems}.
\end{example}

Given the finite-state {GPTS} $(\langle e \rangle, \partial)$ associated with an expression $e\in \PExp$ we can define the language semantics of $e$ as the probabilistic language $\llbracket e\rrbracket \in \interval{0}{1}^{\alphabet^*}$ generated by the state $e$ in the {GPTS} $(\langle e \rangle, \partial)$. 

\subsection{Roadmap to soundness and completeness}\label{c4:subsec:roadmap}
The central aim of this chapter is to show that the axioms in \Cref{c4:fig:axioms} are sound and complete to reason about probabilistic language equivalence of {PRE}, that is:
\[
e \equiv f \quad \begin{array}{c} {\text{\tiny Completeness}} \\ \Longleftarrow\\ \Longrightarrow\\ {\text{\tiny Soundness}} \end{array} \llbracket e\rrbracket = \llbracket f\rrbracket
\]
We now sketch the roadmap on how we will prove these two results to ease the flow into the upcoming technical sections. Perhaps not surprisingly, the completeness direction is the most involved. 
%However, because of the rich algebraic structure of probabilistic languages, the soundness direction is not a simple straightforward inductive proof as in the case of regular expressions. 

The heart of both arguments will rely on arguing that the semantics map $\llbracket - \rrbracket \colon \PExp \to \interval{0}{1}^{\alphabet^\ast}$ assigning a probabilistic language to each expression can be seen as the following composition of maps:
% https://q.uiver.app/#q=WzAsMyxbMCwwLCJcXEV4cCJdLFsyLDAsIntcXEV4cH0ve1xcZXF1aXZ9Il0sWzQsMCwiWzAsMV1ee0FeKn0iXSxbMCwxLCJbLV0iXSxbMSwyLCJcXGRhZ2dlciBkIl0sWzAsMiwiXFxsbGJyYWNrZXQtXFxycmJyYWNrZXQiLDIseyJjdXJ2ZSI6M31dXQ==
\[\begin{tikzcd}
	\PExp && {{\PExp}/{\equiv}} && {\interval{0}{1}^{\alphabet^*}}
	\arrow["{[-]}", from=1-1, to=1-3]
	\arrow["{\beh{d}}", from=1-3, to=1-5]
	\arrow["{\llbracket-\rrbracket}"', curve={height=20pt}, from=1-1, to=1-5]
\end{tikzcd}\] 
In the picture above $[-] \colon \PExp \to {\PExp}/{\equiv}$ is a quotient map taking expressions to their equivalence class modulo the axioms of $\equiv$, while $\beh{d} \colon {\PExp}/{\equiv} \to \interval{0}{1}^{\alphabet^\ast}$ is a map taking each equivalence class to the corresponding probabilistic language. In such a case, soundness follows as a sequence of three steps:
\begin{equation}\label{eq:sound}
 e\equiv f\Rightarrow [e]=[f] \Rightarrow \beh{d} ([e])  = \beh{d} ( [f] ) \Rightarrow \llbracket e\rrbracket = \llbracket f\rrbracket 
 \end{equation}
 To obtain completeness we want to reverse all implications in \Cref{eq:sound}--and they all are easily reversible except $[e]=[f] \Rightarrow \beh{d} ( [e] )  =  \beh{d} ( [f] )$. To obtain this reverse implication we will need to show that $\beh{d} $ is {\em injective}.
 
 {\color{red} Complete the roadmap!}
 \section{Soundness}\label{c4:sec:soundness}
 \subsection{Step 1: Soundness with respect to bisimilarity}
 We first check that a subset of axioms generating $\equiv$ is sound with respect to bisimilarity of $\distf \funF$-coalgebras, which is a coarser notion of equivalence than probabilistic language equivalence. 
 {\color{red} Define the quotient maps!}
 
 Let ${\equiv_b} \subseteq {\PExp \times \PExp}$ denote the least congruence relation closed under the axioms on \Cref{c4:fig:axioms} except (\textsf{S0}) and (\textsf{D2}). 

A straightforward induction on the length derivation of $\equiv_b$ allows us to show that this relation is a bisimulation equivalence on $(\PExp, \partial)$. As mentioned before, in the case of {GPTS} this notion corresponds to bisimulation equivalences in the sense of Larsen and Skou~\cite{Larsen:1991:Bisimulation}.
\begin{restatable}{lemma}{soundnessbisim}\label{c4:lem:soundness_bisim}
    The relation ${\equiv_b} \subseteq {\PExp \times \PExp}$ is a bisimulation equivalence.
 \end{restatable}
As a consequence of \Cref{c4:lem:soundness_bisim} and \Cref{c2:lem:quotient_coalgebra}, there exists a unique coalgebra structure $\qcoa \colon {\PExp}/{\equiv_b} \to \distf \funF {\PExp}/{\equiv_b}$, which makes the quotient map $[-]_{\equiv_b} \colon \PExp \to {\PExp}/{\equiv_b}$ into a $\distf \funF$-coalgebra homomorphism from $(\PExp, \partial)$ to $({{\PExp}/{\equiv_b}},\qcoa)$. It turns out, that upon converting those $\distf \funF$-coalgebras to $\funG \distf$-coalgebras using the natural transformation $\rho \colon \distf \funF \to \funG \distf$ and determinising them, $\distf [-]_{\equiv_b} \colon \distf \PExp \to \distf {\PExp}/{\equiv_b}$ becomes a homomorphism between the determinisations. 
\begin{lemma}\label{c4:lem:homom_of_determinisations}
	$\distf [-]_{\equiv_b} \colon \distf \PExp \to \distf {\PExp}/{\equiv_b}$ is a $\funG$-coalgebra homomorphism from $(\distf \PExp, (\rho_{\PExp} \circ \partial)^\sharp)$ to  $(\distf {\PExp}/{\equiv_b}, (\rho_{{\PExp}/{\equiv_b}} \circ \qcoa)^\sharp)$. In other words, the following diagram commutes:
% https://q.uiver.app/#q=WzAsOCxbMCwxLCJcXFBFeHAiXSxbMCwyLCJcXGRpc3RmIFxcZnVuRiBcXFBFeHAiXSxbMCwzLCJcXGZ1bkdcXGRpc3RmIFxcUEV4cCJdLFsxLDAsIlxcZGlzdGYgXFxQRXhwIl0sWzIsMSwiXFxQRXhwL3tcXGVxdWl2X2J9Il0sWzMsMCwiXFxkaXN0ZiB7e1xcUEV4cH0ve1xcZXF1aXZfYn19Il0sWzIsMywiXFxmdW5HXFxkaXN0ZiB7XFxQRXhwfS97XFxlcXVpdl9ifSJdLFsyLDIsIlxcZGlzdGYgXFxmdW5GIHtcXFBFeHB9L3tcXGVxdWl2X2J9Il0sWzAsMSwiXFxwYXJ0aWFsIiwyXSxbMSwyLCJcXGdhbW1hX3tcXFBFeHB9IiwyXSxbMCwzLCJcXGV0YV97XFxQRXhwfSIsMCx7ImxhYmVsX3Bvc2l0aW9uIjo0MH1dLFs0LDUsIlxcZXRhX3t7XFxQRXhwfS97XFxlcXVpdl9ifX0iLDAseyJsYWJlbF9wb3NpdGlvbiI6MTB9XSxbMyw1LCJcXGRpc3RmIFstXV97XFxlcXVpdl9ifSJdLFswLDQsIlstXV97XFxlcXVpdl9ifSIsMl0sWzQsNywiXFxxY29hIiwyXSxbNyw2LCJcXGdhbW1hX3t7XFxQRXhwfS97XFxlcXVpdl9ifX0iLDJdLFsyLDYsIlxcZnVuRyBcXGRpc3RmIFstXV97XFxlcXVpdl9ifSJdLFszLDIsIihcXGdhbW1hX3tcXFBFeHB9IFxcY2lyYyBcXHBhcnRpYWwpXlxcc2hhcnAiLDAseyJjdXJ2ZSI6LTN9XSxbNSw2LCIoXFxnYW1tYV97e1xcUEV4cH0ve1xcZXF1aXZfYn19IFxcY2lyYyBcXHFjb2EpXlxcc2hhcnAiLDAseyJjdXJ2ZSI6LTR9XV0=
\[\begin{tikzcd}
	& {\distf \PExp} && {\distf {{\PExp}/{\equiv_b}}} \\
	\PExp && {\PExp/{\equiv_b}} \\
	{\distf \funF \PExp} && {\distf \funF {\PExp}/{\equiv_b}} \\
	{\funG\distf \PExp} && {\funG\distf {\PExp}/{\equiv_b}}
	\arrow["{\distf [-]_{\equiv_b}}", from=1-2, to=1-4]
	\arrow["{(\gamma_{\PExp} \circ \partial)^\sharp}", curve={height=-18pt}, from=1-2, to=4-1]
	\arrow["{(\gamma_{{\PExp}/{\equiv_b}} \circ \qcoa)^\sharp}", curve={height=-24pt}, from=1-4, to=4-3]
	\arrow["{\eta_{\PExp}}"{pos=0.4}, from=2-1, to=1-2]
	\arrow["{[-]_{\equiv_b}}"', from=2-1, to=2-3]
	\arrow["\partial"', from=2-1, to=3-1]
	\arrow["{\eta_{{\PExp}/{\equiv_b}}}"{pos=0.1}, from=2-3, to=1-4]
	\arrow["\qcoa"', from=2-3, to=3-3]
	\arrow["{\gamma_{\PExp}}"', from=3-1, to=4-1]
	\arrow["{\gamma_{{\PExp}/{\equiv_b}}}"', from=3-3, to=4-3]
	\arrow["{\funG \distf [-]_{\equiv_b}}", from=4-1, to=4-3]
\end{tikzcd}\]
\end{lemma}
\begin{proof}
	Front face of the diagram commutes because $[-]_{\equiv_b}$ is $\distf \funF$-coalgebra homomorphism and because of \cite[Theorem~15.1]{Rutten:2000:Universal}. The sides of the diagram commute because of the free-forgetful adjunction between $\Set$ and $\pca$. Finally, the commutativity of the square at the back of the diagram above follows from \cite[Theorem~4.1]{Silva:2010:Generalizing}.
\end{proof}
\subsection{Step 2a: Fundamental theorem}  We show that every PRE is provably equivalent (modulo the axioms of $\equiv_b$) to a decomposition involving sub-expressions obtained in its small-step semantics. This property, often referred to as the fundamental theorem (in analogy with the fundamental theorem of calculus) is useful in proving soundness. In order to encode elements of $\funF \PExp$ using the syntax of $\PExp$, we define a function $\ex \colon \funF \PExp \to \PExp$, given by $\ex(\checkmark)=1$ and $\ex(a,e')=a;e'$ for all $a \in \alphabet$ and $e' \in \PExp$. To be able to syntactically express finitely supported subdistributions, we will use $n$-ary convex sum of elements of $\PExp$ obeying the axioms of positive convex algebras, that exists because of \Cref{c4:prop:binary} and axioms (\textsf{C1-C4}). Using it, we can state the following:

\begin{restatable}{theorem}{fundamentaltheorem}\label{c4:thm:fundamental_theorem}
    For all $e \in \PExp$ we have that 
    $$
    e \equiv_b \bigoplus_{d \in \supp(\partial(e))} \partial(e)(d) \cdot \ex(d)
    $$
\end{restatable}
Before we give the proof of the result above, we start by establishing a couple of intermediate results. Firstly, we show that the binary probabilistic choice satisfies the following identities:
\begin{lemma}\label{c4:lem:binary_sum_properties}
    The following facts are derivable in $\equiv_b$
    \begin{enumerate}
        \item $e \oplus_p (f 
        \oplus_q g) \equiv_b \left( e \oplus_{\frac{p}{1-(1-p)(1-q)}} f \right) \oplus_{1-(1-p)(1-q)} g $
        \item $(e \oplus_p f) \oplus_q (g \oplus_p h) \equiv_b (e \oplus_q g) \oplus_p (f \oplus_q h)$
    \end{enumerate}
\end{lemma}
\begin{proof}
For \circlednum{1}, let $k = \frac{p}{1-(1-p)(1-q)} $ and $l = 1-(1-p)(1-q)$. We derive the following:
    \begin{align*}
        e \oplus_p (f \oplus_q g) &\equiv_b  (f \oplus_q g) \oplus_{1-{p}} e \tag{\textsf{C3}} \\
        &\equiv_b (g \oplus_{1-{q}} f) \oplus_{1-{p}} e \tag{\textsf{C3}} \\
        &\equiv_b g \oplus_{1-{l}} (f \oplus_{1-{k}} e) \tag{\textsf{C4}} \\
        &\equiv_b (f \oplus_{1-{k}} e) \oplus_{{l}} g\tag{\textsf{C3}} \\
        &\equiv_b (e \oplus_{{k}} f) \oplus_{{l}} g\tag{\textsf{C3}} \\
    \end{align*}
For \circlednum{2} we show the following:
    \begin{align*}
        (e \oplus_p f) \oplus_q (g \oplus_p h) &\equiv_b e \oplus_{pq} \left(f \oplus_{\frac{1-{p}q}{1-pq}} (g \oplus_p h)\right) \tag{\textsf{C4}}\\
        &\equiv_b e \oplus_{pq} \left((g \oplus_p h) \oplus_{\frac{1-{q}}{1-pq}} f \right) \tag{\textsf{C3}} \\
        &\equiv_b e \oplus_{pq} \left(g \oplus_{\frac{p(1-{q})}{1-pq}} \left(h \oplus_{1-{q}} f\right) \right) \tag{\textsf{C4}} \\
        &\equiv_b e \oplus_{pq} \left(g \oplus_{\frac{p(1-{q})}{1-pq}} \left(f \oplus_{{q}} h\right) \right) \tag{\textsf{C3}}\\
        &\equiv_b \left(e \oplus_q g\right) \oplus_p \left(f \oplus_q h\right) \tag{\circlednum{1}}
    \end{align*}

\end{proof}



Then, we argue that any non-empty $n$-ary convex sum can be expressed as a binary probabilistic choice and an $(n-1)$-nary convex sum.
\begin{lemma}\label{c4:lem:sum_unrolling}
    Let $\{p_i\}_{i \in I}$ and $\{e_i\}_{i \in I}$ be non-empty collections indexed by a finite set $I$, such that for all $i \in I$, $p_i \in \interval{0}{1}$ and $e_i \in \PExp$. For any $j \in I$ it holds that:
    \[
        \bigoplus_{i \in I} p_i \cdot e_i \equiv_b e_j \oplus_{p_j} \left(\bigoplus_{i \in I \setminus \{j\}} \frac{p_i}{1-{p_j}}\cdot e_i\right) 
    \]
\end{lemma}
\begin{proof}
    In the edge case, when $p_j = 1$ (and therefore $I = \{j\}$) we have that $\bigoplus_{i \in I} p_i \cdot e _i \equiv_b e_j$ and therefore
    \begin{align*}
        e_j &\equiv_b e_j \oplus_1 0 \tag{\textsf{C2}} \\
        &\equiv_b e_j \oplus_{p_j} \left( \bigoplus_{i \in \emptyset} \frac{p_i}{{1-p_j}} \cdot e_i \right) \tag{Def. of empty $n$-ary convex sum}\\
        &\equiv_b e_j \oplus_{p_j} \left( \bigoplus_{i \in I \setminus \{j\}} \frac{p_i}{{1-p_j}} \cdot e_i \right) \tag{$I = \{j\}$}\\
    \end{align*}
    Note that despite the fact that ${p_j} = 1$, the $n$-ary sum on the right is well-defined as it ranges over an empty index set and thus division by zero never happens. The remaining case, when $p_j \neq 1$ holds because of \Cref{c4:prop:binary}.
\end{proof}
Using the above result, we can also split the normal form used in \Cref{c4:thm:fundamental_theorem} into two parts; one describing acceptance and one describing labelled transitions.
\begin{lemma}\label{c4:lem:safe_unrolling_lemma}
    For all $e \in \PExp$, 
    $$
    \bigoplus_{d \in \supp(\partial(e))} \partial(e)(d) \cdot \ex(d) \equiv_b \one \oplus_{\partial(e)(\checkmark)} \left(\bigoplus_{d \in \supp(\partial(e)) \setminus \{\checkmark\}} \frac{\partial(e)(d)}{1-{\partial(e)(\checkmark)}} \cdot \ex(d)\right)
    $$
\end{lemma}
\begin{proof}
    If $\supp(\partial(e)) = \emptyset$, then 
    \begin{align*}
        \bigoplus_{d \in \supp(\partial(e))} \partial(e)(d) \cdot \ex(d) &\equiv_b \zero \tag{Def. of empty $n$-ary convex sum}\\
        &\equiv_b 0 \oplus_1 1 \tag{\textsf{C2}} \\
        &\equiv_b 1 \oplus_0 0 \tag{\textsf{C3}} \\
        &\equiv_b 1 \oplus_{\partial(e)(\checkmark)} 0 \tag{$\partial(e)(\checkmark)=0$}\\
        &\equiv_b 1 \oplus_{\partial(e)(\checkmark)} \left( 
            \bigoplus_{d \in \emptyset } \frac{\partial(e)(d)}{1-{\partial(e)(\checkmark)}} \cdot \ex (d)\right)\\ 
        &\equiv_b 1 \oplus_{\partial(e)(\checkmark)} \left( 
                \bigoplus_{d \in \supp(\partial(e)(\checkmark))\setminus \{\checkmark\} } \frac{\partial(e)(d)}{1-{\partial(e)(\checkmark)}} \cdot \ex(d)\right)\\ 
    \end{align*}
    
    The remaining case when $\supp(\partial(e)) \neq 0$ holds by \Cref{c4:lem:sum_unrolling} and the fact that $\ex(\checkmark) = 1$.
\end{proof}
Finally, we generalise the axiom (\textsf{D1}) to $n$-ary convex sums.
\begin{lemma}\label{c4:lem:generalised_right_distributivity}
    Let $f \in \PExp$, $I$ be a finite index set and let $\{p_i\}_{i \in I}$ and $\{e_i\}_{i \in I}$ indexed collections of probabilities and expressions respectively. Then,
    $$\left(\bigoplus_{i \in I} p_i \cdot e_i\right) \seq f \equiv_b \bigoplus_{i \in I} p_i \cdot e_i \seq f$$
\end{lemma}
\begin{proof}
    By induction. If $I = \emptyset$, then using (\textsf{0S}) we can show that
    \[
        \left(\bigoplus_{i \in I} p_i \cdot e_i\right) \seq f \equiv_b \zero \seq f \equiv_b \zero \equiv_b \bigoplus_{i \in I} p_i \cdot e_i \seq f 
    \]
    If there exists $j \in I$, such that $p_j = 1$, then
    \[
        \left(\bigoplus_{i \in I} p_i \cdot e_i\right) \seq f \equiv_b e_j \seq f\equiv_b \left(\bigoplus_{i \in I} p_i \cdot e_i \seq f\right)
    \]
    Finally, for the induction step, we have that
    \begin{align*}
         \left(\bigoplus_{i \in I} p_i \cdot e_i\right) \seq f &\equiv_b \left( e_j \oplus_{p_j} \left(\bigoplus_{i \in I \setminus \{j\}} \frac{p_i}{{1-p_j}} \cdot e_i\right) \right) \seq f \\
         &\equiv_b  e_j\seq f \oplus_{p_j} \left(\bigoplus_{i \in I \setminus \{j\}} \frac{p_i}{1-{p_j}} \cdot e_i\right)\seq f \tag{\textsf{D1}} \\
         &\equiv_b  e_j\seq f \oplus_{p_j} \left(\bigoplus_{i \in I \setminus \{j\}} \frac{p_i}{1-{p_j}} \cdot e_i\seq f\right) \tag{Induction hypothesis}\\
         &\equiv_b \left(\bigoplus_{i \in I} p_i \cdot e_i \seq f\right)
    \end{align*}
\end{proof}
We now have all the ingredients to show the fundamental theorem. 
\begin{proof}[Proof of \Cref{c4:thm:fundamental_theorem}]
	We proceed by the structural induction on $e \in \PExp$. For the base cases, we have the following:
	 \begin{itemize}
        \item[]\fbox{$e = \zero$}
        \begin{align*}
            \zero &\equiv_b \bigoplus_{d \in \emptyset} \partial(\zero)(d) \cdot \ex(d) \tag{\Cref{c4:prop:properties_of_positive_convex_algebras}}\\
            &\equiv_b \bigoplus_{d \in \supp(\partial(\zero))} \partial(\zero)(d) \cdot \ex(d) \tag{$\supp(\partial(\zero))=\emptyset$}\\
        \end{align*}
        \item[]\fbox{$e=\one$}
        \begin{align*}
            \one &\equiv_b \ex(\checkmark) \tag{Def. of $\ex$}\\ 
            &\equiv_b \bigoplus_{d \in \supp(\partial(\one))} \partial(\one)(d) \cdot \ex (d) \tag{$\partial(\one) = \delta_{\checkmark} $}
        \end{align*}
        \item[]\fbox{$e = a$}
        \begin{align*}
            a &\equiv_b a \seq \one \tag{\textsf{S1}}\\ 
            &\equiv_b \ex((a,\checkmark)) \tag{Def. of $\ex$}\\
            &\equiv_b \bigoplus_{d \in \supp(\partial(a))} \partial(a)(d) \cdot \ex (d) \tag{$\partial(a) = \delta_{(a, \checkmark)}$}
        \end{align*}
    \end{itemize}
    We now move on to inductive steps.
    \begin{itemize}
        \item[]\fbox{$e = f \oplus_p g $}
        {
        \small
        \begin{align*}
            f \oplus_p g &\equiv_b \left( \bigoplus_{d \in \supp(\partial(f))} \partial(f)(d) \cdot \ex(d) \right)\oplus_p  \left( \bigoplus_{d \in \supp(\partial(g))} \partial(g)(d) \cdot \ex(g) \right) \tag{Induction hypothesis}\\
            &\equiv_b \left( \bigoplus_{d \in \supp(\partial(f \oplus_p g))}\partial(f)(d) \cdot \ex(d) \right) \oplus_p  \left( \bigoplus_{d \in \supp(\partial(f \oplus_p g))} \partial(g)(d) \cdot \ex(g) \right) \tag{\Cref{c4:prop:properties_of_positive_convex_algebras}}\\
            &\equiv_b \bigoplus_{d \in \supp(\partial(f \oplus_p g))} \left(p\partial(f)(d) + {(1-p)}\partial(g)(d)\right) \cdot \ex(d) \tag{Barycenter axiom}\\
             &\equiv_b \bigoplus_{d \in \supp(\partial(f \oplus_p g))} \partial(f \oplus_p g)(d) \cdot \ex(d) \tag{Def. of $\partial$}
        \end{align*}
        }
        \item[]\fbox{$e = f\seq g $}
        {
        \small
        \begin{align*}
            f \seq g &\equiv_b \left(\bigoplus_{d \in \supp(\partial(f))} \partial(f)(d) \cdot \ex(d) \right) \seq g \tag{Induction hypothesis} \\
            &\equiv_b \left(\one \oplus_{\partial(f)(\checkmark)} \left(\bigoplus_{d \in \supp(\partial(f)) \setminus \{\checkmark\}} \frac{\partial(f)(d)}{{1-\partial(f)(\checkmark)}} \cdot \ex(d) \right) \right) \seq g \tag{\Cref{c4:lem:safe_unrolling_lemma}}\\
            &\equiv_b \left(\one\seq g \oplus_{\partial(f)(\checkmark)} \left(\bigoplus_{d \in \supp(\partial(f)) \setminus \{\checkmark\}} \frac{\partial(f)(d)}{{1-\partial(f)(\checkmark)}} \cdot \ex(d)  \right)\seq g \right) \tag{\textsf{D1}}\\
            &\equiv_b g \oplus_{\partial(f)(\checkmark)} \left(\bigoplus_{d \in \supp(\partial(f)) \setminus \{\checkmark\}} \frac{\partial(f)(d)}{{1-\partial(f)(\checkmark)}} \cdot \ex(d)\seq g  \right)\\ \tag{\Cref{c4:lem:generalised_right_distributivity} and \textsf{1S}} \\
            &\equiv_b \left(\bigoplus_{d \in \supp(\partial(g))}\partial(g)(d) \cdot \ex(d)\right)\\&\quad\quad\quad\quad \oplus_{\partial(f)(\checkmark)} \left(\bigoplus_{d \in \supp(\partial(f)) \setminus \{\checkmark\}} \frac{\partial(f)(d)}{{1-\partial(f)(\checkmark)}} \cdot \ex(d)\seq g  \right) \tag{Induction hypothesis}\\
            &\equiv_b\left( \bigoplus_{d \in \supp(\partial(f \seq g))}\partial(g)(d) \cdot \ex(d)\right)\\&\quad\quad\quad\quad  \oplus_{\partial(f)(\checkmark)}  \left(\bigoplus_{d \in \supp(\partial(f)) \setminus \{\checkmark\}} \frac{\partial(f)(d)}{{1-\partial(f)(\checkmark)}} \cdot \ex(d)\seq g \right) \tag{\Cref{c4:prop:properties_of_positive_convex_algebras}}
        \end{align*}
        }
        Now, we simplify the subexpression on the right part of the convex sum. Define
        $n \colon F \PExp \to \interval{0}{1}$ to be: 
        $$n(d) = \begin{cases}
            \partial(f)(a, f') & d = (a, f' \seq g) \\
            0 & \text{otherwise}
        \end{cases}$$
    	By applying \Cref{c4:prop:properties_of_positive_convex_algebras} and the preceding definition, it follows that:
        \begin{align*}
            \bigoplus_{d \in \supp(\partial(f)) \setminus \{\checkmark\}} \frac{\partial(f)(d)}{{1-\partial(f)(\checkmark)}} \cdot \ex(d)\seq g &\equiv_b \bigoplus_{d \in \supp(\partial(f \seq g))} \frac{n(d)}{{1-\partial(f)(\checkmark)}} \cdot \ex(d)
        \end{align*}
       	By combining this with the previous derivation and applying the barycenter axiom, we can conclude that $$f \seq g \equiv_b \bigoplus_{d \in \supp(\partial(f \seq g))} \left(\partial(f)(\checkmark)\partial(g)(d) + n(d)\right) \cdot \ex(d) $$
       	Combining it with the previous derivation, using the barycenter axiom, we can show that:
        $$f \seq g \equiv_b \bigoplus_{d \in \supp(\partial(f \seq g))} \left(\partial(f)(\checkmark)\partial(g)(d) + n(d)\right) \cdot \ex(d) $$
       	Observe that for $d = (a, f' \seq g)$, we obtain
        $$\partial(f)(\checkmark)\partial(g)(d) + n(d) = \partial(f)(\checkmark)\partial(g)(a, f' \seq g) + \partial(f)(a, f') = \partial(f \seq g)(d)$$
        When $d = \checkmark$,  it follows that
        $$\partial(f)(\checkmark)\partial(g)(d) + n(d) = \partial(f)(\checkmark)\partial(g)(d) = \partial(f \seq g)(d)$$
    	In all remaining cases, both functions assign the value $0$ to $d$. Consequently, we conclude that
        $$f \seq g \equiv_b \bigoplus_{d \in \supp(\partial(f \seq g))} \partial(f \seq g)(d) \cdot \ex(d)$$
        which establishes the desired result for this case.

        \item[] \fbox{$e = f^{[p]}$}
        
        We begin by considering the case where $\partial(f)(\checkmark) = 1$ and $p = 1$. 
        \begin{align*}
            f^{[p]} &\equiv_b \left(\bigoplus_{d \in \supp(\partial(f))} \partial(f)(d) \cdot \ex(d) \right)^{[1]} \tag{Induction hypothesis}\\
            &\equiv_b \one^{[1]} \tag{$\partial(f)(\checkmark)=1$}\\
            &\equiv_b \zero \tag{\textsf{Div}}\\
            &\equiv_b \bigoplus_{d \in \supp \left(\partial\left(f^{[1]}\right)\right)} \partial\left(f^{[1]}\right)(d) \cdot \ex(d)
        \end{align*}
        Otherwise, we first apply the (\textsf{Tight}) axiom to the loop body as follows:
        {
        \small
        \begin{align*}
            f^{[p]} &\equiv_b \left(\bigoplus_{d \in \supp(\partial(f))} \partial(f)(d)\cdot \ex(d)\right)^{[p]} \tag{Induction hypothesis} \\
            &\equiv_b \left(\one \oplus_{\partial(f)(\checkmark)} \left( \bigoplus_{d \in \supp(\partial(f)) \setminus \{\checkmark\}} \frac{\partial(f)(d)}{{1-\partial(f)(\checkmark)}}\cdot \ex(d)\right)\right)^{[p]} \tag{\Cref{c4:lem:safe_unrolling_lemma}}\\
            &\equiv_b \left(\left( \bigoplus_{d \in \supp(\partial(f)) \setminus \{\checkmark\}} \frac{\partial(f)(d)}{{1-\partial(f)(\checkmark)}}\cdot \ex(d)\right) \oplus_{1-{\partial(f)(\checkmark)}} \one\right)^{[p]} \tag{\textsf{C3}}\\
            &\equiv_b \left(\bigoplus_{d \in \supp(\partial(f)) \setminus \{\checkmark\}} \frac{\partial(f)(d)}{{1-\partial(f)(\checkmark)}} \cdot \ex(d)\right)^{\left[\frac{{(1-\partial(f)(\checkmark))}p}{1-p\partial(f)(\checkmark)}\right]} \tag{\textsf{Tight}}\\
        \end{align*}
        }
        For convenience, we denote by $g^{[r]}$ the expression obtained from the preceding derivation. We proceed by applying the (\textsf{Unroll}) axiom.
        {
        \small
        \begin{align*}
            g^{[r]}&\equiv_b \left(\bigoplus_{d \in \supp(\partial(f)) \setminus \{\checkmark\}} \frac{\partial(f)(d)}{{1-\partial(f)(\checkmark)}} \cdot \ex(d)\right)\seq g^{[r]} \oplus_{r} \one \tag{\textsf{Unroll}}\\
            &\equiv_b \left(\bigoplus_{d \in \supp(\partial(f)) \setminus \{\checkmark\}} \frac{\partial(f)(d)}{{1-\partial(f)(\checkmark)}} \cdot \ex(d)\right)\seq f^{[p]} \oplus_r \one \tag{$f^{[p]} \equiv_b g^{[r]}$}\\
            &\equiv_b \left(\bigoplus_{d \in \supp(\partial(f)) \setminus \{\checkmark\}} \frac{\partial(f)(d)}{{1-\partial(f)(\checkmark)}} \cdot \ex(d)\seq f^{[p]}\right) \oplus_r \one \tag{\Cref{c4:lem:generalised_right_distributivity}} \\
            &\equiv_b \left(\bigoplus_{d \in \supp(\partial(f)) \setminus \{\checkmark\}} \frac{\partial(f)(d)}{{1-\partial(f)(\checkmark)}} \cdot \ex(d)\seq f^{[p]}\right)\\&\quad\quad\quad\oplus_r \left(\bigoplus_{d \in \supp \left(\partial\left(f^{[p]}\right)\right)} \delta_{\checkmark}(d) \cdot \ex(d)\right)
        \end{align*}
        }
       Next, we simplify the left-hand side of the binary convex sum. Define $n \colon F \PExp \to \interval{0}{1}$ as follows
        $$n(d) = \begin{cases}
            {\partial(f)(a,f')} & d = \left(a, f' \seq f^{[p]}\right) \\
            0 & \text{otherwise}
        \end{cases}$$
        By applying \Cref{c4:prop:properties_of_positive_convex_algebras} and the definition above, we obtain
        {
        \small
        $$
            \bigoplus_{d \in \supp(\partial(f)) \setminus \{\checkmark\}} \frac{\partial(f)(d)}{{1-\partial(f)(\checkmark)}} \cdot \ex(d)\seq f^{[p]} \equiv_b \bigoplus_{d \in \supp \left(\partial\left(f^{[p]}\right)\right)} \frac{n(d)}{{1-\partial(f)(\checkmark)}} \cdot \ex(d)
        $$
        }
        By combining the above with the previous derivation and applying the barycenter axiom, we obtain:
        $$
        f^{[p]} \equiv_b \bigoplus_{d \in \supp \left(\partial\left(f^{[p]}\right)\right)} \left(\frac{pn(d)}{1-p\partial(f)(\checkmark)} + \frac{1-p\delta_{\checkmark}(d)}{1-\partial(f)(\checkmark)p}\right) \cdot \ex(d)
        $$
       Observe that for $d = (a, f' \seq g)$, we obtain
        $$\frac{pn(d)}{1-p\partial(f)(\checkmark)} + \frac{1-p\delta_{\checkmark}(d)}{1-p\partial(f)(\checkmark)} = \frac{p\partial(f)(a,f')}{1-p\partial(f)(\checkmark)}  = \partial \left(f^{[p]}\right)(d)$$ 
        When $d = \checkmark$,  it follows that
        $$\frac{pn(d)}{1-p\partial(f)(\checkmark)} + \frac{1-p\delta_{\checkmark}(d)}{1-p\partial(f)(\checkmark)} = \frac{1-p}{1-p\partial(f)(\checkmark)} = \partial \left(f^{[p]}\right)(d)$$
       	In all remaining cases, we have that
        $$\frac{pn(d)}{1-p\partial(f)(\checkmark)} + \frac{1-p\delta_{\checkmark}(d)}{1-p\partial(f)(\checkmark)} = 0 = \partial \left(f^{[p]}\right)(d)$$
        Thus, we obtain the following:
        $$f^{[p]}\equiv_b \bigoplus_{d \in \supp \left(\partial \left(f^{[p]}\right)\right)} \partial\left(f^{[p]}\right)(d) \cdot \ex(d)$$
        This establishes the desired result.
    \end{itemize}
\end{proof}
A direct corollary of the result established above is that every loop is provably equivalent to a loop whose body does not assign any probability to transitions to $\checkmark$.
\begin{corollary}[Productive loop]\label{c4:cor:productive_loop}
    Let $e \in \PExp$ and $p \in \interval{0}{1}$. We have that $e^{[p]} \equiv_b f^{[r]}$ for some $f \in \PExp$ and $r \in \interval{0}{1}$, such that $E(f)=0$.
\end{corollary}
\begin{proof}
    If $\partial(e)(\checkmark)=1$ and $p=1$, then it follows that:
    \begin{align*}
        e^{[1]} &\equiv_b \left(\bigoplus_{d \in \supp(\partial(e))} \partial(e)(d) \cdot \ex(d)\right)^{[1]} \tag{\Cref{c4:thm:fundamental_theorem}}\\
        &\equiv_b \one^{[1]} \\
        &\equiv_b \zero \tag{\textsf{Div}}\\
        &\equiv_b \zero\seq \zero \oplus_1 \one \tag{\textsf{0S} and \textsf{C2}}\\
        &\equiv_b \zero^{[1]} \tag{\textsf{Unique} fixpoint rule and $E(\zero)=0$}
    \end{align*}
    Therefore, $e^{[1]}=\zero^{[1]}$. In this case, it follows that $E(\zero)=0$.
    In the remaining cases, we obtain the following:
    \begin{align*}
        e^{[p]} &\equiv_b \left(\bigoplus_{d \in \supp(\partial(e))} \partial(e)(d) \cdot \ex(d)\right)^{[p]} \tag{\Cref{c4:thm:fundamental_theorem}}\\
        &\equiv_b \left(\one \oplus_{\partial(e)(\checkmark)} \left(\bigoplus_{d \in \supp(\partial(e)) \setminus \{\checkmark\}} \frac{\partial(e)(d)}{{1-\partial(e)(\checkmark)}} \cdot \ex(d)\right)\right)^{[p]} \tag{\Cref{c4:lem:safe_unrolling_lemma}} \\
        &\equiv_b \left(\left(\bigoplus_{d \in \supp(\partial(e)) \setminus \{\checkmark\}} \frac{\partial(e)(d)}{{1-\partial(e)(\checkmark)}} \cdot \ex(d)\right)\oplus_{{1-\partial(e)(\checkmark)}}  \one\right)^{[p]} \tag{\textsf{C3}}\\
        &\equiv_b \left(\left(\bigoplus_{(a,e') \in \supp(\partial(e))} \frac{\partial(e)(a,e')}{{1-\partial(e)(\checkmark)}} \cdot a \seq e'\right)\oplus_{{1-\partial(e)(\checkmark)}}  \one\right)^{[p]} \tag{Def. of $\ex$}\\
        &\equiv_b \left(\bigoplus_{(a,e') \in \supp(\partial(e))} \frac{\partial(e)(a,e')}{{1-\partial(e)(\checkmark)}} \cdot a \seq e' \right)^{\left[\frac{p{(1-\partial(e)(\checkmark))}}{1-p\partial(e)(\checkmark)}\right]} \tag{\textsf{Tight}}
    \end{align*}
Observe that the body of the loop above is an $n$-ary probabilistic sum involving terms of the form $a \seq e'$ (where $a \in \alphabet$, $e' \in \PExp$), for which $E(a \seq e') = 0$. By examining the definition of the $n$-ary sum (\Cref{c4:prop:binary}) and the termination operator $E(-)$ (\Cref{c4:fig:axioms}), we immediately conclude that the loop body is mapped to $0$ by $E(-)$, which completes the proof.
\end{proof}
\subsection{Step 2b: Algebra structure}
As a consequence of \Cref{c4:thm:fundamental_theorem}, we have that $\qcoa \colon {\PExp}/{\equiv_b} \to \distf \funF {\PExp}/{\equiv_b}$ is an isomorphism.
\begin{corollary}\label{c4:cor:quotient_coalgebra_inverse}
    The structure map $\qcoa : {\PExp}/{\equiv_b} \to \distf \funF {\PExp}/{\equiv_b}$ of the quotient coalgebra $({\PExp}/{\equiv_b},\qcoa)$ is an isomorphism.
\end{corollary}
\begin{proof}
    Given $\nu \in \distf \funF {{\PExp}/{\equiv_b}}$ define a function $\qcoa^{-1} \colon \distf \funF {{\PExp}/{\equiv_b}} \to {{\PExp}/{\equiv_b}} $ as follows:
    $$
    \qcoa^{-1}(\nu) = \left[\nu(\checkmark) \cdot \one \oplus \left(\bigoplus_{(a,[e']_{\equiv_b}) \in \supp(\nu)} \nu(a,[e']_{\equiv_b}) \cdot a \seq e'\right)\right]_{\equiv_b}
    $$
    First, observe that for arbitrary $\nu \in \distf \funF {{\PExp}/{\equiv_b}}$ we have that:
    {
    \small
    \begin{align*}
    &\left(\qcoa \circ \qcoa^{-1}\right)(\nu)(\checkmark)\\
    &\quad=  \left(\qcoa \circ [-]_{\equiv_b}\right) \left(\nu(\checkmark) \cdot \one \oplus \left( \bigoplus_{(a,[e']_{\equiv_b}) \in \supp(\nu)} \nu(a,[e']_{\equiv_b}) \cdot a \seq e'\right)\right)(\checkmark)\\
    &\quad= (\distf \funF [-]_{\equiv_b} \circ \partial) \left(\nu(\checkmark) \cdot \one \oplus \left(\bigoplus_{(a,[e']_{\equiv_b}) \in \supp(\nu)} \nu(a,[e']_{\equiv_b}) \cdot a \seq e'\right)\right)(\checkmark) \tag{${[-]_{\equiv}}$ is a $\distf \funF$-coalgebra homomorphism} \\
    &\quad= \partial \left(\nu(\checkmark) \cdot \one \oplus \bigoplus_{(a,[e']_{\equiv_b}) \in \supp(\nu)} \nu(a,[e']_{\equiv_b}) \cdot a \seq e'\right) (\checkmark) \\
    &\quad= \nu(\checkmark) \tag{Def. of $\partial$}
    \end{align*}
    }
   Similarly, for any $(b, [f']_{\equiv_b}) \in \supp(\nu)$, it follows that:
   {
   	\small
    \begin{align*}
    &(\qcoa \circ \qcoa^{-1})(\nu)(b, [f']_{\equiv_b})\\ &\quad=  (\qcoa \circ [-]_{\equiv_b})\left(\nu(\checkmark) \cdot \one \oplus \left(\bigoplus_{(a,[e']_{\equiv_b}) \in \supp(\nu)} \nu(a,[e']_{\equiv_b}) \cdot a \seq e'\right)\right)(b, [f']_{\equiv_b}) \\
    &\quad= (\distf \funF [-]_{\equiv_b} \circ \partial) \left(\nu(\checkmark) \cdot \one \oplus \left(\bigoplus_{(a,[e']_{\equiv_b}) \in \supp(\nu)} \nu(a,[e']_{\equiv_b}) \cdot a \seq e'\right)\right)(b, [f']_{\equiv_b})  \tag{${[-]_{\equiv}}$ is a $\distf \funF$-coalgebra homomorphism} \\
    &\quad= \sum_{g \equiv f'} \partial\left(\nu(\checkmark) \cdot \one \oplus \left(\bigoplus_{(a,[e']_{\equiv_b}) \in \supp(\nu)} \nu(a,[e']_{\equiv_b}) \cdot a \seq e'\right)\right)(b,g) \\
    &\quad= \nu(b, [f']_{\equiv_b}) \tag{Def. of $\partial$}
    \end{align*}
   }
   \noindent
   For the second part of the proof, let $ e \in \PExp$. As a consequence of \Cref{c4:thm:fundamental_theorem}, it follows that:
   {
   \small
   \begin{align*}
        e &\equiv_b \bigoplus_{d \in \supp(\partial(e))} \partial(e)(d) \cdot \ex(d) \tag{\Cref{c4:thm:fundamental_theorem}} \\
        &\equiv_b \partial(e)(\checkmark) \cdot \one \oplus \left(\bigoplus_{(a,e') \in \supp(\partial(e))} \partial(e)(a,e') \cdot a \seq e' \right)\\
        &\equiv_b \partial(e)(\checkmark) \cdot \one \oplus \left(\bigoplus_{(a,[e']_{\equiv_b}) \in \alphabet \times {\PExp}/{\equiv_b}} \left(\sum_{g \equiv e'} \partial(e)(a,g)\right) \cdot a \seq e' \right)\tag{\Cref{c4:prop:properties_of_positive_convex_algebras}}
   \end{align*}
   }
   \noindent
   Next, observe that:
   {
   \small
    \begin{align*}
        &(\qcoa^{-1} \circ \qcoa)[e]_{\equiv_b} = (\qcoa^{-1} \circ \distf \funF [-]_{\equiv_b} \circ {\partial})(e) \tag{${[-]_{\equiv}}$ is a $\distf \funF$-coalgebra homomorphism} \\
        &\quad= \left[ \partial(e)(\checkmark) \cdot \one \oplus \left( \bigoplus_{(a,[e']_{\equiv_b}) \in \supp((\distf \funF [-]_{\equiv_b} \circ \partial)(e))}(\distf \funF [-]_{\equiv_b} \circ \partial)(e)(a,[e']_{\equiv_b}))\cdot a\seq e' \right) \right]_{\equiv_b}\\
        &\quad= \left[ \partial(e)(\checkmark) \cdot \one \oplus \left(\bigoplus_{(a,[e']_{\equiv_b}) \in \alphabet \times {\PExp}/{\equiv_b}}(\distf \funF [-]_{\equiv_b} \circ \partial)(e)(a,[e']_{\equiv_b}))\cdot a\seq e'\right)\right]_{\equiv_b} \tag{\Cref{c4:prop:properties_of_positive_convex_algebras}}\\
        &\quad= \left[ \partial(e)(\checkmark) \cdot \one\oplus \left(\bigoplus_{(a,[e']_{\equiv_b}) \in \alphabet \times {\PExp}/{\equiv_b}} \left(\sum_{g \equiv e'} \partial(e)(a,g) \right) \cdot a \seq e'\right)\right]_{\equiv_b} \tag{Def. of $\qcoa$}\\
        &\quad = [e]_{\equiv_b} \tag{Derivation above}
    \end{align*}
    }
    This completes the proof.
\end{proof}
The result above allows to define a map $\alpha_{\equiv_b} : \distf {\PExp}/{\equiv_b} \to {\PExp}/{\equiv_b}$ as the following composition of morphisms:
\[
\begin{tikzcd}
	{\distf{\PExp}/{\equiv_b}} & {\distf\distf \funF{\PExp}/{\equiv_b}} & {\distf \funF{\PExp}/{\equiv_b}} & {{\PExp}/{\equiv_b}}
	\arrow["{\distf \qcoa}", from=1-1, to=1-2]
	\arrow["\mu_{\funF {\PExp}/{\equiv}}", from=1-2, to=1-3]
	\arrow["{{\qcoa}^{-1}}", from=1-3, to=1-4]
\end{tikzcd}\]
In fact, this allows to equip the set ${\PExp}/{\equiv_b}$ with a positive convex algebra structure.
\begin{restatable}{lemma}{expressionsemalgebra}\label{lem:quotient_is_an_em_algebra}
    $({\PExp}/{\equiv_b}, \alpha_{\equiv_b})$ is an Eilenberg-Moore algebra for the finitely supported subdistribution monad.
\end{restatable}
\begin{proof}
    We first verify that $\alpha_{\equiv_b} \circ \eta_{{\PExp}/{\equiv_{b}}} = \id_{{\PExp}/{\equiv_{b}}}$.
    \begin{align*}
        \alpha_{\equiv_b} \circ \eta_X &= \qcoa^{-1} \circ \mu_{\funF {\PExp}/{\equiv_{b}}} \circ \distf {\qcoa} \circ \eta_{{\PExp}/{\equiv_{b}}} \tag{Def. of $\alpha_{\equiv_b}$}\\
        &=\qcoa^{-1} \circ \mu_{\funF {\PExp}/{\equiv_{b}}} \circ \eta_{\distf \funF{\PExp}/{\equiv_{b}}} \circ {\qcoa} \tag{$\eta$ is natural} \\
        &=\qcoa^{-1} \circ \qcoa \tag{Monad laws} \\
        &=\id_{{\PExp}/{\equiv_{b}}} \tag{\Cref{c4:cor:quotient_coalgebra_inverse}}
    \end{align*}
    Then, we show that $\alpha_{\equiv_b} \circ \distf \alpha_{\equiv_b} = \alpha_{\equiv_b} \circ \mu_{{\PExp}/{\equiv_b}}$
    \begin{align*}
        \alpha_{\equiv_b} \circ \distf \alpha_{\equiv_b} &= \qcoa^{-1} \circ \mu_{\funF {\PExp}/{\equiv_{b}}} \circ \distf {\qcoa} \circ \distf\qcoa^{-1} \circ \distf\mu_{\funF {\PExp}/{\equiv_{b}}} \circ \distf^2 {\qcoa} \tag{Def. of $\alpha_{\equiv_b}$}\\
        &=\qcoa^{-1} \circ \mu_{\funF {\PExp}/{\equiv_{b}}}  \circ \distf\mu_{\funF {\PExp}/{\equiv_{b}}} \circ \distf^2 {\qcoa} \tag{\Cref{c4:cor:quotient_coalgebra_inverse}}\\
        &=\qcoa^{-1} \circ \mu_{\funF {\PExp}/{\equiv_{b}}}  \circ \mu_{\distf \funF {\PExp}/{\equiv_{b}}} \circ \distf^2 {\qcoa}  \tag{Monad laws}\\
        &=\qcoa^{-1} \circ \mu_{\funF {\PExp}/{\equiv_{b}}} \circ \distf {\qcoa} \circ \mu_{{\PExp}/{\equiv_b}} \tag{$\mu$ is natural}\\ 
        &= \alpha_{\equiv_{b}} \circ \mu_{{\PExp}/{\equiv_b}} \tag{Def. of $\alpha_{\equiv_b}$}
    \end{align*}
\end{proof}
Using the isomorphism between $\pca$ and $\Set^\distf$ one can calculate the concrete formula for $\pca$ structure on ${\PExp}/{\equiv_b}$.
\begin{lemma}\label{c4:lem:concrete}
	The $\pca$ structure on $\PExp/{\equiv_b}$ is concretely given by:
	$$
	\bigboxplus_{i \in I} p_i \cdot [e_i]_{\equiv_b} = \left[\bigoplus_{i \in I} p_i \cdot e_i \right]_{\equiv_b}
	$$
\end{lemma}
\begin{proof}
{
\small
\begin{align*}
	&\bigboxplus_{i \in I} p_i \cdot [e_i]_{\equiv_b} = \alpha_{\equiv_b} \left( \sum_{i \in I} p_i \delta_{[e_i]_{\equiv_b} }\right) \tag{\Cref{c4:thm:correspondence}}\\
	&\quad= \qcoa^{-1} \circ \mu_{\funF {\PExp}/{\equiv_{b}}} \circ \distf {\qcoa}  \left( \sum_{i \in I} p_i \delta_{[e_i]_{\equiv_b}}\right) \tag{Def. of $\alpha_{\equiv_b}$}\\
	&\quad= \qcoa^{-1} \circ \mu_{\funF {\PExp}/{\equiv_{b}}} \left( \sum_{i \in I} p_i \delta_{\qcoa \left([e_i]_{\equiv_b} \right)}\right)\\
	&\quad= \qcoa^{-1}  \left( \sum_{i \in I} p_i {\qcoa \left([e_i]_{\equiv_b} \right)}\right)\\
	&\quad= \qcoa^{-1}  \left( \sum_{i \in I} p_i {(\distf \funF[-]_{\equiv_b} \circ \partial) \left(e_i \right)}\right) \tag{${[-]_{\equiv}}$ is a $\distf \funF$-coalgebra homomorphism} \\
	&\quad= \left[ \left( \sum_{i \in I} p_i \partial(e_i)(\checkmark)\right) \cdot \one \oplus \left( \bigoplus_{ (a,[e']_{\equiv_b}) \in \alphabet \times {\PExp}/{\equiv_b}} \left(\sum_{i \in I} p_i \partial(e_i)(a,[e']_{\equiv_b})\right)\right) \cdot a \seq e'\right]_{\equiv_b} \tag{Def. of $\qcoa^{-1}$ and \Cref{c4:prop:properties_of_positive_convex_algebras}}\\
	&\quad=\left[\bigoplus_{i \in I}p_i \cdot \left( \partial(e_i)(\checkmark) \cdot \one \oplus \left(\bigoplus_{ (a,[e']_{\equiv_b}) \in \alphabet \times {\PExp}/{\equiv_b}}  \partial(e_i)(a,[e']_{\equiv_b}) \cdot a \seq e' \right)\right)\right]_{\equiv_b} \tag{Barycenter axiom}\\
	&\quad=\left[\bigoplus_{i \in I}p_i \cdot \left( \partial(e_i)(\checkmark) \cdot \one \oplus \left(\bigoplus_{ (a,[e']_{\equiv_b}) \in \supp(\partial(e_i))}  \partial(e_i)(a,[e']_{\equiv_b}) \cdot a \seq e' \right)\right)\right]_{\equiv_b} \tag{\Cref{c4:prop:properties_of_positive_convex_algebras}}\\
	&\quad=\left[ \bigoplus_{i \in I} p_i \cdot e_i \right]_{\equiv_b} \tag{\Cref{c4:thm:fundamental_theorem}}
\end{align*}
}
\end{proof}
We can also equip the coarser quotient, that is ${\PExp}/{\equiv}$, with a $\pca$ structure.  
\begin{lemma}\label{c4:lem:coarser_quotient_is_a_pca}
The set ${\PExp}/{\equiv}$ can be equipped with a positive convex algebra structure, given by the following:
$$
\bigboxplus_{i \in I} p_i \cdot [e_i] = \left[\bigoplus_{i \in I} p_i \cdot e_i \right]
$$
Moreover, $[-]_{\equiv} \colon {\PExp}/{\equiv_b} \to {\PExp}/{\equiv}$ is a $\pca$ homomorphism.
\end{lemma}
\begin{proof}
The positive convex algebra structure on ${\PExp}/{\equiv}$ is well-defined, because $\equiv$ is a congruence and the definition on $n$-ary probabilistic choice (\Cref{c4:prop:binary}). To show that $[-]_{\equiv}$ is a $\pca$ homomorphism, we argue the following:
	 \begin{align*}
        \left[\bigboxplus_{i \in I} p_i \cdot [e_i]_{\equiv_b}\right]_{\equiv} &= \left[\left[\bigoplus_{i \in I} p_i \cdot e_i \right]_{\equiv_b}\right]_{\equiv} \tag{\Cref{c4:lem:concrete}}\\
        &= \left[\bigoplus_{i \in I} p_i \cdot e_i \right]\\
        &= \bigboxplus_{i \in I} p_i \cdot[e_i] \tag{Def. of $\pca$ structure on ${\PExp}/{\equiv}$}\\
        &= \bigboxplus_{i \in I}^n p_i \left[[e_i]_{\equiv_b}\right]_{\equiv} \\
    \end{align*}
\end{proof}
\subsection{Step 3: Coalgebra structure}\label{c4:sec:soundness_coalgebra}
Having established the necessary algebraic structure, we move on to showing how we can equip the quotient ${\PExp}/{\equiv}$ with a structure of coalgebra for the functor $\funG \colon \Set \to \Set$. First, we focus on the $\funG$-coalgebra structure $c \colon \PExp/{\equiv_b} \to \funG \PExp/{\equiv_b}$ on the finer quotient $\PExp/{\equiv_b}$,  defined as the following composition of maps:
{
\small
% https://q.uiver.app/#q=WzAsNCxbMCwwLCJ7XFxQRXhwfS97XFxlcXVpdl9ifSJdLFsyLDAsIlxcZGlzdGYgXFxmdW5GIHtcXFBFeHB9L3tcXGVxdWl2X2J9Il0sWzQsMCwiXFxmdW5HIFxcZGlzdGYge1xcUEV4cH0ve1xcZXF1aXZfYn0iXSxbNiwwLCJcXGZ1bkcge1xcUEV4cH0ve1xcZXF1aXZfYn0iXSxbMCwxLCJcXHFjb2EiXSxbMSwyLCJcXGdhbW1hX3t7XFxQRXhwfS97XFxlcXVpdl9ifX0iXSxbMiwzLCJcXGZ1bkcgXFxhbHBoYV97XFxlcXVpdl9ifSJdLFswLDMsImMiLDIseyJjdXJ2ZSI6NX1dXQ==
\[\begin{tikzcd}
	{{\PExp}/{\equiv_b}} && {\distf \funF {\PExp}/{\equiv_b}} && {\funG \distf {\PExp}/{\equiv_b}} && {\funG {\PExp}/{\equiv_b}}
	\arrow["\qcoa", from=1-1, to=1-3]
	\arrow["c"', curve={height=30pt}, from=1-1, to=1-7]
	\arrow["{\gamma_{{\PExp}/{\equiv_b}}}", from=1-3, to=1-5]
	\arrow["{\funG \alpha_{\equiv_b}}", from=1-5, to=1-7]
\end{tikzcd}\]
}

Formally, we equip a quotient ${\PExp}/{\equiv_b}$ with $\distf \funF$-coalgebra structure, which exists due to soundness of ${\equiv_b}$ with respect to bisimilarity. Then, we transform it into a $\funG \distf$-coalgebra using the natural transformation $\gamma \colon \distf \funF \Rightarrow \funG \distf$. Rather than determinising this coalgebra directly, we instead flatten each reachable subdistribution using the algebra map $\alpha_{\equiv_b} \colon \distf \funF {\PExp}/{\equiv_b} \to {\PExp}/{\equiv_b}$, thereby inducing a $\funG$-coalgebra structure. This construction is closely related to the determinisation of $\left({{\PExp}/{\equiv_b}},{\gamma_{{\PExp}/{\equiv_b}} \circ \qcoa}\right)$. In particular, we have the following result
\begin{lemma}\label{c4:lem:algebra_map_coalgebra_homomorphism}
    The $\pca$ structure map $\alpha_{\equiv_b} \colon \distf {\PExp}/{\equiv_b} \to {\PExp}/{\equiv_b}$ is a $\funG$-coalgebra homomorphism of the following type: $$\alpha_{\equiv_b} \colon \left(\distf {\PExp}/{\equiv_b}, (\gamma_{{\PExp}/{\equiv_b}} \circ \qcoa )^\sharp\right) \to \left({\PExp}/{\equiv_b}, c\right)$$
\end{lemma}
 \begin{proof}
 	 We show that the following diagram commutes:
        \[\begin{tikzcd}
		{\distf{\PExp}/{\equiv_b}} && {{\PExp}/{\equiv_b}} \\
		& {\distf\distf \funF{\PExp}/{\equiv_b}} & {\distf \funF{\PExp}/{\equiv_b}} \\
		&& {\funG\distf {\PExp}/{\equiv_b}} \\
		{\funG\distf{\PExp}/{\equiv_b}} && {\funG{\PExp}/{\equiv_b}}
		\arrow["\qcoa"', from=1-3, to=2-3]
		\arrow["\gamma_{{\PExp}/{\equiv}_0}"', from=2-3, to=3-3]
		\arrow["{\funG \alpha_{\equiv_b}}"', from=3-3, to=4-3]
		\arrow["(\gamma_{{\PExp}/{\equiv_b}} \circ \qcoa )^\sharp"', from=1-1, to=4-1]
		\arrow["{\alpha_{\equiv_b}}", from=1-1, to=1-3]
		\arrow["{\funG\alpha_{\equiv_b}}", from=4-1, to=4-3]
		\arrow["{\distf\qcoa}", from=1-1, to=2-2]
		\arrow["\mu_{\funF {\PExp}/{\equiv_b}}", from=2-2, to=2-3]
	\end{tikzcd}\]
	
 	For the top right square, we have the following:
 	\begin{align*}
 		\qcoa \circ \alpha_{\equiv_b} &= \qcoa \circ \qcoa^{-1} \circ \mu_{\funF {\PExp}/{\equiv_{b}}} \circ \distf {\qcoa} \tag{Def. of $\alpha_{\equiv_b}$}\\
 		&= \mu_{\funF {\PExp}/{\equiv_{b}}} \circ \distf {\qcoa} \tag{\Cref{c4:cor:quotient_coalgebra_inverse}}
 	\end{align*}
 	The commutativity of the bottom hexagon diagram follows directly from \Cref{c4:prop:extension}.
 \end{proof}
We can utilise the aformentioned $\funG$-coalgebra structure on ${\PExp}/{\equiv_b}$ to induce a corresponding $\funG$-coalgebra structure on the coarser quotient ${\PExp}/{\equiv}$.
 \begin{lemma}\label{c4:lem:coalg_on_quotient_left_dist}
    There exists a unique $\funG$-coalgebra structure $d \colon {\PExp}/{\equiv} \to \funG{\PExp}/{\equiv}$ such that the following diagram commutes:
    {
    \small
% https://q.uiver.app/#q=WzAsOCxbMCwwLCJcXFBFeHAiXSxbMCwxLCJcXGRpc3RmIFxcZnVuRiBcXFBFeHAiXSxbMiwwLCJ7XFxQRXhwfS97XFxlcXVpdl9ifSJdLFsyLDEsIlxcZGlzdGYgXFxmdW5GIHtcXFBFeHB9L3tcXGVxdWl2X2J9Il0sWzQsMCwie1xcUEV4cH0ve1xcZXF1aXZ9Il0sWzIsMiwiXFxmdW5HIFxcZGlzdGYge1xcUEV4cH0ve3tcXGVxdWl2fV9ifSJdLFsyLDMsIlxcZnVuR3tcXFBFeHB9L3tcXGVxdWl2X2J9Il0sWzQsMywiXFxmdW5HIHtcXFBFeHB9L3tcXGVxdWl2fSJdLFswLDEsIlxccGFydGlhbCIsMl0sWzAsMiwiWy1dX3tcXGVxdWl2X2J9Il0sWzIsMywiXFxxY29hIiwyXSxbMSwzLCJcXGRpc3RmIFxcZnVuRiBbLV1fe1xcZXF1aXZfYn0iLDJdLFsyLDQsIlstXV97XFxlcXVpdn0iLDJdLFszLDUsIlxcZ2FtbWFfe3tcXFBFeHB9L3tcXGVxdWl2X2J9fSIsMl0sWzUsNiwiR1xcYWxwaGFfe1xcZXF1aXZfMH0iLDJdLFs2LDcsIlxcZnVuR1stXV97XFxlcXVpdn0iLDJdLFs0LDcsImQiLDAseyJzdHlsZSI6eyJib2R5Ijp7Im5hbWUiOiJkYXNoZWQifX19XV0=
\[\begin{tikzcd}
	\PExp && {{\PExp}/{\equiv_b}} && {{\PExp}/{\equiv}} \\
	{\distf \funF \PExp} && {\distf \funF {\PExp}/{\equiv_b}} \\
	&& {\funG \distf {\PExp}/{{\equiv}_b}} \\
	&& {\funG{\PExp}/{\equiv_b}} && {\funG {\PExp}/{\equiv}}
	\arrow["{[-]_{\equiv_b}}", from=1-1, to=1-3]
	\arrow["\partial"', from=1-1, to=2-1]
	\arrow["{[-]_{\equiv}}"', from=1-3, to=1-5]
	\arrow["\qcoa"', from=1-3, to=2-3]
	\arrow["d", dashed, from=1-5, to=4-5]
	\arrow["{\distf \funF [-]_{\equiv_b}}"', from=2-1, to=2-3]
	\arrow["{\gamma_{{\PExp}/{\equiv_b}}}"', from=2-3, to=3-3]
	\arrow["{G\alpha_{\equiv_b}}"', from=3-3, to=4-3]
	\arrow["{\funG[-]_{\equiv}}"', from=4-3, to=4-5]
\end{tikzcd}\]
}
\end{lemma}
The above lemma encapsulates the key step of the soundness proof. To establish the existence of $\funG$-coalgebra structure on ${\PExp}/{\equiv}$, we will rely on diagonal fill-in property~\cite[Lemma~3.17]{Gumm:2000:Elements} to show the existence of the $\funG$-coalgebra structure on ${\PExp}/{\equiv}$. Consequently, it suffices to demonstrate for all $e,f \in \PExp$ the following:
    \begin{equation}\label{c4:eqn:kernel}
    	e \equiv f \implies \funG[-]_\equiv \circ c (e) = \funG[-]_\equiv \circ c (f)
    \end{equation}
   We begin by demonstrating that the map on the right-hand side of the equation above can be expressed explicitly.
   \begin{lemma}\label{c4:lem:concrete_quotient}
    	For all $o \in \interval{0}{1}$ and indexed collections $\{p_i\}_{i \in I}$, $\{a_i\}_{i \in I}$, and $\{e_i\}_{i \in I}$, such that $p_i \in \interval{0}{1}$, $a_i \in \alphabet$ and $e_i \in \PExp$ for all $i \in I$ and $\sum_{i \in I} p_i \leq 1 - o$, we have that:
    	$$(\funG [-]_\equiv \circ c)\left( \left[ o \cdot \one \oplus \left( \bigoplus_{i \in I} p_i \cdot a_i \seq e_i\right) \right]_{\equiv_b} \right) = \left\langle o, \lambda a \ldotp \left[ \bigoplus_{a_i = a} p_i \cdot e_i\right]\right\rangle $$
    \end{lemma}
    \begin{proof}
    We first observe the following:
   	\begin{align*}
   		c &= \funG [-]_\equiv \circ \funG\alpha_{\equiv_b} \circ \gamma_{{\PExp}/{\equiv_b}} \circ \qcoa \circ [-]_{\equiv_b} \tag{Def. of $c$}\\
   		 &= \funG\alpha_{\equiv} \circ \funG \distf[-]_\equiv \circ \gamma_{{\PExp}/{\equiv_b}} \circ \qcoa \circ [-]_{\equiv_b} \tag{\Cref{c4:lem:coarser_quotient_is_a_pca}}\\
        &= \funG\alpha_{\equiv} \circ \funG \distf[-]_\equiv \circ \gamma_{{\PExp}/{\equiv_b}} \circ \distf \funF [-]_{\equiv_b} \circ \partial \tag{$[-]_{\equiv_b}$ is a $\distf \funF$-coalgebra homomorphism}\\
        &= \funG\alpha_{\equiv} \circ \funG \distf[-]_\equiv \circ \funG \distf [-]_{\equiv_b} \circ \gamma_{{\PExp}} \circ \partial \tag{\Cref{c4:prop:natural}} \\
        &= \funG\alpha_{\equiv} \circ \funG \distf[-] \circ \gamma_{{\PExp}} \circ \partial \tag{Definition of $[-]$}\\
		&= \funG\alpha_{\equiv} \circ \gamma_{{\PExp}/{\equiv}} \circ \distf \funF[-] \circ \partial \tag{\Cref{c4:prop:natural}}\\
    \end{align*}
    Using the above reasoning, we can obtain the following:
    \begin{align*}
		&\funG\alpha_{\equiv} \circ \gamma_{{\PExp}/{\equiv}} \circ \distf \funF[-] \circ \partial  \left(o \cdot \one \oplus \left( \bigoplus_{i \in I} p_i \cdot a_i \seq e_i \right)\right)\\
		&\quad= \funG\alpha_{\equiv} \circ \gamma_{{\PExp}/{\equiv}} \circ \distf \funF[-] \left(o \delta_{\checkmark} + \left( \sum_{i \in I} p_i  \delta_{(a_i, e_i)}\right)\right) \tag{Def. of $\partial$}\\
		&\quad= \funG\alpha_{\equiv} \circ \gamma_{{\PExp}/{\equiv}} \left(o \delta_{\checkmark} + \left( \sum_{i \in I} p_i  \delta_{(a_i, [e_i])}\right)\right)\\
		&\quad= \funG\alpha_{\equiv} \left\langle o, \lambda a\ldotp  \sum_{ a_i = a} p_i  \delta_{[e_i]}\right \rangle \tag{Def. of $\gamma$}\\
		&\quad= \left\langle o, \lambda a\ldotp  \left[\bigoplus_{ a_i = a} p_i \cdot e \right]\right \rangle \tag{\Cref{c4:thm:correspondence}}\\
	\end{align*}
    \end{proof}

	


Since the proof of \Cref{c4:lem:coalg_on_quotient_left_dist} equires passing through the quotient ${\PExp}/{\equiv_b}$, which identifies the expressions modulo the axioms of the finer relation $\equiv_b$, emains only to verify the soundness of axioms (\textsf{S0}) and (\textsf{D2}) present in the finer relation $\equiv$. 

Before proceeding, we first show that (\textsf{S0}) and (\textsf{D2}) can be reformulated in a simpler yet equally expressive form, which simplifies checking their soundness. Define the relation ${\uaequiv}\subseteq {\PExp \times \PExp}$ as follows:
Let ${\uaequiv} \subseteq {\PExp \times \PExp}$ be a relation defined by the following
\begin{enumerate}
    \item If $e \equiv_b f$, then $e \uaequiv f$
    \item $a \seq (e \oplus_p f) \uaequiv a\seq e \oplus_p a \seq f$
    \item $a \seq \zero \uaequiv \zero$
\end{enumerate}
for all $e,f \in \PExp$, $p \in \interval{0}{1}$ and $a \in \alphabet$. 

It can be easily seen that both relations are equal. 
\begin{lemma}\label{c4:lem:simpler_equivalence}
    For all $e,f \in \PExp$, $e \equiv f$ if and only if $e \uaequiv f$
\end{lemma}
\begin{proof}
    We split the proof into two cases.
    \begin{itemize}
        \item[] \fbox{$e \uaequiv f \implies e \equiv f$}

        This implication holds immediately. If $e \equiv_b f $, then $e \equiv f$. The remaining rules stating that $a \seq (e \oplus_p f) \uaequiv a\seq e \oplus_p a \seq f$ and $a \seq \zero \uaequiv \zero$ are special cases of (\textsf{D2}) and (\textsf{S0}) axioms of $\equiv$ specialised to single letters of the alphabet.

        \item[] \fbox{$e \equiv f \implies e \uaequiv f$}
        
        Axioms of $\equiv$ are either axioms of $\equiv_b$, which are already contained in $\uaequiv$ or are instances of (\textsf{D2})/(\textsf{S0}) axioms. It suffices to show that latter two are derivable in $\uaequiv$. First, we show by induction that for all $e \in \PExp$, $e \seq \zero \uaequiv \zero$.

        \begin{itemize}
            \item[]\fbox{$e = \zero$} 
            \begin{align*}
                e \seq \zero &\uaequiv \zero \seq \zero \tag{$e = \zero$}\\
                &\uaequiv \zero \tag{\textsf{0S}}
            \end{align*}

            \item[]\fbox{$e=\one$}
            \begin{align*}
                e \seq \zero &\uaequiv \one \seq \zero \tag{$e=\one$}\\
                &\uaequiv \zero \tag{\textsf{1S}}
            \end{align*}   

            \item[]\fbox{$e = a$}
            \begin{align*}
                e \seq \zero &\uaequiv a \seq \zero \tag{$e = a$}\\
                &\uaequiv \zero \tag{Def. of $\uaequiv$}
            \end{align*}

            \item[]\fbox{$e = f \oplus_p g$}
            \begin{align*}
                e \seq \zero &\uaequiv (f \oplus_p g) \seq \zero \tag{$e = f \oplus_p g$}\\
                &\uaequiv f \seq \zero \oplus_p g \seq \zero \tag{\textsf{D1}} \\
                &\uaequiv \zero \oplus_p \zero \tag{Induction hypothesis} \\
                &\uaequiv \zero \tag{\textsf{C1}}
            \end{align*}

            \item[]\fbox{$e = f\seq g$}
            \begin{align*}
                e \seq \zero &\uaequiv (f \seq g) \seq \zero \tag{$e = f \seq g$}\\
                &\uaequiv f \seq (g \seq \zero) \tag{\textsf{S}} \\
                &\uaequiv f \seq \zero\tag{Induction hypothesis} \\
                &\uaequiv \zero \tag{Induction hypothesis}
            \end{align*}

            \item[]\fbox{$e = f^{[p]}$}

            First, by \Cref{c4:cor:productive_loop} we know that $f^{[p]} \uaequiv g^{[r]}$, such that $E(g)=0$.

            \begin{align*}
                \zero &\uaequiv \zero \oplus_r \zero \tag{\textsf{C1}} \\
                &\uaequiv g \seq \zero \oplus_r \zero \tag{Induction hypothesis}
            \end{align*}
            Since $E(g)= 0$, we can use unique fixpoint axiom and obtain:
            \begin{align*}
                \zero &\uaequiv g^{[r]}\seq \zero \tag{\textsf{Unique}}\\
                &\uaequiv f^{[p]} \seq \zero \tag{\Cref{c4:cor:productive_loop}}
            \end{align*}
        \end{itemize}
        Secondly, we show by induction that for all $e,f,g \in \PExp$ and $p \in \interval{0}{1}$ we have that $e \seq (f \oplus_p g) \uaequiv e \seq f \oplus_p e \seq g$.
        \begin{itemize}
            \item[] \fbox{$e = \zero$}
            \begin{align*}
                e \seq (f \oplus_p g ) &\uaequiv \zero \seq (f \oplus_p g ) \tag{$e = \zero$} \\
                &\uaequiv \zero \tag{\textsf{0S}} \\
                &\uaequiv \zero \oplus_p \zero \tag{\textsf{C1}} \\
                &\uaequiv \zero\seq f \oplus_p \zero \seq g \tag{\textsf{0S}}\\
            \end{align*}

            \item[] \fbox{$e=\one$}
            \begin{align*}
                e \seq (f \oplus_p g) &\uaequiv \one \seq (f \oplus_p g) \tag{$e=\one$}\\
                &\uaequiv f \oplus_p g \tag{\textsf{1S}} \\
                &\uaequiv \one \seq f \oplus_p \one \seq g \tag{\textsf{1S}}\\
            \end{align*}

            \item[] \fbox{$e=a$}
            \begin{align*}
                e \seq (f \oplus_p g) &\uaequiv a \seq (f \oplus_p g) \tag{$e = a$}\\
                &\uaequiv a \seq f \oplus_p a \seq g \tag{Def. of $\uaequiv$} \\
            \end{align*}

            \item[] \fbox{$e=h \oplus_r i$}
            \begin{align*}
                e \seq (f \oplus_p g) &\uaequiv (g \oplus_r h) \seq (f \oplus_p g) \tag{$e = h \oplus_r i$}\\
                &\uaequiv h\seq(f \oplus_p g) \oplus_r i \seq (f \oplus_p g) \tag{\textsf{D1}} \\
                &\uaequiv (h\seq f \oplus_p h\seq g) \oplus_r (i \seq f \oplus_p i \seq g) \tag{Induction hypothesis} \\
                &\uaequiv (h \seq f \oplus_r i \seq f) \oplus_p (h \seq g \oplus_r i \seq g) \tag{\Cref{c4:lem:binary_sum_properties}}\\
                &\uaequiv (h \oplus_r i)\seq f \oplus_p (h \oplus_r i) \seq g \tag{\textsf{D1}} \\
            \end{align*}
            
            \item[] \fbox{$e = h \seq i$}
            \begin{align*}
            	e \seq (f \oplus_p g) &\uaequiv (h \seq i) \seq  (f \oplus_p g) \tag{$e = h \seq i$} \\
            	&\uaequiv h \seq (i\seq  (f \oplus_p g)) \tag{\textsf{S}} \\
            	&\uaequiv h \seq   (i\seq f \oplus_p i\seq g) \tag{Induction hypothesis}\\
            	&\uaequiv  ( h \seq (i\seq f) \oplus_p h \seq (i\seq g)) \tag{Induction hypothesis}\\
            	&\uaequiv   (h \seq i) \seq  f \oplus_p  (h \seq i) \seq g \tag{\textsf{S}}
            \end{align*}

            \item[] \fbox{$e = h^{[r]}$}
            
             First, by \Cref{c4:cor:productive_loop} we know that $h^{[r]} \uaequiv i^{[q]}$, such that $E(i)=0$.

             Next, we derive the following:
             \begin{align*}
                 i^{[q]} \seq f \oplus_p i^{[q]} \seq g  &\uaequiv (i \seq i^{[q]} \oplus_q \one) \seq f \oplus_p  (i \seq i^{[q]} \oplus_q \one) \seq g \tag{\textsf{Unroll}}\\
                 &\uaequiv (i \seq i^{[q]} \seq f \oplus_q \one \seq f)  \oplus_p  (i \seq i^{[q]} \seq g \oplus_q \one \seq g) \tag{\textsf{D1}}\\
                 &\uaequiv (i \seq i^{[q]} \seq f \oplus_q f)  \oplus_p  (i \seq i^{[q]} \seq g \oplus_q g) \tag{\textsf{0S}} \\
                 &\uaequiv (i \seq i^{[q]} \seq f \oplus_p i \seq i^{[q]} \seq g) \oplus_q (f \oplus_p g) \tag{\Cref{c4:lem:binary_sum_properties}}\\
                 &\uaequiv i \seq (i^{[q]} \seq f \oplus_p i^{[q]} \seq g) \oplus_q (f \oplus_p g) \tag{Induction hypothesis}
             \end{align*}
            Since $E(i)=0$, we can use (\textsf{Unique}) rule to derive
            \begin{align*}
                 i^{[q]} \seq f \oplus_p i^{[q]} \seq g \uaequiv i^{[q]} \seq (f \oplus_p g)
            \end{align*}
            Since $h^{[r]} \uaequiv i^{[q]}$, we have that
            \begin{align*}
                 h^{[r]} \seq f \oplus_p h^{[r]} \seq g \uaequiv h^{[r]} \seq (f \oplus_p g)
            \end{align*}
            This completes the proof.
        \end{itemize}
    \end{itemize}
\end{proof}
We now have all the ingredients to obtain the desired result.
\begin{proof}[Proof of \Cref{c4:lem:coalg_on_quotient_left_dist}]
	Assume $e \equiv f$. Because of \Cref{c4:lem:simpler_equivalence}, we have that $e \uaequiv f$. We will argue that $(\funG [-]_{\equiv} \circ c)\left( [e]_{\equiv_b} \right) = (\funG [-]_{\equiv} \circ c)\left([f]_{\equiv_b}\right)$. Because of the definition of $\uaequiv$ we have only three cases to consider.
 \begin{itemize}
	\item[] \fbox{$e \equiv_b f$}
	
		 In this case, it follows immediately that $[e]_{\equiv_b} = [f]_{\equiv_\beta}$, which implies \Cref{c4:eqn:kernel}.
	\item[] \fbox{$b \seq (g \oplus_p h) \uaequiv b \seq g \oplus_p b \seq h$}
	
		Applying $\funG [-]_\equiv \circ c$ and using \Cref{c4:lem:concrete_quotient} to both sides immediately gives
		$$
			(\funG [-]_{\equiv} \circ c)[b \seq (g \oplus_p h)]_{\equiv} = \left\langle 0, s \right\rangle = (\funG [-]_{\equiv} \circ c)[b \seq g \oplus_p b \seq h]_{\equiv}
		$$
		where $s \colon \alphabet \to {\PExp}/{\equiv}$ is a function given by
		$$
			s(a) = \begin{cases}
				[g \oplus_p h] & \text{if } a=b\\
				[\zero] & \text{ otherwise} 
			\end{cases}
		$$
	\item[] \fbox{$b \seq \zero \uaequiv \zero$}
	
	Once again, we apply \Cref{c4:lem:concrete_quotient} and obtain the following:
		$$
			(\funG [-]_{\equiv} \circ c)[b \seq \zero]_{\equiv} = \left\langle 0, \lambda a \ldotp [\zero] \right\rangle = (\funG [-]_{\equiv} \circ c)[\zero]_{\equiv}
		$$
 \end{itemize}
\end{proof}
As a direct corollary of \Cref{c4:lem:concrete_quotient} and the result established above, we obtain a concrete characterisation of the map  $d$. 
\begin{corollary}\label{c4:cor:concrete_coalgebra}
	For all $\left[ o \cdot \one \bigoplus_{i \in I} p_i \cdot a_i \seq e_i\right] \in {\PExp}/{\equiv}$, we have that
	$$
		d \left( \left[ o \cdot \one \bigoplus_{i \in I} p_i \cdot a_i \seq e_i\right] \right) = \left\langle o, \lambda a \ldotp \left[ \bigoplus_{a_i = a} p_i \cdot e_i\right]\right\rangle
	$$
\end{corollary}
\subsection{Step 4: Soundness result}
Through a simple finality argument, we can show that the unique $\funG$-coalgebra homomorphism from the determinisation of the Antimirov transition system, can be viewed as the following composition of homomorphisms, which we have obtained in the earlier steps.

\begin{lemma}\label{c4:lem:factoring_lemma}
	The following diagram commutes:
	% https://q.uiver.app/#q=WzAsNSxbMiwwLCJ7XFxQRXhwfS97XFxlcXVpdl9ifSJdLFszLDAsIlxcUEV4cC97XFxlcXVpdn0iXSxbMSwwLCJcXGRpc3Rme3tcXFBFeHB9L3tcXGVxdWl2X3tifX19Il0sWzQsMCwiWzAsMV1ee0FeKn0iXSxbMCwwLCJcXGRpc3RmIFxcUEV4cCJdLFswLDEsIlstXV97XFxlcXVpdn0iXSxbMiwwLCJcXGFscGhhX3tcXGVxdWl2X2J9Il0sWzEsMywiXFxiZWh7ZH0iLDAseyJzdHlsZSI6eyJib2R5Ijp7Im5hbWUiOiJkYXNoZWQifX19XSxbNCwyLCJcXGRpc3RmIFstXV97XFxlcXVpdl9ifSJdLFs0LDMsIlxcYmVoIHsoXFxnYW1tYV97XFxQRXhwfSBcXGNpcmMgXFxwYXJ0aWFsKV57XFxzaGFycH19IiwyLHsiY3VydmUiOjN9XV0=
\[\begin{tikzcd}
	{\distf \PExp} & {\distf{{\PExp}/{\equiv_{b}}}} & {{\PExp}/{\equiv_b}} & {\PExp/{\equiv}} & {\interval{0}{1}^{\alphabet^*}}
	\arrow["{\distf [-]_{\equiv_b}}", from=1-1, to=1-2]
	\arrow["{\beh {(\gamma_{\PExp} \circ \partial)^{\sharp}}}"', curve={height=18pt}, from=1-1, to=1-5]
	\arrow["{\alpha_{\equiv_b}}", from=1-2, to=1-3]
	\arrow["{[-]_{\equiv}}", from=1-3, to=1-4]
	\arrow["{\beh{d}}", dashed, from=1-4, to=1-5]
\end{tikzcd}\]	
\end{lemma}
\begin{proof}
	By combining \Cref{c4:lem:homom_of_determinisations}, \Cref{c4:lem:algebra_map_coalgebra_homomorphism}, and \Cref{c4:lem:coalg_on_quotient_left_dist}, we conclude that $\distf [-]_{\equiv_b} \circ \alpha_{\equiv_b} \circ [-]_{\equiv_b}$ is a $\funG$-coalgebra homomorphism from $\left(\distf \PExp, (\gamma_{\PExp} \circ \partial)^\sharp\right)$ to $({\PExp}/{\equiv}, d)$. Composing with a final map $\beh{d}$ into it, we obtain a $\funG$-coalgebra homomorphism  rom $\left(\distf \PExp, (\gamma_{\PExp} \circ \partial)^\sharp\right)$ into the final coalgebra $\left( \interval{0}{1}^{\alphabet^\ast}, t \right)$, which, by finality must be equal to $\beh {(\gamma_{\PExp} \circ \partial)^{\sharp}}$.
\end{proof}
Since the language-assigning map relies on the homomorphism described above, we can show the following:
\begin{lemma}\label{c4:lem:factoring_lemma2} The function $\sem{-} \colon \PExp \to \interval{0}{1}^{\alphabet^\ast}$ assigning each expression to its semantics satisfies:
$
    \llbracket - \rrbracket = \beh{d} \circ [-]
$. 
\end{lemma}
 \begin{proof}
    \begin{align*}
        \llbracket - \rrbracket &= \dagger (\gamma_{\PExp} \circ \partial)^{\sharp} \circ \eta_{\PExp} \tag{Def. of $\llbracket - \rrbracket$}\\
        &=\beh{d} \circ [-]_{\equiv} \circ \alpha_{\equiv_b} \circ \distf [-]_{\equiv_b} \circ \eta_{\PExp}\tag{\Cref{c4:lem:factoring_lemma}}\\
        &=\beh{d} \circ [-]_{\equiv} \circ \alpha_{\equiv_b} \circ \eta_{{\PExp}/{\equiv_b}} \circ [-]_{\equiv_b} \tag{$\eta$ is natural}\\
        &=\beh{d} \circ [-]_{\equiv} \circ [-]_{\equiv_b} \tag{$\alpha_\equiv$ is an Eilenberg-Moore algebra}\\
        &= \beh{d} \circ [-] \tag{$[-] = [-]_{\equiv} \circ [-]_{\equiv_b} $}\\
    \end{align*}
 \end{proof}
 We can now immediately conclude that provably equivalent expressions are mapped to the same probabilistic languages, thus establishing soundness.
% We can now conclude with the desired soundness result.
\begin{theorem}[Soundness]\label{c4:thm:soundness}
    For all $e,f \in \PExp$, if $e \equiv f$ then $\sem {e} = \sem{f}$.
\end{theorem}
\section{Completeness}\label{c4:sec:completeness}
The completeness proof will follow a pattern of earlier work of Jacobs~\cite{Jacobs:2006:Bialgebraic}, Silva~\cite{Silva:2010:Kleene} and Milius~\cite{Milius:2010:Sound} and show that the coalgebra structure on the ${\PExp}/{\equiv}$ is isomorphic to the subcoalgebra of an appropriate final coalgebra, ie. the unique final coalgebra homomorphism from ${\PExp}/{\equiv}$ is injective. The intuition comes from the coalgebraic modelling of deterministic automata studied in the work of Jacobs~ \cite{Jacobs:2006:Bialgebraic}. In such a case, the final coalgebra is simply the automaton structure on the set of all formal languages, while the final homomorphism is given by the map taking a state of the automaton to a language it denotes. Restricting the attention to finite-state automata only yields \emph{regular languages}. The set of regular languages can be equipped with an automaton structure, in a way that inclusion map into the final automaton on the set of all formal languages becomes a homomorphism. In such a case, Kozen's completeness proof of Kleene Algebra~\cite{Kozen:1994:Completeness} can be seen as showing isomorphism of the automaton of regular languages and the automaton structure on the regular expressions modulo {KA} axioms. 

Unfortunately, we cannot immediately rely on the identical pattern. Our semantics relies on determinising {GPTS}, but unfortunately, determinising a finite-state {GPTS} can yield $\funG$-coalgebras with infinite carriers. For example, determinising a single-state {GPTS} would yield a $\funG$-coalgebra over the set of subdistributions over a singleton set, which is infinite. Luckily, all $\funG$-coalgebras we work with have additional algebraic structure. This algebraic structure will allow us to rely on the generalisations of the concept of finiteness beyond the category of sets, offered by the theory of locally finite presentable categories~\cite{Adamek:1994:Locally}. Being equipped with those abstract lenses, one can immediately see that the earlier mentioned infinite set of all subdistributions over a singleton set is also a free $\pca$ generated by a single element and thus finitely presentable~\cite{Sokolova:2015:Congruences}. 
	
In particular, we will work with a \emph{rational fixpoint}; a generalisation of the idea of subcoalgebra of regular languages to coalgebras for finitary functors $\funB : \A \to \A$ over locally finitely presentable categories. The rational fixpoint provides a semantical domain for the behaviour of coalgebras whose carriers are finitely presentable in the same way as regular languages provide a semantic domain for all finite-state deterministic automata. The completeness proof will essentially rely on establishing that the coalgebra structure on ${\PExp}/{\equiv}$ satisfies the universal property of the rational fixpoint.

We now move on to showing completeness through the steps described in \Cref{c4:sec:roadmap}. 
\subsection{Step 1: Algebra structure}
Throughout the soundness proof, we have shown that the semantics of any expression $e \in \PExp$ can also be seen as the language of the state corresponding to the equivalence class $[e]$ in the deterministic transition system ($\funG$-coalgebra) defined on the set ${\PExp}/{\equiv}$. The completeness proof will rely on establishing that this coalgebra possesses a universal property of rational fixpoint, that will imply completeness. A first step in arguing so is observing that the coalgebra $\left({\PExp}/{\equiv},d \right)$ interacts well with an algebra structure on ${\PExp}/{\equiv}$ defined in \Cref{c4:lem:coarser_quotient_is_a_pca}. 
Thanks to the fact that we can lift $\funG \colon \Set \to \Set$ to $\overline{\funG} \colon \pca \to \pca$, the set $\funG{\PExp}/{\equiv}$ also carries the algebra structure. In such a setting, the transition function $d \colon {\PExp}/{\equiv} \to \funG {\PExp}/{\equiv}$ becomes an algebra homomorphism.
\begin{lemma}\label{c4:smappcahomom}
    $d \colon {\PExp}/{\equiv} \to \funG{\PExp}/{\equiv}$ is a $\pca$ homomorphism $$d \colon ({\PExp}/{\equiv}, \alpha_{\equiv}) \to \overline{\funG}({\PExp}/{\equiv}, \alpha_{\equiv})$$
\end{lemma}
\begin{proof}
        We need to show that $d \left(\bigboxplus_{i \in I} p_i \cdot [e_i]\right) = \bigboxplus_{i \in I} p_i \cdot d([e_i])$.
        As a consequence of \Cref{c4:thm:fundamental_theorem}, we can safely assume that 
        $e_i \equiv q^i \cdot \one \oplus \bigoplus_{j \in J} r^i_j \cdot a^i_j \seq e^i_j$ for all $i \in I$
        and hence 
        $d([e_i]) = \left\langle q^i , \lambda a \ldotp \left[\bigoplus_{a = a^i_j} r^i_j \cdot e^i_j\right] \right\rangle$.
        We show the following:
        \begin{align*}
            d \left(\bigboxplus_{i \in I} p_i \cdot [e_i]\right) &= d \left(\left[\bigoplus_{i \in I} p_i \cdot e_i\right]\right) \tag{\Cref{c4:lem:coarser_quotient_is_a_pca}}\\
            &=d \left(\left[ \bigoplus_{i \in I} p_i \cdot \left(q^i \cdot \one \oplus \bigoplus_{j \in J} r^i_j \cdot a^i_j \seq e^i_j\right) \right]\right) \tag{Def. of $e_i$}\\
            &= d \left( \bigoplus_{i \in I} p_i q^i \cdot \one \oplus \bigoplus_{(i,j) \in I \times J} p_ir^i_j \cdot a^i_j \seq e^{i}_j\right) \tag{\Cref{c4:lem:flattening_convex_sums}} \\
            &= \left\langle \sum_{i \in I} p_i q^i, \lambda a \ldotp \left[\bigoplus_{a = a^i_j} p_ir^i_j \cdot e^i_j\right]\right\rangle \tag{\Cref{c4:cor:concrete_coalgebra}}\\
            &= \left\langle \sum_{i \in I} p_i q^i, \lambda a \ldotp \left[\bigoplus_{i \in I} p_i \cdot \left(\bigoplus_{a = a^i_j} r^i_j \cdot e^i_j\right)\right]\right\rangle \tag{\Cref{c4:lem:flattening_convex_sums}} \\
            &= \left\langle \sum_{i \in I} p_i q^i, \lambda a \ldotp \bigboxplus_{i \in I} p_i \cdot \left[\bigoplus_{a = a^i_j} r^i_j \cdot e^i_j\right]\right\rangle \tag{\Cref{c4:lem:coarser_quotient_is_a_pca}}\\
            &= \bigboxplus_{i \in I} p_i \left\langle q^i , \lambda a \ldotp \left[\bigoplus_{a = a^i_j} r^i_j \cdot e^i_j\right] \right\rangle \tag{Def. of $\overline{\funG}$}\\
            &= \bigboxplus_{i \in I} p_i \cdot d(e_i) \tag{\Cref{c4:cor:concrete_coalgebra}}
        \end{align*}
  \end{proof}
  As a consequence of the result showed above, we have that $$\left({\PExp}/{\equiv}, d \colon \left({\PExp}/{\equiv}, \alpha_{\equiv}\right) \to \overline{\funG}\left({\PExp}/{\equiv}, \alpha_{\equiv}\right)\right)$$ is a $\overline{\funG}$-coalgebra.
\subsection{Step 2: Proper functors}
It can be easily noticed that the generalised determinisation of coalgebras with finite carriers corresponds to algebraically structured coalgebras of a particular, well-behaved kind. Namely, their carriers are algebras which are free finitely generated. We write $\coafr{\funB}$ for the subcategory of $\coa{B}$ consisting only of $\funB$-coalgebras with free finitely generated carriers. The recent work of Milius~\cite{Milius:2018:Proper} characterised \emph{proper} functors, for which in order to establish that some $\funB$-coalgebra is isomorphic to the rational fixpoint it will suffice to look at coalgebras with free finitely generated carriers. To put that formally:
\begin{theorem}[{\cite[Corollary~5.9]{Milius:2018:Proper}}]\label{c4:thm:proper}
    Let $\funB \colon \Set^\monadT \to \Set^\monadT$ be a proper functor. Then a $\funB$-coalgebra $(R,r)$ is isomorphic to the rational fixpoint if $(R,r)$ is locally finitely presentable and for every $\funB$-coalgebra $(TX, c)$ in $\coafr{\funB}$ there exists a unique homomorphism from $TX$ to $R$.
\end{theorem}
As much as $\overline{\funG} \colon \pca \to \pca$ is known to be proper~\cite{Sokolova:2018:Proper}, not every $\overline{\funG}$-coalgebra with a free finitely generated carrier corresponds to a determinisation of some (converted) GPTS. This is simply too general, as some $\overline\funG$-coalgebras with free finitely generated carriers might be determinisations of RPTS not corresponding to any GPTS. To circumvent that, instead of looking at all coalgebras for the functor $\overline{\funG} \colon \pca \to \pca$, we can restrict our attention in a way that will exclude determinisations of {RPTS} not corresponding to any {GPTS}. To do so, define a functor $\hat{\funG} \colon \pca \to \pca$. Given a positive convex algebra $\mathbb{X}$ defined on a set $X$, we define:
\begin{align*}
    \hat{\funG} \mathbb{X}  = &\{(o, f) \in \interval{0}{1} \times X^\alphabet \mid \forall {a \in \alphabet}\ldotp\exists {p_a^i \in [0,1], x_a^i \in X}\ldotp \\ &f(a) = \bigboxplus_{i \in I} p_a^i x_a^i \text{ and } \sum_{a \in \alphabet} \sum_{i \in I} p_a^i \leq 1-o\}
\end{align*}
The $\pca$ structure on $\hat{\funG}\mathbb{X}$, as well as the action of $\hat{\funG}$ on arrows is defined to be the same as in the case of $\funG$. 
It can be immediately observed that $\hat{\funG}$ is a subfunctor of $G$. Whenever the algebra structure is clear from the context, we write $\hat{\funG}X$ for $\hat{\funG}\mathbb{X}$. Most importantly for us, thanks to the result of Sokolova and Woracek, we know that $\hat{\funG}$ is also proper~\cite{Sokolova:2018:Proper}. We can now see the following correspondence:
\begin{lemma}\label{lem:onetoone_sublemma}
    $\distf \funF$-coalgebras with finite carriers are in one-to-one correspondence with $\hat{\funG}$-coalgebras with free finitely generated carriers.
    % $$\inferrule{\beta : X \to \distf F X \text{ on } \Set}{(\gamma_X \circ \beta)^\sharp : (\distf X, \mu_X) \to \hat{\funG} (\distf X, \mu_X) \text{ on } \pca}$$    
    $$\mprset{fraction={===}}
      \inferrule {\beta \colon X \to \distf \funF X \text{ in } \Set} {\xi : (\distf X, \mu_X) \to \hat{\funG} (\distf X, \mu_X) \text{ in } \pca}$$ 
      In other words, every coalgebra structure map $\xi \colon (\distf X, \mu_X) \to \hat{\funG} (\distf X, \mu_X)$ is given by $\xi = (\gamma_X \circ \beta)^\sharp$ for some unique $\beta \colon X \to \distf \funF X$.
\end{lemma}
\begin{proof}
    Since $X$ is finite,  we can assume that $X = \{s_i\}_{i \in I}$ for some finite set $I$.
    Because of the free-forgetful adjunction between $\pca$ and $\Set$, we have the following correspondence of maps:
    $$\mprset{fraction={===}}
        \inferrule{\zeta \colon X \to \funG \distf X \text{ on } \Set}{\xi \colon (\distf X, \mu_X) \to \funG(\distf X, \mu_X) \text{ on } \pca}
    $$
    First, we show that for all $x \in X$, we have that $\gamma_X \circ \beta(x) \in \hat{\funG} \distf X$. Pick an arbitrary $x \in X$. 
    For every $a \in \alphabet$ define $p_i^a = \beta(x)(a,s_i)$. This implies that $(\pi_2 \circ \gamma_X \circ \beta)(x)(a)(x_i) = p_i^a$ if $x_i \in S$. Therefore, we have
    $$(\gamma_X \circ \beta)(x) = \left\langle\beta(x)(\checkmark), \lambda a \ldotp \sum_{i \in I} p_i^a \delta_{x_i^a} \right\rangle$$
	Using the isomorphism between $\pca$ and $\Set^\distf$, we can reformulate the above as
    $$(\gamma_X \circ \beta)(x) = \left\langle\beta(x)(\checkmark), \lambda a \ldotp \bigboxplus_{i \in I} p_i^a \cdot {x_i^a} \right\rangle$$
    where $\boxplus$ denotes the structure map of $\pca$ isomorphic to $(\distf X, \mu_X)$, the free Eilenberg-Moore algebra generated by $X$. 
    From the well-definedness of $\beta(x)$ it follows that:
    $$\sum_{a \in \alphabet} \sum_{i \in I} p_i^a \leq 1 - \beta(x)(\checkmark)$$
    which establishes that $\gamma_X \circ \beta(x) \in \hat{\funG} \distf X$.

    For the converse, observe that every arrow $\xi \colon (\distf X, \mu_X) \to \hat{\funG} \distf (\distf X, \mu_X)$ in $\pca$ arises as an extension of $\zeta \colon X \to \forget\hat{\funG} (\distf X, \mu_X)$. Furthermore, any such $\zeta$ can be expressed as composition $\gamma_X \circ \beta$, where $\beta(x)(\checkmark) = \pi_1 \circ \zeta(x)$ and $\beta(x)(a,x') = \pi_2 \circ \zeta(x)(a)(x')$. The fact that $\zeta(x) \in \hat{\funG}\distf X$ ensures that $\beta(x)$ is a well-defined subdistribution. Finally, since $\gamma_X$ is injective (\Cref{c4:prop:natural}), $\beta$ is unique.
\end{proof}
Next, we argue that the coalgebra structure on ${\PExp}/{\equiv}$, which is at the centre of attention of the completeness proof, happens also to be a $\hat{\funG}$-coalgebra. 
\begin{lemma}\label{c4:lem:determinisations_correspond_to_df_coalgebras}
    $(({\PExp}/{\equiv}, \alpha_{\equiv}), d)$ is a $\hat{\funG}$-coalgebra.
\end{lemma}
Before we prove the lemma above, we establish two intermediate results. First, we show the lemma allowing to establish that the coalgebra structure on ${\PExp}/{\equiv}$ defined in \Cref{c4:sec:soundness_coalgebra} is also a $\hat{\funG}$-coalgebra.
\begin{lemma}\label{c4:lem:iamge_of_natural_transformation}
    Let $(X, \alpha)$ be a $\pca$. Then for every $\zeta \in \distf \funF X$ we have that $\funG\alpha \circ \gamma_X (\zeta)\in \forget\hat{\funG} (X, \alpha)$.
\end{lemma}
\begin{proof}
	Let $\zeta \in \distf \funF X$. Recall that $\gamma_X(\zeta) = \langle \zeta(\checkmark), \lambda a \ldotp \lambda x \ldotp \zeta(a,x)\rangle$.
    Let $S = \{x \in X \mid \exists a \in \alphabet \ldotp (a,x) \in \supp(\zeta)\}$. Without the loss of generality, we can assume that $S = \{s_i\}_{i \in I}$ for some finite set $I$. For every $a \in \alphabet$ define $p_i^a = \zeta(a,s_i)$. This implies that $(\pi_2 \circ \gamma_X)(\zeta)(a)(x_i) = p_i^a$ if $x_i \in S$ or  $(\pi_2 \circ \gamma_X)(\zeta)(a)(x_i) =0 $ otherwise. Therefore, we have the following:
        $$
    (\funG\alpha \circ \gamma_X)(\zeta) = \left\langle
    \zeta(\checkmark), \lambda a\ldotp \bigboxplus_{i\in I} p_i^a \cdot s_i
    \right\rangle
    $$
    Finally, since $\zeta \in \distf \funF X$ we have that $\sum_{a \in \alphabet} \sum_{i \in I} p_i^a \leq 1 - \zeta(\checkmark)$ which proves that indeed the image of $G \alpha \circ \gamma_X$ belongs to $\forget \hat{\funG} (X, \alpha)$.
\end{proof}
Next, we show that surjective $\overline{G}$-coalgebra homomorphisms preserve $\hat{\funG}$.
\begin{lemma}\label{c4:lem:closed_under_quotients}
    $\hat{\funG}$-coalgebras are closed under quotients.
\end{lemma}
\begin{proof}
 Let $((X, \alpha_X), \beta_X)$ be a $\hat{\funG}$-coalgebra, $((Y, \alpha_Y), \beta_Y)$ be a $\overline{\funG}$-coalgebra and let $e \colon X \to Y$ be a surjective $\overline{\funG}$-homomorphism $e \colon ((X, \alpha_X), \beta_X) \to ((Y, \alpha_Y),\beta_Y)$. We need to show that for all $y \in Y$, $\beta_Y(y) \in \forget \hat{\funG} (Y, \alpha_Y)$. 
 Pick an arbitrary $y \in Y $. Since $e \colon X \to Y $ is surjective, we know that $y=e(x)$. Let $\beta_X(x) = \langle o, f\rangle$. We have that: 
 $$\beta_Y(y) = (\beta_Y \circ e) (x) = ({\funG} e \circ \beta_X)(x) = \langle o, e \circ f \rangle $$
Since $\beta_X(x) \in \hat{\funG}X$, we have that for all $a \in \alphabet$ there exist $p_a^i \in \interval{0}{1}$ and $x_a^i \in X$ such that $f(a)=\bigboxplus_{i \in I} p_a^i x_a^i$ and $\sum_a \sum_{i \in I} p_a^i \leq 1 - o$. Let $e(x_a^i)=y_a^i$.
For all $a \in \alphabet$, we have that:
$$(e \circ f)(a) = e \left( \bigboxplus_{i \in I} p_a^i \cdot x_a^i \right) = \bigboxplus_{i \in I} p_a^i \cdot e(x_a^i)= \bigboxplus_{i \in I} p_a^i \cdot y_a^i$$
Therefore, for all $a \in \alphabet$ there exist $p_a^i \in \interval{0}{1}$ and $y_a^i \in X$ such that $f(a)=\bigboxplus_{i \in I} p_a^i y_a^i$ and $\sum_a \sum_{i \in I} p_a^i \leq 1 - o$, which completes the proof.
\end{proof}
We are ready to prove the desired result.
\begin{proof}[Proof of \Cref{c4:lem:determinisations_correspond_to_df_coalgebras}]
	    Recall that $({({\PExp}/{\equiv}, \alpha_{\equiv})},d)$ is a quotient coalgebra of $$({\PExp}/{\equiv_b}, \funG\alpha_{\equiv_b} \circ \gamma_{{\PExp}/{\equiv_b}} \circ \qcoa)$$
	     which by \Cref{c4:lem:iamge_of_natural_transformation} is a $\hat{\funG}$-coalgebra. Because of \Cref{c4:lem:closed_under_quotients} so is $({{\PExp}/{\equiv}}, d)$.
\end{proof}
Moreover, when regarded as $\hat{\funG}$-coalgebra, $\left((\PExp/{\equiv}, \alpha_{\equiv}), d \right)$ forms a fixpoint of the functor, meaning $d$ is an isomorphism.
\begin{lemma}\label{c4:lem:isomorphism_quotient}
	$d \colon (\PExp, \alpha_{\equiv}) \to \hat{\funG}(\PExp, \alpha_{\equiv})$ is an isomorphism
\end{lemma}
\begin{proof}
	We construct a map $d^{-1} \colon \hat{\funG} ({\PExp}/{\equiv}, \alpha_{\equiv}) \to ({\PExp}/{\equiv}, \alpha_{\equiv})$ and show that $d \circ d^{-1} = \id = d^{-1} \circ d$. Given that the forgetful functor $\forget \colon \pca \to \Set$ is conservative (reflects isomorphisms), this will immediately imply that $d^{-1}$ is a $\pca$ homomorphism.
    Given $\langle o , f \rangle \in \hat{\funG} X$, such that for any $a \in \alphabet$, and $f(a) = \bigboxplus_{i \in I} p_a^i [e_a^i]$ for some $p_a^i \in \interval{0}{1}$, and $[e_a^i] \in {\PExp}/{\equiv}$, we define the following:
    $$
    d^{-1} \langle o, f\rangle = \left[ o \cdot \one \oplus \left(\bigoplus_{(a,i) \in \alphabet\times I} p_a^i \cdot a \seq e_a^i\right) \right]
    $$
    The expression inside the brackets is well defined as $\sum_{a} \sum_{i \in I} p_a^i \leq 1-o$. To show that $d^{-1}$ is well-defined, assume that we have $g \colon \alphabet \to {\PExp}/{\equiv}$, such that $f(a)=g(a) = \bigboxplus_{i \in I} q_a^i [h_a^i]$ for all $a \in \alphabet$ and some $q_a^i \in [0,1]$ and $[h_a^i] \in {\PExp}/{\equiv}$. To begin, due to the definition of the $\pca$ structure on ${\PExp}/{\equiv}$ (\Cref{c4:lem:coarser_quotient_is_a_pca}), we have that:
    $$
    \left[\bigoplus_{i \in I} p_a^i \cdot e_a^i\right] = \bigboxplus_{i \in I} p_a^i [e_a^i] = \bigboxplus_{i \in I} q_a^i [h_a^i]  =  \left[\bigoplus_{i \in I} q_a^i \cdot h_a^i\right]
    $$
    Using the above, we can show:
    \begin{align*}
        d^{-1}\langle o, f\rangle &= \left[ o \cdot \one \oplus \left( \bigoplus_{(a,i) \in \alphabet \times I} p^i_a \cdot a  \seq e^i_a\right) \right]\\
               &= \left[ o \cdot \one \oplus \left( \bigoplus_{(a,i) \in \alphabet \times I} q^i_a \cdot a  \seq h^i_a\right) \right]\tag{$\equiv$ is a congruence}\\
        &= d^{-1}\langle o, g \rangle
    \end{align*}
    This establishes the well-definedness of $d^{-1}$. To verify one side of the isomorphism, consider the following:
    \begin{align*}
        (d \circ d^{-1}) (\langle o, f\rangle) &= d \left(\left[o \cdot \one \oplus \left(\bigoplus_{(a,i) \in \alphabet\times I} p_a^i \cdot a \seq e_a^i\right)\right]\right) \tag{Def. of $d^{-1}$}\\
        &= \left\langle o, \lambda a \ldotp \left[\bigoplus_{i \in I} p_a^i \cdot e_a^i\right]\right\rangle \tag{\Cref{c4:cor:concrete_coalgebra}}\\
        &= \left\langle o, \bigboxplus_{i \in I} p_a^i \cdot [e_a^i] \right\rangle \tag{\Cref{c4:lem:coarser_quotient_is_a_pca}}\\
        &= \langle o, f \rangle
    \end{align*}
	For the converse direction, let$[e] \in {\PExp}/{\equiv}$. By \Cref{c4:thm:fundamental_theorem}, we have that:
    $$
    e \equiv o \cdot \one \oplus \left( \bigoplus_{(a,i) \in \alphabet \times I} p_a^i \cdot a \seq e_a^i \right)
    $$
   Next, note that:
    \begin{align*}
        (d^{-1} \circ d) ([e]) &= d^{-1}\left\langle o , \lambda a \ldotp \left[ \bigoplus_{i \in I} p_a^i \cdot e_a^i\right] \right\rangle \tag{\Cref{c4:cor:concrete_coalgebra}}\\
        &= d^{-1}\left\langle o , \lambda a \ldotp \bigboxplus_{i \in I} p_a^i \cdot \left[ e_a^i\right] \right\rangle \tag{\Cref{c4:lem:coarser_quotient_is_a_pca}}\\
        &= \left[o \cdot \one \oplus \left(\bigoplus_{(a,i) \in \alphabet \times I} p_a^i \cdot a \seq e_a^i\right)\right] \tag{Def. of $d^{-1}$}\\
        &= d([e])
    \end{align*}
    This completes the proof.
\end{proof}
\subsection{Step 3: Systems of equations}
In order to establish that ${\PExp}/{\equiv}$ is isomorphic to the rational fixpoint (which is the property that will eventually imply completeness), we establish the conditions of \Cref{c4:thm:proper}. One of the required things we need to show is that the determinisation of an arbitrary finite-state GPTS admits a unique homomorphism to the coalgebra carried by ${\PExp}/{\equiv}$. In other words, we need to convert states of an arbitrary finite-state GPTS to language equivalent expressions in a way which is unique up to the axioms of $\equiv$. This can be thought of as an abstract reformulation of one direction of the Kleene theorem to the case of PRE. To make that possible, we give a construction inspired by Brzozowski's equation solving method~\cite{Brzozowski:1964:Expressions} of converting a DFA to the corresponding regular expression. We start by stating the necessary definitions.
\begin{definition}
	A left-affine system on finite non-empty set \(Q\) of unknowns is a quadruple
\begin{align*}
	\mathcal{S}=\left( M \colon Q \times Q \to \PExp, p \colon Q \times Q \to \interval{0}{1}, b \colon Q \to \PExp, r \colon Q \to \interval{0}{1} \right)
\end{align*}
such that for all $q,q' \in Q$, \(\sum_{q' \in Q}p_{q,q'} + r_q = 1\) and $E(M_{q,q'})=0$.
\end{definition}
\begin{definition}
	Let \({\equiv_c} \subseteq {\PExp \times \PExp}\) be a congruence relation. A map \(h \colon Q \to \PExp\) is \(\equiv_b\)-solution if for all \(q \in Q\) we have that:
\[
    h(q) \equiv_b \left(\bigoplus_{q' \in Q} p_{q,q'} \cdot M_{q,q'}\seq h(q')\right) \oplus r_{q} \cdot b_{q}
\]
\end{definition}
\begin{definition}
	A system representing the finite-state $\distf \funF$-coalgebra $(X, \beta)$ is given by $\mathcal{S}(\beta) = \langle M^\beta, p^\beta, b^\beta, r^\beta\rangle $ where for all $x, x' \in X$ we have:
\begin{gather*}
p^\beta_{x, x'} = \sum_{a ' \in \alphabet}\beta(x)(a', x') \qquad\qquad r^\beta_x = 1 - \sum_{(a',x') \in \supp (\beta(x))}\beta(x)(a',x')\\
M^\beta_{x, x'} = \begin{cases}
    \bigoplus_{a \in \alphabet} \frac{\beta(x)(a,x')}{p^{\beta}_{x,x'}} \cdot a & \text{if } p^\beta_{x,x'}\neq 0\\
    \zero & \text{otherwise}
\end{cases}\qquad\qquad
 b^\beta_x = \begin{cases}
    \frac{\beta(x)(\checkmark)}{r^\beta_x} \cdot \one & \text{if } r^\beta_x \neq 0\\
    \zero & \text{otherwise}
\end{cases} 
\end{gather*}
\end{definition}

 The original Brzozowski's equation-solving method is purely semantic, as it crucially relies on Arden's rule~\cite{Arden:1961:Delayed} by providing solutions up to the language equivalence to the systems of equations. As much as it would be enough for an analogue of the one direction of Kleene's theorem, for the purposes of our completeness argument, we need to argue something stronger. Namely, we show that we can uniquely solve each system purely through the means of syntactic manipulation using the axioms of $\equiv$. This is where the main complexity of the completeness proof is located. We show this property, by re-adapting the key result of Salomaa~\cite{Salomaa:1966:Two} to the systems of equations of our interest.
 
 The proof of the uniqueness of solutions theorem will proceeds by induction on the size of the systems of equations. We first show that systems with only one unknown can be solved via the (\textsf{Unique}) fixpoint axiom. Systems of the size $n+1$ can be reduced to systems of size $n$, by solving for one of the unknowns and substituting the obtained equation with $n$ unknowns to the remaining $n$ equations. We note that this reduction step is highly reliant on axioms (\textsf{D2}) and (\textsf{S0}). In particular, we will rely on the following property to generalise left distributivity to arbitrary $n$-ary convex sums.
 \begin{lemma}\label{c4:lem:generalised_left_distributivity}
    Let $f \in \PExp$, $I$ be a finite index set and let $\{p_i\}_{i \in I}$ and $\{e_i\}_{i \in I}$ be indexed collections of probabilities and expressions, respectively. Then:
    $$\left(\bigoplus_{i \in I} p_i \cdot e_i\right) \seq f \equiv_0 \bigoplus_{i \in I} p_i \cdot e_i \seq f$$
\end{lemma}
\begin{proof}
    By induction. If $I = \emptyset$, then: 
    \begin{align*}
        f \seq \left(\bigoplus_{i \in I} p_i \cdot e_i\right)  &\equiv f \seq 0 \\
        &\equiv \zero \tag{\textsf{S0}}\\
        &\equiv \bigoplus_{i \in I} p_i \cdot f \seq e_i \tag{$I = \emptyset$}
    \end{align*}
    If there exists $j \in I$ such that $p_j = 1$, then:
    \begin{align*}
        f \seq \left(\bigoplus_{i \in I} p_i \cdot e_i\right) &\equiv_0 f \seq e_j \\
        &\equiv     \left(\bigoplus_{i \in I} p_i \cdot f \seq e_i\right)
    \end{align*}
    Finally, for the induction step, we obtain the following:
    \begin{align*}
         f \seq \left(\bigoplus_{i \in I} p_i \cdot e_i\right) &\equiv f \seq \left( e_j \oplus_{p_j} \left(\bigoplus_{i \in I \setminus \{j\}} \frac{p_i}{{1-p_j}} \cdot e_i\right) \right)  \\
         &\equiv  f \seq e_j \oplus_{p_j} f \seq \left(\bigoplus_{i \in I \setminus \{j\}} \frac{p_i}{{1-p_j}} \cdot e_i\right)\tag{\textbf{D1}} \\
         &\equiv  f\seq e_j  \oplus_{p_j} \left(\bigoplus_{i \in I \setminus \{j\}} \frac{p_i}{{1-p_j}} \cdot f \seq e_i\right) \tag{Induction hypothesis}\\
         &\equiv \left(\bigoplus_{i \in I} p_i \cdot f \seq e_i \right)
    \end{align*}
\end{proof}

Before proceeding, we demonstrate how to solve a system of equations with two unknowns.
\begin{example}
    Consider the transition system from the left-hand side of \Cref{c4:ex:systems}. A map $h \colon\{q_0, q_1\} \to \PExp $ is an $\equiv$-solution to the system associated with that transition system, if and only if:
    \[
        h(q_0) \equiv a \seq h(q_1) \qquad h(q_1) \equiv a \seq h(q_1) \oplus_{\frac{1}{4}} \one
    \]
    Since $E(a)=0$, we can apply the (\textsf{Unique}) axiom and $e \seq \one \equiv e$ to the equation on the right to deduce that 
    $
        h(q_1) \equiv a^{\left[\frac{1}{4}\right]}
    $. Substituting it into the left equation yields $h(q_0)\equiv a \seq a^{\left[\frac{1}{4}\right]}$.
\end{example}
Finally, we proceed to the central result.
\begin{theorem}\label{c4:thm:unique_solutions}
    Every left-affine system of equations admits a unique $\equiv$-solution.
\end{theorem}
\begin{proof}
    We will write $\mathcal{M}=(M, p, b, r)$ for an arbitrary left-affine system of equations on some finite set $Q$. Since $Q$ is finite and non-empty, we can safely assume that $Q=\{q_1, \dots q_n\}$ for some positive $n \in \N$. We proceed by induction on $n$. 
        
    \fbox{Base case} If $Q=\{q_1\}$, then we set $h(q_1) = {M_{1,1}}^{[p_{1,1}]}\seq b_1$. To see that it is indeed a $\equiv$-solution, observe the following:
    \begin{align*}
        h(q_1) &= {M_{1,1}}^{[p_{1,1}]}\seq b_{1} \tag{Def. of $h$}\\
        &\equiv \left(M_{1,1} \seq {M_{1,1}}^{[p_{1,1}]} \oplus_{p_{1,1}} \one \right) \seq b_{1} \tag{\textsf{Unroll}}\\
        &\equiv M_{1,1} \seq {M_{1,1}}^{[p_{1,1}]} \seq b_{1} \oplus_{p_{1,1}} b_{1} \tag{\textsf{D1}}\\
        &\equiv M_{1,1} \seq h(q_{1}) \oplus_{p_{1,1}} b_{1} \tag{Def. of $h$}\\
        &\equiv p_{1,1} \cdot \left( M_{1,1} \seq h(q_{1})\right) \oplus {(1 - p_{1,1})} \cdot b_1 \\
        &\equiv p_{1,1} \cdot \left(M_{1,1} \seq h(q_{1})\right) \oplus {r_1} \cdot b_1 \tag{$r_1 = 1 - p_{1,1}$}\\
    \end{align*}
    Given an another $\equiv$-solution $g \colon Q \to \PExp$, we have that:
    \begin{align*}
        g(q_1) &\equiv  p_{1,1} \cdot \left({M_{1,1}} \seq g(q_1)\right) \oplus r_1 \cdot b_1 \\
        &\equiv  p_{1,1} \cdot \left({M_{1,1}} \seq g(q_1)\right) \oplus {(1-p_{1,1})} \cdot b_1  \tag{$r_1 = 1 - p_{1,1}$} \\
        &\equiv  {M_{1,1}} \seq g(q_1) \oplus_{p_{1,1}} b_1\\  
        &\equiv {M_{1,1}}^{[p_{1,1}]}\seq b_1 \tag{(\textsf{Unique}) and $E(M_{1,1})=0$}\\
        &\equiv h(q_1)
    \end{align*}
    
    \fbox{Induction step} Assume that all systems of the size \(n\) admit a unique $\equiv$-solution. We begin by demonstrating that the problem of finding a $\equiv$-solution for a system with \(n+1\) unknowns can be reduced to finding $\equiv$-solution to the system with $n$ unknowns.     
    	Let $Q=\{q_1, \dots, q_{n+1}\}$. For $h \colon Q \to \PExp$ to be a $\equiv$-solution to the system $\mathcal{M}$ of size $n+1$, it must satisfy the following equivalence:
    $$
    h(q_{n+1}) \equiv \left(\bigoplus_{i=1}^{n+1} p_{{n+1}, i} \cdot M_{{n+1}, i}\seq h(q_{i}) \right) \oplus r_{{n+1}} \cdot b_{{n+1}} 
    $$
    We can expand the $(n+1)$-ary sum in the equation above using \Cref{c4:lem:sum_unrolling} and obtain the following:
    {
    \small
    \begin{align*}
         h(q_{n+1}) &\equiv M_{n+1, n+1} \seq h(q_{n+1}) \oplus_{p_{n+1, n+1}} \\ &\quad\quad \left(\left(\bigoplus_{i=1}^{n} \frac{p_{{n+1}, i}}{{1-p_{n+1, n+1}}} \cdot M_{{n+1}, i}\seq h(q_{i}) \right) \oplus \frac{r_{{n+1}}}{{1-p_{n+1, n+1}}} \cdot b_{{n+1}} \right)
    \end{align*}
    }
    Since $E(M_{n+1, n+1}) = 0$, we can apply the (\textsf{Unique}) axiom to derive the following:
    {
    \small
    \begin{align*}
        h(q_{n+1}) &\equiv M_{n+1, n+1}^{[p_{n+1, n+1}]}\seq\left(\left(\bigoplus_{i=1}^{n} \frac{p_{{n+1}, i}}{{1-p_{n+1, n+1}}} \cdot M_{{n+1}, i}\seq h(q_{i}) \right) \oplus \frac{r_{{n+1}}}{{1-p_{n+1, n+1}}} \cdot b_{{n+1}} \right)
    \end{align*}
    }
    Observe that the above expression depends only on $h(q_1), \dots h(q_n)$. ). We now substitute the equation for $h(q_{n+1})$ into the equations for $h(q_1), \dots, h(q_n)$. Before proceeding, recall that for any $q_j$, such that $ j \leq n$, we have:
    \begin{align*}
         h(q_{j}) &\equiv p_{j, n+1}\cdot M_{j, n+1} \seq h(q_{n+1}) \oplus \left(\bigoplus_{i=1}^{n} {p_{{j}, i}} \cdot M_{{j}, i}\seq h(q_{i}) \right) \oplus {r_{{j}}} \cdot b_{{j}} 
    \end{align*}
	Substituting $h(q_{n+1})$ now yields the following:
	{
	\scriptsize
    \begin{align*}
         h(q_{j}) &\equiv \left(\bigoplus_{i=1}^{n} {p_{{j}, i}} \cdot M_{{j}, i}\seq h(q_{i}) \right) \oplus {r_{{j}}} \cdot b_{{j}}\\& \quad \oplus p_{j, n+1}\cdot M_{j, n+1} \seq M_{n+1, n+1}^{[p_{n+1, n+1}]}\seq\left(\left(\bigoplus_{i=1}^{n} \frac{p_{{n+1}, i}}{{1-p_{n+1, n+1}}} \cdot M_{{n+1}, i}\seq h(q_{i}) \right) \oplus \frac{r_{{n+1}}}{{1-p_{n+1, n+1}}} \cdot b_{{n+1}} \right)\\
    \end{align*}
    }
   	Applying \Cref{c4:lem:generalised_left_distributivity}, we can rewrite the above as:
    \begin{align*}
         h(q_{j}) &\equiv \left(\bigoplus_{i=1}^{n} {p_{{j}, i}} \cdot M_{{j}, i}\seq h(q_{i}) \right) \oplus {r_{{j}}} \cdot b_{{j}}\\& \quad \oplus \left(\bigoplus_{i=1}^{n} \frac{p_{j, n+1}p_{{n+1}, i}}{{1-p_{n+1, n+1}}} \cdot M_{j, n+1} \seq M_{n+1, n+1}^{[p_{n+1, n+1}]}\seq M_{{n+1}, i}\seq h(q_{i}) \right) \\
         &\quad \oplus \frac{p_{j, n+1}r_{{n+1}}}{{1-p_{n+1, n+1}}} \cdot \left( M_{j, n+1} \seq M_{n+1, n+1}^{[p_{n+1, n+1}]}\seq b_{{n+1}} \right)\\
    \end{align*}
    To simplify the expression above, we introduce the following shorthand notation fo $i,j \in \{1, \dots, n\}$:
    \begin{spreadlines}{20pt}
    \begin{gather*}
        s_{j,i} = p_{j,i} + \frac{p_{j, n+1} p_{n+1, i}}{{1-p_{n+1, n+1}}}\\
        N_{j,i} = \frac{p_{{j}, i}}{s_{j,i}} \cdot M_{{j}, i} \oplus \frac{p_{j, n+1}p_{{n+1}, i}}{s_{j,i}{(1-p_{n+1, n+1})}} \cdot \left(M_{j, n+1} \seq M_{n+1, n+1}^{[p_{n+1, n+1}]}\seq M_{{n+1}, i}\right)\\
        t_j = r_j + \frac{p_{j, n+1}r_{{n+1}}}{{p_{n+1, n+1}}}\\
        c_j = \frac{r_j}{t_j}\cdot b_j \oplus \frac{p_{j, n+1}r_{{n+1}}}{t_j{(1-p_{n+1, n+1})}} \cdot M_{j, n+1} \seq M_{n+1, n+1}^{[p_{n+1, n+1}]}\seq b_{{n+1}}
       \end{gather*}
    \end{spreadlines}
	Note that $E(N_{j,i})=0$ for all $i,j \in \{1, \dots, n\}$. Now, applying \Cref{c4:lem:grouping_probabilities} and \Cref{c4:lem:generalised_right_distributivity}, we obtain the following for all $j \in \{1, \dots, n\}$:
    \begin{align*}
        h(q_j) = \left(\bigoplus_{i=1}^n s_{j, i} \cdot N_{j,i} \seq h(q_i)\right) \oplus t_j \cdot c_j
    \end{align*}
In other words, the restriction of $h$ to $\{q_1, \dots, q_n\}$ must be a $\equiv$-solution to the left-affine system $\mathcal{T}=(N, s, c, t)$, which, by the induction hypothesis, has a unique solution. This solution can be extended to the entire system $\mathcal{S}$, by defining $h({q_n})$ as follows: 
    \begin{align*}
        h(q_{n+1}) &\equiv M_{n+1, n+1}^{[p_{n+1, n+1}]}\seq\left(\left(\bigoplus_{i=1}^{n} \frac{p_{{n+1}, i}}{{1-p_{n+1, n+1}}} \cdot M_{{n+1}, i}\seq h(q_{i}) \right) \oplus \frac{r_{{n+1}}}{{1-p_{n+1, n+1}}} \cdot b_{{n+1}} \right)
    \end{align*}
 By applying the (\textsf{Unroll}) axiom and reversing the axiomatic manipulations outlined above, it can be shown that this is indeed a $\equiv$-solution to $\mathcal{S}$.
 
To prove the $\equiv$-uniqueness of $h$, assume that $g \colon Q \to \PExp$, is another $\equiv$-solution to the system $\mathcal{S}$. Because of (\textsf{Unique}) axiom, we have that:
    \begin{align*}
        g(q_{n+1}) &\equiv M_{n+1, n+1}^{[p_{n+1, n+1}]}\seq\left(\left(\bigoplus_{i=1}^{n} \frac{p_{{n+1}, i}}{{1-p_{n+1, n+1}}} \cdot M_{{n+1}, i}\seq g(q_{i}) \right) \oplus \frac{r_{{n+1}}}{{1-p_{n+1, n+1}}} \cdot b_{{n+1}} \right)
    \end{align*}
     Substituting this into the equations for $h(q_1), \dots, h(q_n)$ and following the same steps as before leads to the requirement that, for all $j \in \{1, \dots, n\}$, we have:
    \begin{align*}
        g(q_j) = \left(\bigoplus_{i=1}^n s_{j, i} \cdot N_{j,i} \seq g(q_i)\right) \oplus t_j \cdot c_j
    \end{align*}
    By the induction hypothesis, the left-affine system of equations $\mathcal{T}$ admits a unique $\equiv$-solution. Therefore for all $j \in \{1, \dots, n\}$, we have that $g(q_j)\equiv h(q_j)$.
	Consequently, we have that:
    \begin{align*}
        g(q_{n+1}) &\equiv M_{n+1, n+1}^{[p_{n+1, n+1}]}\seq\left(\left(\bigoplus_{i=1}^{n} \frac{p_{{n+1}, i}}{{1-p_{n+1, n+1}}} \cdot M_{{n+1}, i}\seq g(q_{i}) \right) \oplus \frac{r_{{n+1}}}{{1-p_{n+1, n+1}}} \cdot b_{{n+1}} \right)\\
        &\equiv M_{n+1, n+1}^{[p_{n+1, n+1}]}\seq\left(\left(\bigoplus_{i=1}^{n} \frac{p_{{n+1}, i}}{{1-p_{n+1, n+1}}} \cdot M_{{n+1}, i}\seq h(q_{i}) \right) \oplus \frac{r_{{n+1}}}{{1-p_{n+1, n+1}}} \cdot b_{{n+1}} \right)\\
        &\equiv h(q_{n+1})
    \end{align*}
	This completes the proof.	
\end{proof}
\subsection{Step 3: Correspondence of solutions and homomorphisms}
We are not done yet, as in the last step we only proved properties of systems of equations and their solutions, while our main interest is in appropriate $\hat{\funG}$-coalgebras and their homomorphisms. As desired, it turns out that $\equiv$-solutions are in one-to-one correspondence with $\hat{\funG}$-coalgebra homomorphisms from determinisations of (converted) finite state $\distf \funF$-coalgebras to the coalgebra structure on ${\PExp}/{\equiv}$.
\begin{lemma}\label{c4:lem:solutions_homomorphisms}
    For a finite set $X$, we have the following one-to-one correspondence:
    $$
    \mprset{fraction={===}}
 \inferrule{
 \text{$\hat{\funG}$-coalgebra homomorphisms } m \colon ((\distf X, \mu_{X}), (\gamma_X \circ \beta)^\sharp) \to (({\PExp}/{\equiv}, \alpha_{\equiv}), d) 	
}{
 \text{$\equiv$-solutions } h\colon X \to \PExp \text{ to a system } \mathcal{S}(\beta) \text{ associated with $\distf F$-coalgebra }(X, \beta)}$$ 
\end{lemma}
Before diving into the main argument, we establish the following helper lemma, which provides a concrete characterization of $\equiv$-solutions to systems associated with $\distf \funF$-coalgebras.
\begin{lemma}\label{c4:lem:simpler_solution_lemma}
    Let $(X, \beta)$ be a finite-state $\distf \funF$-coalgebra. A map $h \colon X \to \PExp$ is a $\equiv$-solution to the system $\mathcal{S}(\beta)$ if and only if for all $x \in X$, we have that:
    $$
    	h(x) \equiv \left(\bigoplus_{(a, x') \in \alphabet \times X} \beta(x)(a,x') \cdot a \seq h(x')\right) \oplus \beta(x)(\checkmark) \cdot \one
    $$
\end{lemma}
\begin{proof}
    Fix an arbitrary $x \in X$. Recall that, if $p^\beta_{x,x'}=0$, then $M^\beta_{x,x'}=\zero\equiv \bigoplus_{a \in \alphabet} 0 \cdot a$.
    Because of that, we can safely assume that $M^\beta_{x,x'}$ can be always written out in the following form:
    $$
        M^\beta_{x,x'} \equiv \bigoplus_{a \in \alphabet} s^a_{x,x'} \cdot a
    $$
    where $s^a_{x,x'} \in \interval{0}{1}$. By definition of $\equiv$-solution, we the following:
    \begin{align*}
        h(x) &\equiv \left(\bigoplus_{x' \in X} p^{\beta}_{x, x'} \cdot M^\beta_{x,x'}\seq h(x')\right) \oplus r^{\beta}_x \cdot b^{\beta}_x \\
        &\equiv  \left(\bigoplus_{x' \in X} p^\beta_{x,x'} \cdot \left(\bigoplus_{a \in \alphabet} s^a_{x,x'} \cdot a\right)\seq h(x') \right)\oplus r^\beta_x \cdot b^\beta_x \\
        &\equiv  \left(\bigoplus_{x' \in X} p^\beta_{x,x'} \cdot \left(\bigoplus_{a \in \alphabet} s^a_{x,x'} \cdot a\seq h(x')\right) \right)\oplus r^\beta_x \cdot b^\beta_x \tag{\Cref{c4:lem:generalised_right_distributivity}}\\
        &\equiv \left(\bigoplus_{(a , x') \in \alphabet \times X} p^\beta_{x,x'}s^a_{x,x'} \cdot a \seq h(x')\right) \oplus \beta(x)(\checkmark) \cdot \one \tag{\Cref{c4:lem:flattening_convex_sums}}\\
        &\equiv \left(\bigoplus_{(a , x') \in \alphabet \times X} \beta(x)(a,x') \cdot a \seq h(x')\right) \oplus \beta(x)(\checkmark) \cdot \one
    \end{align*}
    The last step of the proof relies on the observation that for both cases of how $M^\beta_{x,x'}$ is defined, we have that
    $
        p^\beta_{x,x'} s^{a}_{x,x'} = \beta(x)(a,x')
    $.
    Similarly, in the passage between the third and fourth line, we have used the observation that:
    $
        r^\beta_x \cdot b^\beta_x \equiv \beta(x)(\checkmark) \cdot \one
    $
    for both possible cases.
\end{proof}
We are now ready to prove the main claim.
\begin{proof}[Proof of \Cref{c4:lem:solutions_homomorphisms}]

First, assume that $h \colon X \to \PExp$ is a solution to the system $\mathcal{S}(\beta)$ associated with $\distf \funF$-coalgebra $(X, \beta)$. We show that $([-]\circ h)^\sharp \colon \distf X \to {\PExp}/{\equiv}$ is a $\hat{\funG}$-coalgebra homomorphism. In other words, we will claim the commutativity of the diagram below.
    % https://q.uiver.app/?q=WzAsNixbMCwwLCJYIl0sWzEsMSwiXFxkaXN0ZiBYIl0sWzQsMSwie1xcRXhwfS97XFxlcXVpdn0iXSxbMCwyLCJcXGRpc3RmIEYgWCJdLFswLDMsIkdcXGRpc3RmIFgiXSxbNCwzLCJHIHtcXEV4cH0ve1xcZXF1aXZ9Il0sWzAsMSwiXFxldGFfWCIsMl0sWzEsMiwiW2hdXlxcc3RhciIsMl0sWzAsMiwiW2hdIl0sWzAsMywiXFxiZXRhIiwyXSxbMyw0LCJcXGdhbW1hX1giLDJdLFsxLDQsIihcXGdhbW1hX1ggXFxvIFxcYmV0YSApXlxcc3RhciJdLFs0LDUsIkdbaF1eXFxzdGFyIl0sWzIsNSwiZCJdXQ==
\[\begin{tikzcd}
	X \\
	& {\distf X} &&& {{\PExp}/{\equiv}} \\
	{\distf \funF X} \\
	{\hat{\funG}\distf X} &&&& {\hat{\funG} {\PExp}/{\equiv}}
	\arrow["{\eta_X}"', from=1-1, to=2-2]
	\arrow["{([-]\circ h)^\sharp}"', from=2-2, to=2-5]
	\arrow["{[-]\circ h}", from=1-1, to=2-5]
	\arrow["\beta"', from=1-1, to=3-1]
	\arrow["{\gamma_X}"', from=3-1, to=4-1]
	\arrow["{(\gamma_X \circ \beta )^\sharp}", from=2-2, to=4-1]
	\arrow["{\hat{\funG}([-]\circ h)^\sharp}", from=4-1, to=4-5]
	\arrow["d", from=2-5, to=4-5]
\end{tikzcd}\]

Because of \Cref{c4:lem:simpler_solution_lemma}, we have that for all $x \in X$:
$$
h(x) \equiv \left(\bigoplus_{(a,x') \in \alphabet \times X} \beta(x)(a,x') \cdot a \seq h(x')\right) \oplus \beta(x)(\checkmark) \cdot \one
$$
Let $\nu \in \distf X$. The convex extension of the map $[-] \circ h \colon X \to {\PExp}/{\equiv}$ is given by the following:
$$([-] \circ h)^\sharp(\nu) = \left[\bigoplus_{x \in \supp(\nu)} \nu(x)\cdot h(x)\right]$$
Similarly, given $\beta : X \to \distf \funF X$ we have that:
$$(\gamma_X \circ \beta)^\sharp (\nu) = \left\langle\sum_{x \in \supp(\nu)} \nu(x) \beta(x)(\checkmark),\lambda a \ldotp \lambda x'\ldotp\sum_{x \in \supp(\nu)}\nu(x)\beta(x)(a, x')\right\rangle$$
For any distribution $\nu \in \distf X$, we have the following:
\begin{align*}
&d \circ ([-] \circ h)^\sharp(\nu)\\ &= d \left[\bigoplus_{x \in \supp(\nu)}\nu(x) \cdot \left( \left(\bigoplus_{(a,x') \in \alphabet \times X} \beta(x)(a,x') \cdot a \seq h(x')\right) \oplus \beta(x)(\checkmark) \cdot \one\right) \right] \\
&= d \left[\left(\bigoplus_{(a, x') \in \alphabet \times X} \left( \sum_{x \in \supp(\nu)} \nu(x)\beta(x)(a,x').\right)\cdot a \seq h(x')\right)\right. \\&\quad\quad\quad\quad\left.\oplus \left(\sum_{x \in \supp(\nu)} \nu(x)\beta(x)(\checkmark)\right)\cdot \one\right] \tag{Barycenter axiom}\\
&= \left\langle \sum_{x \in \supp(\nu)} \nu(x)\beta(x)(\checkmark), \lambda a. \left[  
\bigoplus_{x' \in X} \left(\sum_{x \in \supp(\nu(x))}\nu(x)\beta(x)(a,x')\right)\cdot h(x')\right] \right\rangle
\end{align*}
Now, consider $\hat{\funG}([-] \circ h)^\sharp \circ (\gamma_X \circ \beta)^\sharp (\nu)$. We have the following:
\begin{align*}
    &\hat{\funG}([-] \circ h)^\sharp \circ (\gamma_X \circ \beta)^\sharp (\nu)\\
    &= \hat{\funG}([-] \circ  h)^\sharp \left\langle\sum_{x \in \supp(\nu)} \nu(x)\beta(x)(\checkmark), \lambda a\ldotp \lambda x'\ldotp \sum_{x \in \supp(\nu)} \nu(x)\beta(x)(a,x')\right\rangle\\
    &= \left\langle\sum_{x \in \supp(\nu)} \nu(x)\beta(x)(\checkmark), \lambda a\ldotp ([-] \circ h)^\sharp \left(\lambda x'. \sum_{x \in \supp(\nu)} \nu(x)\beta(x)(a,x')\right)\right\rangle\\
    &=\left\langle\sum_{x \in \supp(\nu)} \nu(x)\beta(x)(\checkmark), \lambda a.\left[\bigoplus_{x' \in X} \left( \sum_{x \in \supp(\nu)} \nu(x)\beta(x)(a,x')\right)\cdot h(x')\right]\right\rangle
\end{align*}
Hence, we obtain:
$$d \circ ([-] \circ h)^\sharp(\nu) = \hat{\funG}([-] \circ h)^\sharp \circ (\gamma_X \circ \beta)^\sharp$$
demonstrating that $([-] \circ h)^\sharp$ is indeed a $\hat{\funG}$-coalgebra homomorphism.

For the converse, let $((\distf X, \mu_X), (\gamma_X \circ \beta)^\sharp)$ be a $\hat{\funG}$-coalgebra and let $m \colon \distf X \to {\PExp}/{\equiv}$ be a $\hat{\funG}$-coalgebra homomorphism from $((\distf X, \mu_X), (\gamma_X \circ \beta)^\sharp)$ to $(({\PExp}/{\equiv}, \alpha_{\equiv}), d)$. Recall that $m$ arises uniquely as a convex extension of some map $\overline{h} \colon X \to {\PExp}/{\equiv}$. This map can be factored as $\overline{h} = [-] \circ h$, for some $h \to \PExp$. Observe that any two such factorisations determine the same $\equiv$-solution.
In particular, let $s \colon {\PExp}/{\equiv} \to \PExp$ be a section of $[-] \colon \PExp \to {\PExp}/{\equiv}$ and define $h = s \circ \overline{h}$. 

Since $m$ is the homomorphism, the inner square in the diagram above commutes. Since the triangle diagrams commute, we have that outer diagram commutes.
Recall \Cref{c4:lem:isomorphism_quotient} stating that $d \colon {\PExp}/{\equiv} \to \hat{\funG} {\PExp}/{\equiv} $ is an isomorphism. Because of that we have the following for all $x \in X$:
\begin{align*}
    ([-] \circ h)(x) &= (d^{-1} \circ \hat{\funG} ([-] \circ h)^\sharp \circ \gamma_x \circ \beta) (x) \\
    &= (d^{-1} \circ \hat{\funG}([-] \circ h)^\sharp) \left\langle\beta(x)(\checkmark), \lambda a \ldotp \lambda x' \ldotp \beta(x)(a,x') \right\rangle\\
    &= d^{-1} \left\langle\beta(x)(\checkmark), \lambda a\ldotp ([-] \circ h)^\sharp(\lambda x' \ldotp \beta(x)(a,x')) \right\rangle\\
    &= d^{-1} \left\langle\beta(x)(\checkmark), \lambda a\ldotp \left[\bigoplus_{x'\in X } \beta(x)(a,x') \cdot h(x')\right]\right\rangle\\
    &= d^{-1} \left\langle\beta(x)(\checkmark), \lambda a\ldotp \bigboxplus_{x'\in X } \beta(x)(a,x') \cdot \left[h(x')\right]\right\rangle \tag{\Cref{c4:lem:coarser_quotient_is_a_pca}}\\
    &= \left[\left(\bigoplus_{(a,x')\in \alphabet \times X} \beta(x)(a,x')\cdot a \seq h(x')\right)\beta(x)(\checkmark) \cdot \one \right] \tag{Def. of $d^{-1}$}
\end{align*}
Hence, for all $x \in X$, we have that:
$$h(x) \equiv \left(\bigoplus_{(a,x')\in \alphabet \times X} \beta(x)(a,x')\cdot a \seq h(x')\right) \oplus \beta(x)(\checkmark) \cdot \one $$
which by \Cref{c4:lem:simpler_solution_lemma} implies that $h \colon X \to \PExp$ is a $\equiv$-solution to the system $\mathcal{S}(\beta)$ associated with the $\distf \funF$-coalgebra $(X, \beta)$.
\end{proof}

 